<!DOCTYPE html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Terra API リファレンス | RaiaEngine</title>
    <meta name="description" content="WebAPI-compatible framework for building apps that run in native environments.">
    <meta name="generator" content="VitePress v1.4.1">
    <link rel="preload stylesheet" href="/assets/style.Dn2VbcVm.css" as="style">
    
    <script type="module" src="/assets/app.DQtXfAKF.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.1c8bOoKD.js">
    <link rel="modulepreload" href="/assets/chunks/framework.DPuwY6B9.js">
    <link rel="modulepreload" href="/assets/resource_terra_api.md.CcAXz862.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-ab179fa1><a class="title" href="/" data-v-ab179fa1><!--[--><!--]--><!----><span data-v-ab179fa1>RaiaEngine</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>ホーム</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/tutorial/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>チュートリアル</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/document.html" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>ドキュメント</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>リファレンス</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/reference/built_in/" data-v-35975db6><!--[--><span data-v-35975db6>LuaJITライブラリ</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/reference/lua_c/" data-v-35975db6><!--[--><span data-v-35975db6>Lua/Cライブラリ</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>リソース</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/glfw/" data-v-35975db6><!--[--><span data-v-35975db6>GLFW</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/imgui/" data-v-35975db6><!--[--><span data-v-35975db6>ImGui</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/lua/" data-v-35975db6><!--[--><span data-v-35975db6>Lua</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/luajit/" data-v-35975db6><!--[--><span data-v-35975db6>LuaJIT</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/skia/" data-v-35975db6><!--[--><span data-v-35975db6>Skia</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/resource/terra/" data-v-35975db6><!--[--><span data-v-35975db6>Terra</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/download/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>ダウンロード</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/dolphilia/raia" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/dolphilia/raia" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-eee4e7cb><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-17a5e62e><button data-v-17a5e62e>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 collapsible has-active" data-v-c40bc020 data-v-b7550ba0><div class="item" role="button" tabindex="0" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><h2 class="text" data-v-b7550ba0>Terra</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-b7550ba0><span class="vpi-chevron-right caret-icon" data-v-b7550ba0></span></div></div><div class="items" data-v-b7550ba0><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>トップ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/getting-started.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>はじめに</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/api.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>APIリファレンス</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/terraforcpp.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>Terra for C++</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/publications.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>出版物</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b7550ba0 data-v-b7550ba0><div class="item" data-v-b7550ba0><div class="indicator" data-v-b7550ba0></div><a class="VPLink link link" href="/resource/terra/community.html" data-v-b7550ba0><!--[--><p class="text" data-v-b7550ba0>コミュニティ</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _resource_terra_api" data-v-39a288b8><div><h1 id="terra-api-リファレンス" tabindex="-1">Terra API リファレンス <a class="header-anchor" href="#terra-api-リファレンス" aria-label="Permalink to &quot;Terra API リファレンス&quot;">​</a></h1><nav class="table-of-contents"><ul><li><a href="#リスト">リスト</a></li><li><a href="#terra-リフレクションapi">Terra リフレクションAPI</a><ul><li><a href="#ジェネリック">ジェネリック</a></li><li><a href="#関数">関数</a></li><li><a href="#型-types">型 (Types)</a></li><li><a href="#quotes">Quotes</a></li><li><a href="#symbol">Symbol</a></li><li><a href="#values">Values</a></li><li><a href="#グローバル変数">グローバル変数</a></li><li><a href="#定数">定数</a></li><li><a href="#ラベル">ラベル</a></li><li><a href="#マクロ">マクロ</a></li><li><a href="#ビルトインマクロ">ビルトインマクロ</a></li><li><a href="#exotypes-構造体">Exotypes（構造体）</a></li><li><a href="#lua-api">Lua API</a></li><li><a href="#オーバーロード関数">オーバーロード関数</a></li><li><a href="#エスケープ-escapes">エスケープ（Escapes）</a></li></ul></li><li><a href="#terraでcを使用する">TerraでCを使用する</a></li><li><a href="#luaの値とterraの値の変換">Luaの値とTerraの値の変換</a></li><li><a href="#terraコードの読み込み">Terraコードの読み込み</a></li><li><a href="#コンパイルapi">コンパイルAPI</a><ul><li><a href="#terraコードの保存">Terraコードの保存</a></li><li><a href="#ターゲット">ターゲット</a></li></ul></li><li><a href="#デバッグ">デバッグ</a></li><li><a href="#cコード内にterraを埋め込む">Cコード内にTerraを埋め込む</a></li><li><a href="#luaに埋め込む新しい言語の作成">Luaに埋め込む新しい言語の作成</a><ul><li><a href="#簡単な例">簡単な例</a></li><li><a href="#言語の読み込みと実行">言語の読み込みと実行</a></li><li><a href="#luaシンボルとの相互作用">Luaシンボルとの相互作用</a></li><li><a href="#luaの再帰的な解析">Luaの再帰的な解析</a></li><li><a href="#ステートメントの拡張">ステートメントの拡張</a></li><li><a href="#prattパーサによる高レベルの解析">Prattパーサによる高レベルの解析</a></li><li><a href="#言語とlexer-api">言語とLexer API</a></li></ul></li><li><a href="#中間表現と抽象構文記述言語-asdl">中間表現と抽象構文記述言語 (ASDL)</a><ul><li><a href="#asdlクラスの作成">ASDLクラスの作成</a></li><li><a href="#asdlクラスの使用">ASDLクラスの使用</a></li><li><a href="#asdlクラスにメソッドを追加">ASDLクラスにメソッドを追加</a></li><li><a href="#名前空間">名前空間</a></li><li><a href="#ユニーク">ユニーク</a></li></ul></li></ul></nav><h2 id="リスト" tabindex="-1">リスト <a class="header-anchor" href="#リスト" aria-label="Permalink to &quot;リスト&quot;">​</a></h2><p><code>terralib</code>内のAPIで配列を返すものは、常にListオブジェクトを返します。これは、Luaコード内で使用するためのより完全なリストデータ型です。</p><p>List型は通常のLuaテーブルで、以下の追加メソッドを持っています：</p><ol><li>Luaの<code>table</code>グローバルの全メソッド</li><li><a href="http://sml-family.org/Basis/list.html" target="_blank" rel="noreferrer">SMLのリスト型</a>に基づいた高階関数のリスト</li></ol><p>これにより、Terraオブジェクトをメタプログラムで操作しやすくなります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;terralist&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 空のリスト</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 要素3つのリスト</span></span></code></pre></div><p>テーブルで初期化された新しいリストを作成します。</p><p>Listには次の関数もあります：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Luaのstring.subに相当、リストの部分取得</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sub</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i,j)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- リストを反転</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rev</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() : List[A]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- すべての要素に関数fnを適用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B) : {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- すべての要素にmapを適用し、新しいリストを返す</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B) : List[B]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 関数fn(e)が真である要素のみの新しいリスト</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean) : List[A]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- すべての要素にmapを適用し、結果のリストを連結</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">flatmap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List[B]) : List[B]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 条件を満たす最初の要素を見つける</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">find</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean) : A?</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- k,v = fn(e)を各要素に適用し、同じkの値vをグループ化</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">partition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {K,V}) : Map[ K,List[V] ]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 再帰的に初期値initとリストの各要素にfnを適用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fold</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : B,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : {B,A} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- リストの各要素にfnを再帰的に適用</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">reduce</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : {B,A} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- リストのいずれかの要素が条件を満たすか</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean) : boolean</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- リストのすべての要素が条件を満たすか</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> boolean) : boolean</span></span></code></pre></div><p>高階関数を取るすべての関数には、関数にリストのインデックスも提供する<code>i</code>バリアントもあります：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">list</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mapi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : {int,A} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> B) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List[B]</span></span></code></pre></div><p>リスト関数の<code>map</code>のようなものは、関数を引数として取る高階関数です。 高階List関数の引数となる関数には以下のいずれかを指定できます：</p><ol><li>Luaの通常の関数</li><li>演算子の文字列（例：<code>&quot;+&quot;</code>。<code>src/terralist.lua</code>のopテーブルを参照）</li><li>オブジェクト上で呼び出すフィールドまたはメソッドを指定する文字列</li></ol><p>例：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mylist </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> List</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { a,b,c }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mylist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 各要素に対してフィールドを選択：a.foo, b.foo, c.foo, など</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                  -- a.fooが関数の場合、メソッドa:foo()として扱われる</span></span></code></pre></div><p>高階関数への追加引数は、これらの関数に渡されます。これは、Luaのインライン関数の記述が冗長であるため、インライン関数を避けるためのものです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;terralist&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isclassof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(exp)</span></span></code></pre></div><p><code>exp</code>がリストであればtrueを返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">israwlist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(l)</span></span></code></pre></div><p><code>l</code>が連続する整数キー<code>1</code>から<code>N</code>まで（他のキーなし）のテーブルであればtrueを返します。</p><h2 id="terra-リフレクションapi" tabindex="-1">Terra リフレクションAPI <a class="header-anchor" href="#terra-リフレクションapi" aria-label="Permalink to &quot;Terra リフレクションAPI&quot;">​</a></h2><p>すべてのTerraエンティティは、ファーストクラスのLuaオブジェクトでもあります。これにはTerraの<a href="#Functions">関数</a>、<a href="#Types">型</a>、<a href="#global_variables">グローバル変数</a>が含まれます。<a href="#quotes">クォート</a>は、Terraのクォーテーション構文（バッククォートや<code>quote</code>）によって返されるオブジェクトで、Terra関数内にはまだ含まれていないコードの断片を表します。<a href="#symbols">シンボル</a>は変数に固有の名前を与えるもので、新しいパラメータやローカル変数を定義する際に使用されます。</p><p>Terra関数がLuaオブジェクトに変換できない値を返す場合、Terraの<a href="#values">値</a>になります。これはLuaからアクセス可能なラッパーです（内部的にはLuaJITの<code>&quot;cdata&quot;</code>オブジェクトです）。</p><p>各オブジェクトには、操作用のLua APIが提供されています。例えば、関数の逆アセンブルを行う<code>terrafn:disas()</code>や、型の特性を問い合わせる<code>typ:isarithmetic()</code>といったメソッドがあります。</p><h3 id="ジェネリック" tabindex="-1">ジェネリック <a class="header-anchor" href="#ジェネリック" aria-label="Permalink to &quot;ジェネリック&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tostring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terraobj)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terraobj)</span></span></code></pre></div><p>すべてのTerraオブジェクトにはデバッグ用の文字列表現が備わっています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">istype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isquote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">issymbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ismacro</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isglobalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islabel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isoverloadedfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span></code></pre></div><p>特定のオブジェクトがTerraのクラス型であるかをチェックします。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(o)</span></span></code></pre></div><p><code>type(o)</code>の拡張版で、次のように定義されています：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> terralib</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terrafunction&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">istype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terratype&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ismacro</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terramacro&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isglobalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terraglobalvariable&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isquote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terraquote&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">istree</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terratree&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;list&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">issymbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terrasymbol&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terrafunction&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islabel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;terralabel&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isoverloadedfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;overloadedterrafunction&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">memoized_fn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">memoize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a,b,c,...) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>関数の結果をメモ化します。ある引数セットで関数が初めて呼び出されると、その引数での戻り値が計算されキャッシュされます。同じ引数での以後の呼び出し（Luaの等価性による）では、そのキャッシュされた値が返されます。テンプレート化された値（例：同じ<code>T</code>に対して毎回同じ<code>Vector(T)</code>型を返すべき場合）を生成する際に便利です。</p><h3 id="関数" tabindex="-1">関数 <a class="header-anchor" href="#関数" aria-label="Permalink to &quot;関数&quot;">​</a></h3><p>Terra関数は、Terraコードのエントリーポイントです。関数は定義済みまたは未定義である可能性があります (<code>myfunction:isdefined()</code>)。未定義の関数は型が既知ですが、実装がまだ提供されていません。関数が初めて実行されるまで、<code>myfunction:resetdefinition(another_function)</code>を使用して定義を変更できます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] terra </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">myfunctionname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :: type_expression</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] terra </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">myfunctionname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> :: {int,bool} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {int}</span></span></code></pre></div><p><em>Terra関数の宣言</em>。新しい未定義の関数を作成し、Lua変数<code>myfunctionname</code>に保存します。 オプションの<code>local</code>キーワードを使用する場合、<code>myfunctionname</code>は最初に新しいローカルLua変数として定義されます。<code>local</code>キーワードを使用しない場合、<code>myfunctionname</code>はテーブル指定子（例：<code>a.b.c</code>）として使うこともできます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">myfunctionname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arg0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type0,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                             ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                             argN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : typeN)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><em>Terra関数の定義</em>。指定されたコード本体を使用して<code>myfunctionname</code>を定義します。<code>myfunctionname</code>が未定義の場合は既存の関数宣言に定義を追加し、それ以外の場合は新しい関数宣言を作成して定義を追加します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> func </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">externfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(function_name,function_type)</span></span></code></pre></div><p>外部で定義された関数にバインドされたTerra関数を作成します。例：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> atoi </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">externfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;atoi&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,{rawstring} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {int})</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">myfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(arg0,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,argN)</span></span></code></pre></div><p><code>myfunction</code>はTerra関数です。Luaから<code>myfunction</code>を呼び出します。未定義の関数に対して呼び出しを行うとエラーになります。引数は<a href="#converting-lua-values-to-terra-values-of-known-type">Lua値からTerraへの変換規則</a>を使用してTerraに変換され、戻り値は<a href="#converting-terra-values-to-lua-values">Terra値からLuaへの変換規則</a>に基づいて変換されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isdefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>関数に定義が存在する場合は<code>true</code>を返します。関数を定義するには、<code>func:adddefinition</code>、<code>func:resetdefinition</code>、または関数定義構文<code>terra func(...) ... end</code>を使用します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isextern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この関数が<code>printf</code>のような外部シンボルにバインドされている場合は<code>true</code>を返します。外部関数は<code>terralib.includec</code>でC関数をインポートするか、<code>terralib.externfunction</code>を呼び出して作成されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">adddefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(another_function)</span></span></code></pre></div><p><code>func</code>の定義を<code>another_function</code>の現在の定義に設定します。<code>another_function</code>は定義されている必要があり、<code>func</code>は未定義でなければなりません。<code>func</code>と<code>another_function</code>の型は一致している必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">resetdefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(another_function)</span></span></code></pre></div><p><code>func</code>の定義を<code>another_function</code>の現在の定義に設定（またはリセット）します。<code>another_function</code>は定義されている必要があります。<code>func</code>は定義済みまたは未定義のどちらでもかまいません。すでにコンパイルされている関数に対してこのメソッドを呼び出すとエラーになります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">printstats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この関数のコンパイルおよびJITにかかった時間などの統計を出力します。このメソッドを呼び出すと、関数がコンパイルされます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">disas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>すべての関数定義をx86アセンブリや最適化されたLLVM形式に逆アセンブルして出力します。パフォーマンスデバッグに役立ちます。このメソッドを呼び出すと関数がコンパイルされます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">printpretty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([quote_per_line</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span></code></pre></div><p>この関数のコードを視覚的に表現して出力します。デフォルトでは、元のコードの各部分を別の行として表示します。<code>quote_per_line</code>を<code>false</code>に設定すると、読みやすいようにコードがまとめて表示されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r0, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, rn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> myfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(arg0, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argN)</span></span></code></pre></div><p>Luaから<code>myfunction</code>を呼び出します。引数は、Terra値とLua値を相互に変換するための<a href="#converting-between-lua-values-and-terra-values">規則</a>に従って変換され、戻り値も同様にLua値に変換されます。このメソッドの呼び出しにより、関数が機械コードにコンパイルされます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">compile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>関数を機械コードにコンパイルします。この関数が必要とするすべての関数やグローバル変数も定義されていることを確認します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">function_type </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gettype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>関数の<a href="#types">型</a>を返します。<code>function_type.parameters</code>はパラメータの型リスト、<code>function_type.returntype</code>は戻り値の型です。複数の値を返す関数の場合、戻り値の型はタプルになります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getpointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この関数の機械コードを指すLuaJITの<code>ctype</code>オブジェクトを返します。呼び出すと関数がコンパイルされます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(str)</span></span></code></pre></div><p>関数の見やすい名前を取得または設定します。生成されたコードを表示する際に役立ちますが、関数の動作には影響しません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setinlined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bool)</span></span></code></pre></div><p><code>true</code>の場合、この関数は常にインライン化されます。<code>false</code>の場合、インライン化されません。デフォルトではLLVMの関数インライナーの裁量によりインライン化されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setoptimized</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bool)</span></span></code></pre></div><p>すべてのTerra関数はデフォルトで最適化されます（Clangの<code>-O3</code>に相当）。最適化を無効にするには<code>false</code>を渡します（Clangの<code>-O0</code>に相当）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setcallingconv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(string)</span></span></code></pre></div><p>関数の呼び出し規約を設定します。デフォルトではLLVMのデフォルトの呼び出し規約が使用されます。有効な値は、<a href="https://llvm.org/docs/LangRef.html#calling-conventions" target="_blank" rel="noreferrer">LLVMのテキストベースのアセンブリ言語</a>で指定できるものと同じです（執筆時点では公式のLLVMドキュメントは不完全で、特にターゲット固有の呼び出し規約については<a href="https://github.com/llvm/llvm-project/blob/llvmorg-13.0.0/llvm/lib/IR/AsmWriter.cpp#L289-L339" target="_blank" rel="noreferrer">ソースコード</a>を直接参照する必要がある場合があります）。</p><h3 id="型-types" tabindex="-1">型 (Types) <a class="header-anchor" href="#型-types" aria-label="Permalink to &quot;型 (Types)&quot;">​</a></h3><p>型オブジェクトはTerraオブジェクトの型を表す一級のLua値です。Terraの組み込み型システムは、Cのような低レベル言語の型システムに似ています。型コンストラクタ（例：<code>&amp;int</code>）は有効なLua式であり、Terraの型オブジェクトを返します。リンクリストのような再帰型をサポートするために、<a href="#exotypes-structs">構造体</a>はメンバーやメソッドが完全に指定される前に宣言できます。構造体が宣言されただけで定義されていない場合、それは「不完全」とみなされ、値としては使用できません。ただし、ポインタ算術が不要な限り、不完全型へのポインタは使用可能です。型が完全に指定される必要がある場合（例：コンパイルされた関数で使用される、またはその型のグローバル変数を割り当てる場合）に、「完全」となります。この時点で型の完全な定義が必要です。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>int int8 int16 int32 int64</span></span>
<span class="line"><span>uint uint8 uint16 uint32 uint64</span></span>
<span class="line"><span>bool</span></span>
<span class="line"><span>float double</span></span></code></pre></div><p>基本型（プリミティブ型）。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&amp;typ</span></span></code></pre></div><p><code>typ</code>へのポインタを構築します。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>typ[N]</span></span></code></pre></div><p><code>typ</code>型のインスタンスを<code>N</code>個持つ配列を構築します。<code>N</code>は正の整数である必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">vector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(typ,N)</span></span></code></pre></div><p><code>typ</code>型のインスタンスを<code>N</code>個持つベクトルを構築します。<code>N</code>は整数で、<code>typ</code>はプリミティブ型である必要があります。これらの型は<a href="http://en.wikipedia.org/wiki/Streaming_SIMD_Extensions" target="_blank" rel="noreferrer">SSE</a>のようなベクトル命令セットの抽象化です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">parameters </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> returntype</span></span></code></pre></div><p>関数ポインタを構築します。<code>parameters</code>および<code>returns</code>は、型のリスト（例：<code>{int,int}</code>）または単一の型（例：<code>int</code>）で指定できます。複数の値を返す場合、戻り値の型としてタプルが使用されます。</p><p>戻り値の型が<code>void</code>の場合は、空のタプル<code>{}</code>を使用します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">field0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type0, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fieldN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : typeN }</span></span></code></pre></div><p>ユーザー定義型またはエキソタイプを構築します。各<code>struct</code>の呼び出しは独自の型を生成します（<a href="http://en.wikipedia.org/wiki/Nominative_type_system" target="_blank" rel="noreferrer">指名型システム</a>を使用）。詳細は<a href="#exotypes-structs">エキソタイプ</a>を参照してください。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">tuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type0, type1, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, typeN)</span></span></code></pre></div><p>タプルを構築します。これは<code>struct</code>の特別な型で、<code>type0</code>...<code>typeN</code>の値を<code>obj._0</code>...<code>obj._N</code>のフィールドとして保持します。通常の構造体と異なり、同じ引数を使った<code>tuple</code>の各呼び出しは同じ型を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">istype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span></code></pre></div><p><code>t</code>が型であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isprimitive</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>がプリミティブ型（上記参照）であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isintegral</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が整数型であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isfloat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が<code>float</code>または<code>double</code>であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isarithmetic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が整数型または浮動小数点型であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islogical</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が<code>bool</code>であれば<code>true</code>を返します（将来的に、ベクトル命令内のフラグに近いサイズのブール型をサポートする予定）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">canbeord</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が<code>or</code>および<code>and</code>演算に使用できる場合（つまり整数型や論理型だが浮動小数点型ではない場合）、<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ispointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>がポインタであれば<code>true</code>を返します。<code>type.type</code>は指している型です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isarray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が配列であれば<code>true</code>を返します。<code>type.N</code>は長さを、<code>type.type</code>は要素の型を表します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が関数（関数ポインタではない）であれば<code>true</code>を返します。<code>type.parameters</code>はパラメータ型のリスト、<code>type.returntype</code>は戻り値の型です。複数の値を返す関数の場合、戻り値の型はその値の<code>tuple</code>になります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isstruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が<a href="#exotypes-structs">構造体</a>であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ispointertostruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が構造体へのポインタであれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ispointertofunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が関数へのポインタであれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isaggregate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が配列または構造体であれば<code>true</code>を返します（任意の型を保持できる型です）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">iscomplete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が完全に定義され、コードで使用できる状態であれば<code>true</code>を返します。非集約型では常に<code>true</code>です。集約型の場合、その内部に含まれるすべての型が定義されていれば<code>true</code>となります。<code>type:complete()</code>を呼び出すと強制的に型が完全になります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isvector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>がベクトルであれば<code>true</code>を返します。<code>type.N</code>は長さ、<code>type.type</code>は要素の型です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isunit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が空のタプルであれば<code>true</code>を返します。空のタプルは、戻り値を持たない関数の戻り値型としても使用されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:(isprimitive|isintegral|isarithmetic|islogical|canbeord)</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">orvector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p><code>type</code>が指定されたプロパティを持つプリミティブ型である場合、またはそのプリミティブ型を要素とするベクトル型である場合に<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">complete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>型を強制的に完全にします。構造体の場合、構造体のレイアウトを計算し（定義されていれば<code>__getentries</code>や<code>__staticinitialize</code>を呼び出します）、この型が参照するすべての型を再帰的に完全にします。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">printpretty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>型を出力し、構造体の場合はそのメンバーも含めて表示します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terratype)</span></span></code></pre></div><p><code>ffi.sizeof</code>のラッパーです。<code>terratype</code>を完全にして、そのサイズ（バイト単位）を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terratype,field)</span></span></code></pre></div><p><code>ffi.offsetof</code>のラッパーです。<code>terratype</code>を完全にして、<code>terratype</code>内の<code>field</code>のオフセット（バイト単位）を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">pointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(typ, [addrspace])</span></span></code></pre></div><p><strong>実験的機能</strong>。<code>&amp;typ</code>の代替で、<a href="https://llvm.org/docs/LangRef.html#pointer-type" target="_blank" rel="noreferrer">LLVMアドレス空間</a>を指定することが可能です。非ゼロアドレス空間の意味はターゲット固有です。</p><h3 id="quotes" tabindex="-1">Quotes <a class="header-anchor" href="#quotes" aria-label="Permalink to &quot;Quotes&quot;">​</a></h3><p>Quotes（引用句）は、Terraの引用演算子（バッククォートおよび<code>quote ... in ... end</code>）によって返されるLuaオブジェクトです。これは関数にまだ挿入されていないTerraコードの断片（文や式）を表します。エスケープ演算子（<code>[...]</code>および<code>escape ... emit ... end</code>）を使うと、引用句を周囲のTerraコードに挿入できます。Quotesには、1つの式のみを生成する短い形式と、文や式を生成する長い形式があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quotation </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> `terraexpr</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- `記号で引用句を作成</span></span></code></pre></div><p>引用句の短い形式です。バッククォート演算子により、1つのTerra式を含む引用句が作成されます。<code>terraexpr</code>には任意のTerra式を指定できます。<code>terraexpr</code>内にエスケープが含まれる場合、それは式が構築される際に評価されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quote</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    terrastmts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>引用句の長い形式です。<code>quote</code>演算子により、複数のTerra文を含む引用句が作成されます。この引用句は、Terraコード内で式または文が有効な場所に挿入できます。式のコンテキストで使用される場合、その型は空のタプルになります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quote</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    terrastmts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    terraexp1,terraexp2,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,terraexpN</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>長い<code>quote</code>構文には、いくつかの式を生成する<code>in</code>文をオプションで含めることができます。この<code>quote</code>がTerraコード内で式として挿入される場合、これらの式から構築されたタプルが値として返されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quote</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [a] </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- &#39;a&#39;はint型</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isquote</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span></code></pre></div><p><code>t</code>が引用句であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quoteobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gettype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この引用句のTerra型を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quoteobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">astype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この引用句をTerra型オブジェクトとして解釈しようとします。通常、型を引数として受け取る<a href="#macros">マクロ</a>で使用されます（例：<code>sizeof([&amp;int])</code>）。この関数は、<code>quote</code>オブジェクトを型に変換します（例：<code>&amp;int</code>）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bool </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quoteobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islvalue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この引用句が代入の左辺（l-value）として使用可能であれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">luaval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> quoteobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">asvalue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この引用句を単純なLua値として解釈しようとします。通常、定数を引数として受け取る<a href="#macros">マクロ</a>で使用されます。特定の値のみで動作し、Constant式として利用可能な場合に限られます。生成コードに複雑なデータ構造を渡す場合、マクロよりもエスケープを使用することを検討してください。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">quoteobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">printpretty</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この引用句内のコードの視覚表現を出力します。引用句は関数に挿入されるまで型チェックが行われないため、関数の型なしの表現が出力されます。</p><h3 id="symbol" tabindex="-1">Symbol <a class="header-anchor" href="#symbol" aria-label="Permalink to &quot;Symbol&quot;">​</a></h3><p>Symbol（シンボル）は、Terraの識別子の抽象的な表現です。変数の使用、定義、関数の引数、フィールド名、メソッド名、ラベルなど、識別子が期待される場所で使用できます（<a href="#escapes">エスケープ</a>も参照）。LISPの<code>gensym</code>関数で返されるシンボルに似ています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">issymbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s)</span></span></code></pre></div><p><code>s</code>がシンボルであれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">symbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(typ,[displayname])</span></span></code></pre></div><p>新しいシンボルを構築します。このシンボルは他のシンボルと一意になります。<code>typ</code>はシンボルの型で、<code>displayname</code>はエラーメッセージで表示される際のオプションの名前です。</p><h3 id="values" tabindex="-1">Values <a class="header-anchor" href="#values" aria-label="Permalink to &quot;Values&quot;">​</a></h3><p>LuaJITの<a href="http://luajit.org/ext_ffi.html" target="_blank" rel="noreferrer">FFI API</a>のラッパーを提供しており、Luaから直接Terraオブジェクトを割り当てたり操作したりできます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj)</span></span></code></pre></div><p><code>obj</code>のTerra型を返します。<code>obj</code>は、以前にTerra APIを使用して割り当てられたLuaJIT <code>ctype</code>である必要があります。または、Terra関数の戻り値として返されるものです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terratype,[init])</span></span></code></pre></div><p>LuaJITの<code>ffi.new</code>のラッパーです。型<code>terratype</code>の新しいオブジェクトを割り当てます。<code>init</code>はオプションの初期化子であり、Terra値とLua値の間での<a href="#converting-between-lua-values-and-terra-values">変換ルール</a>に従います。このオブジェクトはLuaから到達不可能になるとガベージコレクションされます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(terratype,obj)</span></span></code></pre></div><p><code>ffi.cast</code>のラッパーです。<code>obj</code>を<code>terratype</code>に変換し、Terra値とLua値の間での<a href="#converting-between-lua-values-and-terra-values">変換ルール</a>に従います。</p><h3 id="グローバル変数" tabindex="-1">グローバル変数 <a class="header-anchor" href="#グローバル変数" aria-label="Permalink to &quot;グローバル変数&quot;">​</a></h3><p>グローバル変数は、すべてのTerra関数で共有されるTerra値です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">global</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,[init,name,isextern,isconstant,addrspace])</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">global</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(init,[name,isextern,isconstant,addrspace])</span></span></code></pre></div><p>型<code>type</code>と初期値<code>init</code>で新しいグローバル変数を作成します。<code>type</code>または<code>init</code>のどちらか一方は必須です。<code>type</code>が指定されない場合は、<code>init</code>から型を推定します。<code>init</code>が指定されない場合、グローバル変数は未初期化のままです。<code>init</code>は通常の変換<a href="#converting-between-lua-values-and-terra-values">ルール</a>に従ってTerra値に変換されます。<code>init</code>が指定された場合、型は<a href="#types">完了</a>されます。</p><p><code>init</code>には<a href="#quote">Quote</a>も指定でき、これは<a href="#constants">定数式</a>として扱われ、グローバル変数の初期化に使用されます。<code>name</code>はデバッグ用の名前です。</p><p><code>isextern</code>が<code>true</code>の場合、このグローバル変数は外部で定義された変数<code>name</code>にバインドされます。</p><p><code>isconstant</code>が<code>true</code>の場合、グローバル変数の内容は定数として扱われます。</p><p><code>addrspace</code>が<code>nil</code>でない場合、グローバルは対応する<a href="https://llvm.org/docs/LangRef.html#pointer-type" target="_blank" rel="noreferrer">LLVMアドレス空間</a>に配置されます。非ゼロのアドレス空間の意味はターゲットによって異なるため注意が必要です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getpointer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>メモリ内でこのグローバル変数へのポインタである<code>ctype</code>オブジェクトを返します。型を<a href="#types">完了</a>します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>このグローバル変数の値をLuaJITの<code>ctype</code>オブジェクトとして取得します。型を<a href="#types">完了</a>します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(v)</span></span></code></pre></div><p><code>v</code>を通常の変換<a href="#converting-between-lua-values-and-terra-values">ルール</a>に従ってTerra値に変換し、グローバル変数に設定します。型を<a href="#types">完了</a>します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(str)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">str </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getname</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>このグローバル変数のデバッグ名を設定または取得します。これはデバッグに役立ちますが、グローバル変数の動作には影響しません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">gettype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>グローバル変数のTerra型を取得します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">globalvar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">setinitializer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(init)</span></span></code></pre></div><p>このグローバル変数の初期化式を設定または変更します。グローバル変数がコンパイルされる前にのみ有効です。例えば、クラスのvtableを格納するグローバル変数の場合、クラスにメソッドを追加するたびに値を追加することができます。</p><h3 id="定数" tabindex="-1">定数 <a class="header-anchor" href="#定数" aria-label="Permalink to &quot;定数&quot;">​</a></h3><p>Terra定数は、Terraコードで使用される定数値を表します。例えば、<code>sin</code>関数の<a href="http://en.wikipedia.org/wiki/Lookup_table" target="_blank" rel="noreferrer">ルックアップテーブル</a>を作成する場合、まずLuaで値を計算し、これらの値を格納する定数のTerra配列を作成することができます。コンパイラはこの配列が定数であることを認識して、より積極的な最適化を行うことができます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">constant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],init)</span></span></code></pre></div><p>新しい定数を作成します。<code>init</code>は通常の変換<a href="#converting-between-lua-values-and-terra-values">ルール</a>に従ってTerra値に変換されます。オプションの<a href="#types">type</a>が指定されると、<code>init</code>はその型に明示的に変換されます。型を<a href="#types">完了</a>します。</p><p><code>init</code>にはTerraの<a href="#quotes">quote</a>オブジェクトも指定可能です。この場合、quoteは_定数初期化式_として扱われます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> complexobject </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> constant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`Complex { 3, 4 })</span></span></code></pre></div><p>定数式は、Terra式のサブセットであり、その値がコンパイル後に確定されるもので、LLVMの定数式の概念におおむね対応します。例えば、関数ポインタの値のように、事前に確定できないものも含まれます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- a, b, cを含む関数ポインタの配列</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> functionarray </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">`array(a,b,c))</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isconstant</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj)</span></span></code></pre></div><p><code>obj</code>がTerra定数であれば<code>true</code>を返します。</p><h3 id="ラベル" tabindex="-1">ラベル <a class="header-anchor" href="#ラベル" aria-label="Permalink to &quot;ラベル&quot;">​</a></h3><p>ラベルは、<code>goto</code>文などで使用できる抽象的なコード位置です。シンボルのように、ラベルの値を使ってプログラムでコード位置を生成できます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">islabel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(l)</span></span></code></pre></div><p><code>l</code>がラベルであれば<code>true</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">label</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([displayname])</span></span></code></pre></div><p>新しいラベルを構築します。このラベルは他のラベルと一意で、<code>displayname</code>が同じでも異なるラベルとみなされます。<code>displayname</code>はエラーメッセージに表示されるオプションの名前です。</p><h3 id="マクロ" tabindex="-1">マクロ <a class="header-anchor" href="#マクロ" aria-label="Permalink to &quot;マクロ&quot;">​</a></h3><p>マクロを使用すると、型チェック中にコンパイラにカスタムの動作を挿入できます。コンパイル時に実行されるため、コンパイラに戻る際は<a href="#asynchronous-compilation">非同期コンパイル</a>を考慮する必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">macro</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(arg0,arg1,...,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">argN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>新しいマクロを作成します。この関数はTerraコード内の各呼び出し時にコンパイル時に呼び出されます。各引数は、マクロに対して引数として渡されるTerraの<a href="#quote">quote</a>です。例えば、<code>mymacro(a,b,foo())</code>の呼び出しは、マクロへの引数として3つのquoteを生成します。マクロは単一の値を返し、その値はコンパイル時の変換<a href="#converting-between-lua-values-and-terra-values">ルール</a>を使用してTerraオブジェクトに変換されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ismacro</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(t)</span></span></code></pre></div><p><code>t</code>がマクロであれば<code>true</code>を返します。</p><h3 id="ビルトインマクロ" tabindex="-1">ビルトインマクロ <a class="header-anchor" href="#ビルトインマクロ" aria-label="Permalink to &quot;ビルトインマクロ&quot;">​</a></h3><p>Terraには以下のビルトインマクロが用意されています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">intrinsic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>指定した<code>name</code>と<code>type</code>に対応するLLVMの組み込み関数を呼び出すTerra関数を返します。たとえば、LLVMは<code>sqrt</code>に以下のような組み込み関数を提供しています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sqrt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">intrinsic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;llvm.sqrt.f32&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, float </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> float)</span></span></code></pre></div><p>これで<code>sqrt</code>を呼び出せるようになり、ターゲットプラットフォーム向けに効率的なコードが生成されます。</p><p>なお、使用できる組み込み関数のセットはLLVMのバージョンやターゲットプラットフォームによって異なり、Terra側で制御することはできません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">attrload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr, attrs)</span></span></code></pre></div><p><code>addr</code>のアドレスから<code>attrs</code>属性付きでデータを読み込みます。<code>attrs</code>は以下のキーを含むリテラルテーブルで指定します。</p><ul><li><code>nontemporal</code>（任意）: <code>true</code>の場合、読み込みが非一時的になります。</li><li><code>align</code>（任意）: <code>addr</code>のアライメントを指定します。</li><li><code>isvolatile</code>（任意）: <code>true</code>の場合、<code>addr</code>の内容が揮発性であると見なされます。</li></ul><p>以下の例では、<code>attrload</code>が<code>123</code>を返します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">var i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 123</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">attrload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(&amp;i, { align </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">attrstore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr, value, attrs)</span></span></code></pre></div><p><code>addr</code>のアドレスに<code>value</code>の値を<code>attrs</code>属性付きで書き込みます。属性の指定方法は<code>attrload</code>と同じです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">fence</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(attrs)</span></span></code></pre></div><p><strong>実験的機能</strong>。フェンス操作を発行します。指定した属性によって、フェンスを境にした原子命令の順序変更を防ぎます。この操作の意味は<a href="https://llvm.org/docs/LangRef.html#fence-instruction" target="_blank" rel="noreferrer">LLVM</a>によって決まります。</p><p>以下の属性が指定可能です（使用できる属性のセットは各原子操作によって異なります）。</p><ul><li><code>syncscope</code>（任意）: <a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM syncscope</a>を指定します。多くの値はターゲット固有です。</li><li><code>ordering</code>（必須）: <a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM memory ordering</a>を指定します。</li></ul><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cmpxchg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(addr, cmp, new, attrs)</span></span></code></pre></div><p><strong>実験的機能</strong>。アドレス<code>addr</code>での原子比較交換（cmpxchg）操作を実行します。<code>addr</code>の値が<code>cmp</code>と同じ場合、<code>new</code>の値が書き込まれます。違う場合、値は変更されません。<code>addr</code>の元の値と交換が成功したかどうかを示すブール値のタプルを返します。</p><p>使用できる属性は次の通りです（原子操作によって使用できる属性が異なります）。</p><ul><li><code>syncscope</code>（任意）: <a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM syncscope</a>。</li><li><code>success_ordering</code>（必須）: 交換が成功した場合に適用する<a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM memory ordering</a>。</li><li><code>failure_ordering</code>（必須）: 交換が失敗した場合に適用するLLVMメモリ順序。</li><li><code>align</code>（任意）: <code>addr</code>のアライメント。<code>attrload</code>と異なり、<code>align</code>の値は<code>addr</code>の内容のサイズ以上でなければなりません（<a href="https://llvm.org/docs/LangRef.html#cmpxchg-instruction" target="_blank" rel="noreferrer">詳細はこちら</a>）。</li><li><code>isvolatile</code>（任意）: <code>true</code>の場合、<code>addr</code>の内容が揮発性であると見なされます。</li><li><code>isweak</code>（任意）: <code>true</code>の場合、偽の失敗を許可します。交換条件が一致しても書き込まれないことがあります。</li></ul><p>以下の例では、最初の<code>cmpxchg</code>は失敗し、<code>{1, false}</code>を返しますが、2番目は成功し<code>{1, true}</code>を返します。最終的な<code>i</code>の値は<code>4</code>になります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">var i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cmpxchg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(&amp;i, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {success_ordering </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;acq_rel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, failure_ordering </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;monotonic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cmpxchg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(&amp;i, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {success_ordering </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;acq_rel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, failure_ordering </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;monotonic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">atomicrmw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(op, addr, value, atomicattrs)</span></span></code></pre></div><p><strong>実験的機能</strong>。<code>addr</code>のアドレスで<code>value</code>値と演算子<code>op</code>を使用した原子読み書き操作（RMW）を実行します。操作は原子的に行われます。<code>addr</code>の元の値を返します。</p><p>使用可能な操作は<a href="https://llvm.org/docs/LangRef.html#atomicrmw-instruction" target="_blank" rel="noreferrer">LLVMのドキュメント</a>に指定されています。<code>fadd</code>および<code>fsub</code>操作は浮動小数点型を必要とし、ほとんどの操作は整数型またはポインタ型を必要とします。使用できる操作のセットはLLVMのバージョンやターゲットプラットフォームに依存することがあります。</p><p>指定可能な属性は次の通りです（原子操作によって使用できる属性が異なります）。</p><ul><li><code>syncscope</code>（任意）: <a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM syncscope</a>。</li><li><code>ordering</code>（必須）: <a href="https://llvm.org/docs/LangRef.html#atomic-memory-ordering-constraints" target="_blank" rel="noreferrer">LLVM memory ordering</a>。</li><li><code>align</code>（任意）: <code>addr</code>のアライメント。<code>attrload</code>とは異なり、<code>align</code>の値は<code>addr</code>の内容のサイズ以上でなければなりません（<a href="https://llvm.org/docs/LangRef.html#atomicrmw-instruction" target="_blank" rel="noreferrer">詳細はこちら</a>）。</li><li><code>isvolatile</code>（任意）: <code>true</code>の場合、<code>addr</code>の内容が揮発性と見なされます。</li></ul><p>以下の例では、<code>atomicrmw</code>が<code>i</code>に<code>21</code>を書き込み、元の値<code>1</code>を返します（シングルスレッドの場合）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">var i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">atomicrmw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;add&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, &amp;i, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">20</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {ordering </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;acq_rel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span></span></code></pre></div><h3 id="exotypes-構造体" tabindex="-1">Exotypes（構造体） <a class="header-anchor" href="#exotypes-構造体" aria-label="Permalink to &quot;Exotypes（構造体）&quot;">​</a></h3><p>Terraでは、ユーザー定義の集約型を「exotype」と呼びます。これは、Lua APIを使ってTerraの外部で定義されるためです。この設計は、ユーザー定義型の振る舞いを定義するための基本的なメカニズムを提供することを目的としており、言語固有のポリシーを強制することはありません。このため、JavaやC++のようなポリシーベースのクラスシステムを、これらのメカニズムを基にライブラリとして作成することができます。簡潔さと親しみやすさのために、これらの型を言語内で「struct」というキーワードで表現します。</p><p>また、一般的なケースに対しては、exotypeの定義用のシンタックスシュガーも提供しています。このセクションでは、まずLua API自体について説明し、その後、シンタックスシュガーがどのようにAPIに変換されるかを示します。</p><p>この設計の背景については、<a href="./publications.html">公開資料</a>で詳しく説明しています。</p><h3 id="lua-api" tabindex="-1">Lua API <a class="header-anchor" href="#lua-api" aria-label="Permalink to &quot;Lua API&quot;">​</a></h3><p>新しいユーザー定義型は次の呼び出しで作成します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mystruct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">newstruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([displayname])</span></span></code></pre></div><p><code>displayname</code>はエラーメッセージに表示される任意の名前ですが、<code>newstruct</code>を呼び出すたびに名前に関係なくユニークな型が作成されます（Terraでは<a href="http://en.wikipedia.org/wiki/Nominative_type_system" target="_blank" rel="noreferrer">指名型システム</a>が使用されています）。この型はTerraプログラム内で次のように利用できます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : mystruct </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- mystruct型のインスタンス</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>この型がTerraプログラムで使用される際のメモリレイアウトと動作は、型の<code>metamethods</code>テーブルに<em>プロパティ関数</em>を設定することで定義されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mystruct.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">metamethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">myproperty</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ...</span></span></code></pre></div><p>Terraの型チェッカーが型に関する情報を知る必要があるとき、型の<code>metamethods</code>テーブルにあるプロパティ関数を呼び出します。プロパティが設定されていない場合、デフォルトの動作が適用されます。各プロパティの詳細については個別に説明されます。</p><p><code>metamethods</code>で設定できるフィールドは以下の通りです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entries </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __getentries</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>構造体内のフィールドを計算によって決定する_Lua_関数です。構造体内のエントリリストが最初に必要になると、コンパイラは<code>__getentries</code>関数を1度だけ呼び出します。この呼び出し時点では型がまだ完全でないため、このメソッドで型の完全性が必要な操作を行うとエラーになります。<code>entries</code>はフィールドエントリの<a href="#list">List</a>です。各フィールドエントリは以下のいずれかです：</p><ul><li><code>{ field = stringorsymbol, type = terratype }</code> 形式のテーブルで、名前付きフィールドを指定します。</li><li><code>{stringorsymbol, terratype}</code> 形式のテーブルで、名前付きフィールドを指定します。</li><li>一連の<a href="#list">List</a>フィールドエントリで、同じメモリを共有するunionとして割り当てられます。</li></ul><p>デフォルトでは、<code>__getentries</code>は<code>self.entries</code>テーブルを返します。これは<code>struct</code>定義シンタックスで設定されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">method </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __getmethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, methodname)</span></span></code></pre></div><p>構造体のメソッドを検索する_Lua_関数です。コンパイラが<code>mystruct:mymethod(...)</code>のメソッド呼び出しや<code>mystruct.mymethod</code>の静的メソッド参照を検出したときに呼び出されます。<code>mymethod</code>は文字列または<a href="#symbol">symbol</a>で指定可能です。このメタメソッドは、この型での<code>methodname</code>の静的な呼び出しごとにコンパイラによって呼び出されます。同じ<code>methodname</code>に対して複数回呼ばれる可能性があるため、高コストの操作は呼び出しごとにメモ化して使い回すべきです。</p><p><code>method</code>には、Terra関数、Lua関数、またはコンパイル時に実行される<a href="#macro">マクロ</a>を指定できます。</p><p>たとえば、<code>__getmethod</code>が<code>method</code>を返す場合、Terraコード内の式<code>myobj:mymethod(arg0, ...argN)</code>は、<code>myobj</code>の型が<code>T</code>の場合に<code>[method](myobj, arg0, ..., argN)</code>に変換されます。</p><p>もし<code>myobj</code>の型が<code>&amp;T</code>の場合は、<code>[method](@myobj, arg0, ..., argN)</code>に展開されます。メソッドが呼び出された際に<code>myobj</code>の型が<code>T</code>であり、形式パラメータの型が<code>&amp;T</code>である場合、引数はアドレスを取得してポインタに自動的に変換されます。この「メソッド受信キャスト」により、メソッド呼び出しでオブジェクトを変更可能にします。</p><p>デフォルトでは、<code>__getmethod(self, methodname)</code>は<code>self.methods[methodname]</code>を返し、これはメソッド定義のシンタックスシュガーで設定されます。メソッドテーブルにメソッドが含まれていない場合、型チェッカーは以下で説明する<code>__methodmissing</code>を呼び出します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__staticinitialize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>型が完全になった後、コンパイラがユーザー定義コードに戻る前に呼ばれる_Lua_関数です。型が完全であるため、<code>terralib.offsetof</code>を使ってオフセットを調べたり、仮想関数テーブル（vtables）を作成したりといった、完全な型を必要とする操作を行うことができます。構造体内のエントリに対する静的初期化子は、構造体自体の静的初期化子よりも先に実行されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">castedexp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> __cast</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(from, to, exp)</span></span></code></pre></div><p>型間の変換を定義する_Lua_関数です。<code>from</code>は<code>exp</code>の型で、<code>to</code>は必要な型です。<code>mystruct</code>型について、<code>__cast</code>は<code>from</code>または<code>to</code>のどちらかが<code>mystruct</code>または<code>&amp;mystruct</code>型の場合に呼び出されます。有効な変換がある場合、このメソッドは<code>castedexp</code>（<code>exp</code>を<code>to</code>に変換する式）を返すべきです。変換できない場合は、<code>error</code>関数を使って説明的なエラーメッセージを出力する必要があります。Terraコンパイラは、適用可能な<code>__cast</code>メタメソッドを見つけるまで試行します（つまり、<code>error</code>を呼び出さないものを探します）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(iterable, body)</span></span></code></pre></div><p><strong>実験的機能。</strong> 指定した型を反復処理するためのループを生成する_Lua_関数です。<code>iterable</code>の値は指定された型の値を生成する式になります。<code>body</code>はループ変数を受け取り、1回のループ処理を実行するLua関数です。<strong><code>iterable</code>と<code>body</code>の引数は複数回の評価から保護される必要があります。</strong> <code>__for</code>メタメソッドの結果は引用句（quote）でなければなりません。</p><p>例として、単純な<code>Range</code>型の実装は以下のようになります：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">struct </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Range.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">metamethods</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__for</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(iter, body)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> quote</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        var it </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> iter</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> it.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, it.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">b</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__methodmissing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mymethod, myobj, arg1, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, argN)</span></span></code></pre></div><p>メソッドが<code>myobj:mymethod(arg0, ..., argN)</code>として呼び出され、<code>__getmethod</code>が設定されていない場合、メソッドテーブルに<code>mymethod</code>が存在しなければマクロ<code>__methodmissing</code>が呼び出されます。このマクロはメソッド呼び出しの代わりに使用されるTerraの<a href="#quote">quote</a>を返すべきです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__entrymissing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(entryname, myobj)</span></span></code></pre></div><p><code>myobj</code>が<code>entryname</code>フィールドを含まない場合、型チェッカーが<code>myobj.entryname</code>式を検出すると<code>__entrymissing</code>が呼び出されます。これはマクロでなければならず、フィールドの代わりに使用されるTerraの<a href="#quote">quote</a>を返す必要があります。</p><p>カスタム演算子：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">__sub, __add, __mul, __div, __mod, __lt, __le, __gt, __ge,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">__eq, __ne, __and, __or, __not, __xor, __lshift, __rshift,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">__select, __apply</span></span></code></pre></div><p>これらはTerraメソッドまたはマクロとして指定できます。指定した型でこれらの演算子が使用されたときに呼び出されます。<code>__apply</code>は関数適用に、<code>__select</code>は<code>terralib.select</code>に使用されます。二項演算子の場合、少なくとも引数の1つが<code>mystruct</code>型である必要があります。カスタム演算子のインターフェースは十分なテストが行われておらず、変更される可能性があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">__typename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>型の名前を生成する_Lua_関数です。この名前はエラーメッセージや<code>tostring</code>で使用されます。</p><h4 id="構文シュガー" tabindex="-1">構文シュガー <a class="header-anchor" href="#構文シュガー" aria-label="Permalink to &quot;構文シュガー&quot;">​</a></h4><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] struct mystruct</span></span></code></pre></div><p><em>構造体の宣言</em> <code>mystruct</code>がまだTerraの構造体でない場合、<code>terralib.types.newstruct(&quot;mystruct&quot;)</code>を呼び出し、新しい構造体を作成してLua変数<code>mystruct</code>に格納します。<code>mystruct</code>が既に構造体の場合は、変更は行いません。オプションの<code>local</code>キーワードが使用される場合、<code>mystruct</code>はまず新しいローカルのLua変数として定義されます。<code>local</code>キーワードなしで使用する場合、<code>mystruct</code>はテーブルの指定子（例: <code>a.b.c</code>）にすることができます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">] struct </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mystruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    field0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type0;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    union</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        fieldUnion0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type1;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        fieldUnion1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type2;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    fieldN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : typeN;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><em>構造体の定義</em> <code>mystruct</code>がまだ構造体でない場合、構造体の宣言の動作に従い新しい構造体を作成します。次に、定義の本体で指定されたフィールドと型を使用して構造体の<code>entries</code>テーブルを埋めます。<code>union</code>ブロックを使用して、一連のフィールドがメモリ内の同じ位置を共有することを指定できます。<code>mystruct</code>が以前に定義されている場合、再定義はエラーになります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mystruct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mymethod</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arg0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : type0,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">argN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : typeN)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><em>メソッド定義</em> <code>mystruct.methods.mymethod</code>がTerra関数でない場合、それを作成します。その後、メソッド定義を追加します。<code>&amp;mystruct</code>型の<code>self</code>という仮引数が、仮引数リストの先頭に追加されます。</p><h3 id="オーバーロード関数" tabindex="-1">オーバーロード関数 <a class="header-anchor" href="#オーバーロード関数" aria-label="Permalink to &quot;オーバーロード関数&quot;">​</a></h3><p>オーバーロード関数は通常の関数とは別のオブジェクトであり、API呼び出しを使用して作成します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> addone </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">overloadedfunction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;addone&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">              { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                terra</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : double) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> })</span></span></code></pre></div><p>また、後でメソッドを追加することもできます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">adddefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : float) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>通常の関数とは異なり、オーバーロード関数はLuaから直接呼び出すことはできません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">overloaded_func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getdefinitions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>この関数の定義の<a href="#lists">リスト</a>を返します。</p><h3 id="エスケープ-escapes" tabindex="-1">エスケープ（Escapes） <a class="header-anchor" href="#エスケープ-escapes" aria-label="Permalink to &quot;エスケープ（Escapes）&quot;">​</a></h3><p>エスケープは<a href="http://www.cs.rice.edu/~taha/MSP/" target="_blank" rel="noreferrer">マルチステージプログラミング</a>から取り入れられた特殊な構文で、Luaを使用してTerraの式を生成できるようにします。エスケープは角括弧（ブラケット）構文を使って作成され、1つのLua式（例: <code>[ 4 + 5 ]</code>）を含みます。このLua式は、周囲のTerraコードが_定義_されるときに評価されます（注: これは、関数が_コンパイル_されるときに実行される<a href="#macros">マクロ</a>とは異なります）。エスケープはTerraコードのレキシカルスコープ内で評価され、周囲のLuaスコープの識別子に加え、Terraコード内で定義された識別子も含まれます。これらの識別子はLuaコード内で<a href="#symbol">シンボル</a>として表現されます。以下のエスケープ例では、</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">dosomething</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a,b)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>dosomething</code>に渡される引数<code>a</code>と<code>b</code>は、Terraコード内で定義された変数への参照としての<a href="#symbols">シンボル</a>になります。</p><p>また、識別子やテーブル選択のエスケープに対して構文シュガーも提供されています。例えば、Terraの式<code>ident</code>はエスケープ<code>[ident]</code>として扱われ、テーブルの選択<code>a.b.c</code>は、<code>a</code>と<code>b</code>がLuaテーブルである場合にエスケープ<code>[a.b.c]</code>として扱われます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [luaexpr],</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>[luaexpr]</code>は単一式のエスケープです。<code>luaexpr</code>は関数が_定義_されるときにLuaの値に評価される単一のLua式です。評価されたLua式は、コンパイル時の変換<a href="#converting-between-lua-values-and-terra-values">ルール</a>を使用してTerraオブジェクトに変換されます。変換がTerra値のリストを生成した場合、リストは1つの値に切り詰められます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,[luaexpr])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>[luaexpr]</code>は複数式のエスケープであり、式リストの最後の式として発生します。単一式エスケープと同様の動作をしますが、<code>luaexpr</code>の変換が複数のTerra式を生成した場合、これらの値は式リストの末尾に追加されます（この場合、<code>bar</code>の呼び出しの引数リストに追加されます）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [luaexpr]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>[luaexpr]</code>は文のエスケープです。この形式は複数式エスケープと同様の動作をしますが、Terra文の<a href="#quote">クオート</a>を返すことも可能です。<code>luaexpr</code>の変換がTerra値のリストを生成した場合、すべてが現在のブロックに挿入されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([luaexpr] : int)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    var [luaexpr] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mystruct.[luaexpr]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>各<code>[luaexpr]</code>は識別子のエスケープの例です。<code>luaexpr</code>は<a href="#symbol">シンボル</a>を生成する必要があります。フィールド選択子（<code>a.[luaexpr]</code>）、メソッド（<code>a:[luaexpr]()</code>）またはラベル（<code>goto [luaexpr]</code>）に対して、<code>luaexpr</code>は文字列も生成できます。この形式は、プログラム的に識別子を定義することを可能にします。シンボルが明示的に定義された型を持つ場合、変数の型が明示的に指定されていない限り、変数はシンボルの型を取ります。たとえば、シンボルを構築する場合（<code>foo = symbol(int)</code>）、<code>var [foo]</code>は<code>int</code>型となり、<code>var [foo] : float</code>は<code>float</code>型になります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int, [luaexpr])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>[luaexpr]</code>は識別子リストのエスケープです。この場合、単一識別子のエスケープと同様に動作しますが、明示的に型指定されたシンボルのリストも返すことができ、パラメータリストに追加されます。</p><h2 id="terraでcを使用する" tabindex="-1">TerraでCを使用する <a class="header-anchor" href="#terraでcを使用する" aria-label="Permalink to &quot;TerraでCを使用する&quot;">​</a></h2><p>Terraは<a href="http://clang.llvm.org" target="_blank" rel="noreferrer">Clang</a>フロントエンドを利用して、TerraコードをCとの後方互換性を持つようにしています。この機能は現在、Cヘッダーファイルから関数、型、およびenumをインポートすることが可能です。また、次のように数値のみのマクロ定義もインポートできます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> FOO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><p>ただし、現時点ではグローバル変数や定数のインポートはサポートされていません。これについては将来の改善を予定しています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">table </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">includecstring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(code,[args,target])</span></span></code></pre></div><p>文字列<code>code</code>をCコードとしてインポートします。含まれるC関数の名前をTerraの<a href="#function">関数</a>オブジェクトに、Cの型（typedefなど）をTerraの<a href="#types">型</a>に対応するLuaテーブルを返します。Lua変数<code>terralib.includepath</code>を使って、追加のヘッダー検索パスを指定できます。これはセミコロンで区切られたディレクトリのリストです。<code>args</code>はオプションで、Clangに渡すフラグのリスト（例：<code>includecstring(code, &quot;-I&quot;, &quot;..&quot;)</code>）です。<code>target</code>は指定されたターゲット用にヘッダーを正しくインポートするための<a href="#targets">ターゲット</a>オブジェクトです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">table </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">includec</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename,[args,target])</span></span></code></pre></div><p><code>includecstring</code>と似ていますが、Cコードが<code>filename</code>から読み込まれます。これはClangのデフォルトのヘッダーファイル検索パスを使用します。<code>...</code>を使用して、Clangに追加の引数を渡すことができます（さらに検索するディレクトリを含めることも可能です）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">linklibrary</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename)</span></span></code></pre></div><p>ファイル<code>filename</code>にある動的ライブラリを読み込みます。<code>includec</code>でインポートしたヘッダーファイルに含まれる宣言の定義がTerraが実行されている実行ファイルにリンクされていない場合、<code>linklibrary</code>で定義を動的に読み込む必要があります。この状況は、外部ライブラリを<code>terra</code>のREPL/ドライバーアプリケーションで使用するときに発生します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> llvmobj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">linkllvm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sym </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> llvmobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">extern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(functionname,functiontype)</span></span></code></pre></div><p>LLVMビットコードファイル<code>filename</code>を<code>.bc</code>拡張子でリンクし、<code>clang</code>または<code>clang++</code>で生成します：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">clang++</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -O3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -emit-llvm</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mycode.cpp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mybitcode.bc</span></span></code></pre></div><p>このコードは機械語ではなくビットコードとして読み込まれるため、より強力な最適化（例：関数呼び出しのインライン化）が可能ですが、機械語にコンパイルするためTerraでの初期化に時間がかかります。このビットコードファイルから関数を抽出するには、関数名とTerra相当の型（例：<code>int -&gt; int</code>）を指定して<code>llvmobj:extern</code>メソッドを呼び出します。</p><h2 id="luaの値とterraの値の変換" tabindex="-1">Luaの値とTerraの値の変換 <a class="header-anchor" href="#luaの値とterraの値の変換" aria-label="Permalink to &quot;Luaの値とTerraの値の変換&quot;">​</a></h2><p>Terraコードをコンパイルまたは実行する際、TerraとLua間で値を変換する必要があります。内部的には、この変換はLuaJITの<a href="http://luajit.org/ext_ffi.html" target="_blank" rel="noreferrer">外国関数インターフェース（FFI）</a>を基にして実装され、Luaから直接C関数の呼び出しやC値の使用が可能です。Terraの型システムはCに似ているため、このインフラストラクチャをほとんど再利用できます。</p><h4 id="既知の型のlua値をterra値に変換する" tabindex="-1">既知の型のLua値をTerra値に変換する <a class="header-anchor" href="#既知の型のlua値をterra値に変換する" aria-label="Permalink to &quot;既知の型のLua値をTerra値に変換する&quot;">​</a></h4><p>Lua値をTerraに変換する際、期待される型がわかっている場合（例：<code>terralib.cast</code>や<code>terralib.constant</code>で型が指定されているとき）は、LuaJITの<a href="http://luajit.org/ext_ffi_semantics.html#convert-fromlua" target="_blank" rel="noreferrer">変換セマンティクス</a>に従い、各Terra型に相当するC型に変換されます。</p><h4 id="型が不明なlua値をterra値に変換する" tabindex="-1">型が不明なLua値をTerra値に変換する <a class="header-anchor" href="#型が不明なlua値をterra値に変換する" aria-label="Permalink to &quot;型が不明なLua値をTerra値に変換する&quot;">​</a></h4><p>Lua値が<a href="#escapes">エスケープ</a>を介してTerraコードから直接使用されたり、型指定なしでTerra値が作成される（例：<code>terralib.constant(3)</code>）場合、オブジェクトの型を推定しようとします。成功した場合、通常の変換が適用されます。<code>type(value)</code>が次の場合に適用される型は次の通りです：</p><ul><li><code>cdata</code> -- Terra APIから以前に割り当てられた、またはTerraコードから返されたものであれば、オブジェクトの<code>ctype</code>に相当するTerra型に変換されます。</li><li><code>number</code> -- <code>floor(value) == value</code>かつ値が<code>int</code>に収まる場合は<code>int</code>、そうでなければ<code>double</code>型とみなされます。</li><li><code>boolean</code> -- <code>bool</code>型になります。</li><li><code>string</code> -- <code>rawstring</code>（すなわち<code>&amp;int8</code>）に変換されます。将来的には特別な文字列型を追加する可能性があります。</li><li>その他 -- 型を推定できません。オブジェクトの型がわかっている場合は、<code>terralib.cast</code>関数を使用して指定することができます。</li></ul><h4 id="コンパイル時の変換" tabindex="-1">コンパイル時の変換 <a class="header-anchor" href="#コンパイル時の変換" aria-label="Permalink to &quot;コンパイル時の変換&quot;">​</a></h4><p>Luaの値がTerra関数内の<a href="#escapes">エスケープ</a>演算子の結果として使用される場合、以下の追加変換が許可されます：</p><ul><li><a href="#global-variable">グローバル変数</a> — 値がTerraコード内でグローバル変数へのlvalue参照となります。</li><li><a href="#symbol">シンボル</a> — シンボルを使って定義された変数へのlvalue参照になります。変数がスコープ内にない場合、コンパイル時エラーが発生します。</li><li><a href="#quote">引用</a> — 引用内で定義されたコードがTerraコードにスプライスされます。引用がステートメントのみを含む場合、ステートメントの位置にのみスプライス可能です。</li><li><a href="#constant">定数</a> — 定数がTerraコードにスプライスされます。</li><li>Lua関数 — 関数呼び出しで使用される場合、Lua関数は<code>terralib.cast</code>で戻り値のないTerra関数型に変換され、実際のパラメータのTerra型が使用されます。関数呼び出し以外ではエラーとなります。</li><li><a href="#macro">マクロ</a> — 関数呼び出しとして使用される場合、コンパイル時に実行され、結果はコンパイル時変換ルールでTerraに変換され、指定された位置にスプライスされます。</li><li><a href="#types">型</a> — マクロ呼び出しの引数として使用される場合、そのまま渡され、<code>arg:astype()</code>呼び出しが値を返します。関数呼び出しとして使用された場合（例：<code>[&amp;int](v)</code>）、その型への明示的なキャストとして動作します。</li><li><a href="#list">リスト</a> または<code>terralib.israwlist</code>で分類された生リスト — リストの各メンバーはコンパイル時変換を用いて再帰的にLua値に変換されます（リストの変換は除く）。ステートメントや複数の式がある場合、リストのすべての値がスプライスされます。単一の式のみが許可される場合、リストは1つの値に切り詰められます。</li><li><code>cdata</code> 集合体（構造体や配列） — Lua <code>cdata</code>集合体のTerra型<code>T</code>がTerraコード内で直接参照される場合、その値はLuaで割り当てられたメモリにある集合体へのlvalue参照となります。</li><li>その他 — 値はまず標準的なLuaからTerraへの変換ルールでTerra値に変換され、結果の値が_定数_としてスプライスされます。</li></ul><h4 id="terra値からlua値への変換" tabindex="-1">Terra値からLua値への変換 <a class="header-anchor" href="#terra値からlua値への変換" aria-label="Permalink to &quot;Terra値からLua値への変換&quot;">​</a></h4><p>Terra値をLua値に変換する場合（例えば関数呼び出しの結果から）、LuaJITの<a href="http://luajit.org/ext_ffi_semantics.html#convert-tolua" target="_blank" rel="noreferrer">C型からLuaオブジェクトへの変換セマンティクス</a>に従います。各Terra型に相当するC型に置き換えられ、<code>cdata</code>オブジェクトの場合はTerraの<a href="#values">値API</a>で利用可能です。</p><h2 id="terraコードの読み込み" tabindex="-1">Terraコードの読み込み <a class="header-anchor" href="#terraコードの読み込み" aria-label="Permalink to &quot;Terraコードの読み込み&quot;">​</a></h2><p>これらの関数を使って、実行時に混在するTerra-Luaコードのチャンクを読み込むことができます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(readerfn)</span></span></code></pre></div><p>C APIの<code>terra_load</code>と同等のLua関数です。<code>readerfn</code>はLuaの<code>load</code>関数と同じ動作をします。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">loadstring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s)</span></span></code></pre></div><p>C APIの<code>terra_loadstring</code>と同等のLua関数です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">loadfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename)</span></span></code></pre></div><p>C APIの<code>terra_loadfile</code>と同等のLua関数です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">require</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(modulename)</span></span></code></pre></div><p>Terraコードモジュール<code>modulename</code>を読み込みます。Luaの<code>package.loaders</code>にTerraコードをモジュールとしてロードするための追加コードローダーが登録されています。<code>require</code>はまず、以前に<code>require</code>を使ってロードされた<code>modulename</code>があるかを確認し、存在する場合はそれを返します。存在しない場合は、<code>package.terrapath</code>でモジュールを検索します。<code>package.terrapath</code>はセミコロンで区切られたテンプレートリストです。例：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;lib/?.t;./?.t&quot;</span></span></code></pre></div><p><code>modulename</code>は、<code>.</code>をディレクトリセパレータ<code>/</code>に置き換えてパスに変換されます。そして、ファイルが見つかるまで各テンプレートが試されます。例えば、このパスを使用すると、<code>require(&quot;foo.bar&quot;)</code>は<code>lib/foo/bar.t</code>または<code>foo/bar.t</code>をロードしようとします。ファイルが見つかると、そのファイルに対する<code>terralib.loadfile</code>呼び出しの結果が返されます。デフォルトでは、<code>package.terrapath</code>は環境変数<code>TERRA_PATH</code>に設定されます。<code>TERRA_PATH</code>が設定されていない場合、<code>package.terrapath</code>にはデフォルトのパス（<code>./?.t</code>）が含まれます。<code>TERRA_PATH</code>内の<code>;;</code>は存在する場合、デフォルトパスに置き換えられます。</p><p>通常のLuaコードも<code>require</code>を使ってインポートされることに注意してください。<code>package.path</code>（環境変数<code>LUA_PATH</code>）は純粋なLuaコードのロードに使用され、<code>package.terrapath</code>（環境変数<code>TERRA_PATH</code>）はLua-Terraコードのロードに使用されます。</p><h2 id="コンパイルapi" tabindex="-1">コンパイルAPI <a class="header-anchor" href="#コンパイルapi" aria-label="Permalink to &quot;コンパイルAPI&quot;">​</a></h2><h3 id="terraコードの保存" tabindex="-1">Terraコードの保存 <a class="header-anchor" href="#terraコードの保存" aria-label="Permalink to &quot;Terraコードの保存&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">saveobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(filename [, filetype], functiontable[, arguments, target, optimize])</span></span></code></pre></div><p>Terraコードを外部ファイル形式（オブジェクトファイルや実行ファイルなど）に保存します。<code>filetype</code>には、<code>&quot;object&quot;</code>（オブジェクトファイル <code>*.o</code>）、<code>&quot;asm&quot;</code>（アセンブリファイル <code>*.s</code>）、<code>&quot;bitcode&quot;</code>（LLVMビットコード <code>*.bc</code>）、<code>&quot;llvmir&quot;</code>（LLVMテキストIR <code>*.ll</code>）、または<code>&quot;executable&quot;</code>（拡張子なし）のいずれかを指定できます。<code>filetype</code>が省略された場合、拡張子から自動的に推測されます。</p><p><code>functiontable</code>は文字列からTerra関数へのテーブルで、これらの関数が指定された名前で出力されるコードに含まれます。<code>arguments</code>はリンク時に渡される追加のフラグリストで、<code>filetype</code>が<code>&quot;executable&quot;</code>の場合に使用されます。<code>filename</code>が<code>nil</code>の場合、ファイルはメモリ内に書き込まれ、Lua文字列として返されます。</p><p>別のアーキテクチャ用にオブジェクトをクロスコンパイルする場合は、ターゲットアーキテクチャを説明する<a href="#targets">target</a>オブジェクトを指定できます。指定がない場合、<code>saveobj</code>はネイティブアーキテクチャを使用します。</p><p>デフォルトでは、<code>saveobj</code>はClangの<code>-O3</code>相当の最適化でコードをコンパイルします。<code>optimize</code>の設定で最適化を無効にしたり、安全でない高速数学の最適化を追加で有効にしたりできます。<code>optimize</code>の値は次の通りです：</p><ul><li><code>true</code> または <code>false</code>：最適化を有効/無効にする（<code>-O3</code>相当）。デフォルトは有効です。高速数学最適化は含まれません。</li><li><code>{optimize = ..., fastmath = ...}</code>：最適化プロファイルを指定するテーブル。<code>optimize</code>キーは前述の<code>true</code>または<code>false</code>（指定しない場合はデフォルトで<code>true</code>）。<code>fastmath</code>の可能な値は以下で説明します。</li></ul><p><code>fastmath</code>キーには以下のいずれかの値を指定できます：</p><ul><li><code>true</code> または <code>false</code>：すべての<a href="https://llvm.org/docs/LangRef.html#fast-math-flags" target="_blank" rel="noreferrer">LLVM高速数学フラグ</a>を有効/無効にします（デフォルトは<code>false</code>）。</li><li><code>&quot;flag&quot;</code>：単一の高速数学フラグを指定し、それだけを有効化。他のフラグは無効。</li><li><code>{&quot;flag1&quot;, &quot;flag2&quot;}</code>：複数のフラグをリストとして指定し、リスト内のフラグをすべて有効化。他のフラグは無効。</li></ul><p>LLVMの高速数学フラグの一覧は<a href="https://llvm.org/docs/LangRef.html#fast-math-flags" target="_blank" rel="noreferrer">こちら</a>から確認できます。利用可能なフラグはLLVMのバージョンに依存し、Terraの管理外です。</p><p>例：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">saveobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a.o&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {main</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">main}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 最適化を無効化。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">saveobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a.o&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {main</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">main}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {fastmath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 全ての高速数学最適化を有効化。</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">saveobj</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;a.o&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {main</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">main}, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {fastmath</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;contract&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nnan&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}}) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- contractとnnanを有効化。</span></span></code></pre></div><h3 id="ターゲット" tabindex="-1">ターゲット <a class="header-anchor" href="#ターゲット" aria-label="Permalink to &quot;ターゲット&quot;">​</a></h3><p><code>terralib.saveobj</code>や<code>terralib.includec</code>は、コードを異なるアーキテクチャ用にコンパイルするためのターゲットオブジェクトをオプションで受け取ります。これによりクロスコンパイルが可能になります。例えば、x86マシンを使ってRaspberry Pi用にARMコードをコンパイルするには、次のようにターゲットオブジェクトを作成します：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> armtarget </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">newtarget</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Triple </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;armv6-unknown-linux-gnueabi&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- LLVMターゲットトリプル</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    CPU </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;arm1176jzf-s&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- LLVM CPU名</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Features </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- LLVMの特徴文字列</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    FloatABIHard </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ARM用に浮動小数点レジスタを使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>テーブル内の<code>Triple</code>フィールド以外のエントリはオプションです。設定する文字列に関する詳細情報は、<a href="http://clang.llvm.org/docs/CrossCompilation.html" target="_blank" rel="noreferrer">clangのドキュメント</a>で確認できます。</p><h2 id="デバッグ" tabindex="-1">デバッグ <a class="header-anchor" href="#デバッグ" aria-label="Permalink to &quot;デバッグ&quot;">​</a></h2><p>Terraにはコードのデバッグやパフォーマンスチューニングに役立つライブラリ関数がいくつか用意されています。<code>currenttimeinseconds</code>以外のデバッグ機能は、OSXおよびLinuxでのみ使用可能です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">currenttimeinseconds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>過去のある時点からの経過時間を秒で返すLua関数です。Terraコードのパフォーマンスチューニングに便利です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">traceback</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uctx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque)</span></span></code></pre></div><p>Terraコードから呼び出してスタックトレースを出力するTerra関数です。<code>uctx</code>が<code>nil</code>の場合は現在のスタックを出力します。<code>uctx</code>は<code>ucontext_t</code>オブジェクト（<code>ucontext.h</code>参照）へのポインタとしても指定でき、そのコンテキストのスタックトレースを表示します。デフォルトでは、プログラムがセグメンテーションフォールトを起こした際にこの情報が出力されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">backtrace</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addresses</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;&amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">naddr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : uint64, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">frameaddress</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque)</span></span></code></pre></div><p>低レベルのインターフェースで、マシンスタックからリターンアドレスを取得します。<code>addresses</code>は少なくとも<code>naddr</code>ポインタ分の容量があるバッファへのポインタである必要があります。<code>ip</code>は現在の命令のアドレスで、最初のエントリとして<code>addresses</code>に格納され、<code>frameaddress</code>はベースポインタの値にする必要があります。<code>addresses</code>にはスタック上のリターンアドレスが格納されます。正しく機能させるにはデバッグモードを有効化（<code>-g</code>オプション）する必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">disas</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nbytes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : uint64, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ninst</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : uint64)</span></span></code></pre></div><p>低レベルの逆アセンブラインターフェースです。<code>addr</code>から始まる命令の逆アセンブルを出力します。<code>nbytes</code>バイト分または<code>ninst</code>命令分のいずれか多くなる方の命令が出力されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookupsymbol</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">addr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;&amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;uint64, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;rawstring, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namelength</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;uint64) : bool</span></span></code></pre></div><p>任意の命令のポインタ<code>ip</code>を基に、Terra関数に関する情報を検索しようと試みます。成功すると<code>true</code>を返し、<code>addr</code>に関数の開始アドレス、<code>size</code>に関数のバイト数が格納されます。<code>name</code>には関数名を最大<code>namemax</code>文字まで固定幅文字列として格納します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookupline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fnaddr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;opaque, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filename</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;rawstring, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">namelength</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;uint64, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : &amp;uint64) : bool</span></span></code></pre></div><p>命令のポインタ<code>ip</code>と、それを含む関数の開始アドレス<code>fnaddr</code>を指定して、Terra命令に関する情報を検索しようと試みます。成功すると<code>true</code>を返し、<code>line</code>に命令がある行番号、<code>filename</code>にファイル名が最大<code>namemax</code>文字まで格納されます。</p><h2 id="cコード内にterraを埋め込む" tabindex="-1">Cコード内にTerraを埋め込む <a class="header-anchor" href="#cコード内にterraを埋め込む" aria-label="Permalink to &quot;Cコード内にTerraを埋め込む&quot;">​</a></h2><p>Luaと同様に、Terraは既存のコードに埋め込むことを意図して設計されています。TerraのC APIは、Terra-Luaプログラムを実行するためのエントリーポイントとして機能します。実際、<code>terra</code>の実行ファイルとREPLは、このC APIのクライアントに過ぎません。TerraのC APIは、<a href="http://www.lua.org/manual/5.1/manual.html#3" target="_blank" rel="noreferrer">LuaのAPI</a>を拡張しており、Terra固有の関数が追加されています。クライアントはまず<code>lua_State</code>オブジェクトを作成し、<code>terra_init</code>を呼び出してTerra拡張を初期化します。Terraには、<code>lua_load</code>に相当する関数（例：<code>terra_loadfile</code>）が用意されており、これらの関数は入力をTerra-Luaコードとして扱います。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> L);</span></span></code></pre></div><p><code>lua_State</code> <code>L</code>の内部Terra状態を初期化します。<code>L</code>はすでに初期化された<code>lua_State</code>である必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">typedef </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 初期値は0 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    int verbose; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* デバッグ出力の冗長性を設定します。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    0（デバッグ出力なし）から2（非常に冗長）までの</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    値が有効です。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    int debug;   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* Terraコンパイラでデバッグ情報を有効にします。</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    スタックトレースにベースポインタと行番号情報が</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    表示されるようになります。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} terra_Options;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_initwithoptions</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> L, terra_Options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> options);</span></span></code></pre></div><p><code>lua_State</code> <code>L</code>の内部Terra状態を初期化します。<code>L</code>はすでに初期化された<code>lua_State</code>である必要があります。<code>terra_Options</code>には追加の設定オプションが含まれます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               lua_Reader reader,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               void </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">               const char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">chunkname);</span></span></code></pre></div><p>TerraとLuaの両方を含むチャンクを読み込みます。これは<code>lua_load</code>のTerra版であり、引数や動作は<code>lua_load</code>と同じですが、入力をTerra拡張を含むLuaプログラムとして解釈します。現時点では、Lua-Terraコードのバイナリ形式はなく、入力はテキストでなければなりません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_loadfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> L, const char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file);</span></span></code></pre></div><p>ファイルをTerra-Luaチャンクとして読み込みます。<code>luaL_loadfile</code>のTerra版です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_loadbuffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> L,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                         const char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">buf,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                         size_t size,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                         const char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name);</span></span></code></pre></div><p>バッファをTerra-Luaチャンクとして読み込みます。<code>luaL_loadbuffer</code>のTerra版です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">int </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_loadstring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">L, const char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span></code></pre></div><p>文字列<code>s</code>をTerra-Luaチャンクとして読み込みます。<code>luaL_loadstring</code>のTerra版です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_dofile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, file)</span></span></code></pre></div><p>ファイル<code>file</code>を読み込み、実行します。以下のコードと同等です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_loadfile</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, fn) || </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lua_pcall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, LUA_MULTRET, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_dostring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, s)</span></span></code></pre></div><p>文字列<code>s</code>を読み込み、実行します。以下のコードと同等です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terra_loadstring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, s) || </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lua_pcall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(L, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, LUA_MULTRET, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><h2 id="luaに埋め込む新しい言語の作成" tabindex="-1">Luaに埋め込む新しい言語の作成 <a class="header-anchor" href="#luaに埋め込む新しい言語の作成" aria-label="Permalink to &quot;Luaに埋め込む新しい言語の作成&quot;">​</a></h2><p>Terraシステムの言語拡張により、カスタムLua文や式を作成して独自の埋め込み言語を実装することができます。各言語は、言語内の文や式の開始を示すエントリーポイントキーワードを登録します。TerraパーサがLua式や文の先頭でこれらのキーワードのいずれかを検出すると、パーサの制御がその言語に切り替わり、トークンを抽象構文木（AST）またはその他の中間表現に解析します。ASTを作成した後、言語はTerraパーサに戻り、実行時に文や式を実行するためのコンストラクタ関数を返します。</p><p>このガイドでは、簡単なスタンドアロンの例を用いて言語拡張の基本を紹介し、Terraへの登録方法を示します。その後、この例を拡張してLua環境と相互作用する方法を説明します。ガイドの最後には、言語拡張インターフェースとレキサーインターフェースの詳細な仕様が記載されています。</p><h3 id="簡単な例" tabindex="-1">簡単な例 <a class="header-anchor" href="#簡単な例" aria-label="Permalink to &quot;簡単な例&quot;">​</a></h3><p>まず、Luaに単純な言語拡張を追加し、数値のリストを合計する言語を作成します。この構文は <code>sum 1,2,3 done</code> のような形で、実行すると数値を合計して <code>6</code> を出力します。言語拡張はLuaのテーブルを使って定義されます。以下がその言語のテーブルです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sumlanguage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;sumlanguage&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- デバッグ用の名前</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- 式の開始トークンとなるキーワードリスト</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  entrypoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  keywords </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- この言語固有のキーワードリスト</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   -- Terraパーサから呼び出されてこの言語に入ります</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  expression</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self,lex)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 実装がここに入ります</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ここでは、<code>entrypoints</code>リストに <code>&quot;sum&quot;</code> を追加しています。これは、このトークンが式の先頭に現れた際にTerraが制御をこの言語に渡すようにするためです。また、式の終わりを示す <code>&quot;done&quot;</code> もキーワードとしてリストに追加しています。Terraパーサが<code>sum</code>トークンを見つけたときに、<code>expression</code>関数が呼び出され、レキサーへのインターフェース <code>lex</code> が引数として渡されます。実装は以下の通りです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expression</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self,lex)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 最初のトークンは &quot;sum&quot; であるべき</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">matches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    repeat</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      -- 数値を解析してその値を返します</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> v</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- コンマがあれば、それを消費して続行</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    until</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nextif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;,&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  -- この式がLuaで評価されるときに実行される関数を返します</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(environment_function)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><code>lex</code> オブジェクトを使ってトークンと対話しています。このインターフェースは後述します。この文は数値の定数のみを許可しているため、解析中に合計を計算できます。最後に、<em>コンストラクタ関数</em> を返し、この文が実行されるたびにこの関数が呼び出されます。Luaコードでの使用例は以下の通りです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 6を出力</span></span></code></pre></div><p>この例のコードは <code>tests/lib/sumlanguage.t</code> にあり、その使用例は <code>tests/sumlanguage1.t</code> にあります。</p><h3 id="言語の読み込みと実行" tabindex="-1">言語の読み込みと実行 <a class="header-anchor" href="#言語の読み込みと実行" aria-label="Permalink to &quot;言語の読み込みと実行&quot;">​</a></h3><p>言語拡張を使用するためには、それを <em>インポート</em> する必要があります。 言語拡張の仕組みには、言語拡張をロードするための <code>import</code> 文が含まれています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lib/sumlanguage&quot; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 新しいパース規則を有効化</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done</span></span></code></pre></div><p><code>import</code> 文は <em>パース時</em> に評価されるため、引数は文字列リテラルでなければなりません。パーサはこの文字列リテラルを使って <code>require</code> を呼び出し、言語拡張ファイルを読み込みます。 指定されたファイルは、言語を記述したLuaテーブルを <em>return</em> する必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sumlanguage </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- テーブルを記入</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sumlanguage</span></span></code></pre></div><p>インポートされた言語は、インポート文が現れたローカルスコープ内でのみ有効です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    import</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;lib/sumlanguage&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- OK、スコープ内</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> then</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- OK、まだスコープ内</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- エラー! sumlanguageはスコープ外</span></span></code></pre></div><p>複数の言語を同じスコープにインポートすることも可能ですが、<code>entrypoints</code> が重複しない必要があります。 もし<code>entrypoints</code> が重複する場合、<code>import</code> 文が異なるスコープで発生すれば同じファイル内でインポートできます。</p><h3 id="luaシンボルとの相互作用" tabindex="-1">Luaシンボルとの相互作用 <a class="header-anchor" href="#luaシンボルとの相互作用" aria-label="Permalink to &quot;Luaシンボルとの相互作用&quot;">​</a></h3><p>Terraの利点の一つは、Luaと同じレキシカルスコープを共有することにより、Terraの関数を簡単にパラメータ化できる点です。拡張言語もまたLuaの静的スコープにアクセスできます。では、定数の数値だけでなくLuaの変数もサポートするように、sum言語を拡張してみましょう。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sum a,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> done) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 7を出力します</span></span></code></pre></div><p>これを行うには、<code>expression</code>関数内のコードを修正する必要があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">expression</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self,lex)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> variables </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terralib.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">newlist</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sum&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">matches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    repeat</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">matches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- 変数の場合</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- Terraのパーサーに指示</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- Luaの変数 &#39;name&#39; にアクセスすることを伝える</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- 変数名をリストに追加</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        variables</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">insert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    until</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nextif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;,&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(environment_function)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- ローカル環境をキャプチャ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    -- 変数名から値へのテーブル</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> environment_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mysum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sum</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i,v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ipairs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(variables) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      mysum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mysum </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env[v]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mysum</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>これで、式は変数名（<code>lex.name</code>）を含むことができます。定数とは異なり、変数の値は解析時にわからないため、実行前に合計を計算することはできません。代わりに、変数名を保存（<code>variables:insert(name)</code>）し、Terraのパーサーに実行時にその変数の値が必要であることを伝えます（<code>lex:ref(name)</code>）。_コンストラクタ_では、<code>environment_function</code>パラメータを呼び出すことでローカルなレキシカル環境をキャプチャし、その環境内で変数の値を参照して合計を計算します。<code>lex:ref(name)</code>を呼び出すことが重要です。もしこれを呼び出さなければ、この環境テーブルには必要な変数が含まれません。</p><h3 id="luaの再帰的な解析" tabindex="-1">Luaの再帰的な解析 <a class="header-anchor" href="#luaの再帰的な解析" aria-label="Permalink to &quot;Luaの再帰的な解析&quot;">​</a></h3><p>場合によっては、言語の途中でLuaのパーサーに戻り、Luaの式全体を解析したいことがあります。例えば、Terraの型はLuaの式です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">var </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : int </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span></span></code></pre></div><p>この例では、<code>int</code>は実際にはLuaの式です。</p><p><code>lex:luaexpr()</code>メソッドはLuaの式を解析します。このメソッドは、式を実装するLua関数を返します。この関数はローカルなレキシカル環境を受け取り、その環境での式の値を返します。例として、単一引数のLua関数を簡潔に指定する方法を追加してみましょう。<code>def(a) exp</code>のように、ここで<code>a</code>は単一の引数、<code>exp</code>はLuaの式です。これはPythonの<code>lambda</code>ステートメントに似ています。以下にその言語拡張を示します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;def&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  entrypoints </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;def&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  keywords </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {};</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  expression</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self,lex)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;def&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;(&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> formal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lex.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> expfn </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">luaexpr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(environment_function)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      -- 結果を返します。単一引数のlua関数です。</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(actual)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> environment_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- 仮引数を環境内の実引数にバインド</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        env[formal] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> actual</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        -- 環境内で式を評価</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> expfn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この例の完全なコードは<code>tests/lib/def.t</code>および<code>tests/def1.t</code>にあります。</p><h3 id="ステートメントの拡張" tabindex="-1">ステートメントの拡張 <a class="header-anchor" href="#ステートメントの拡張" aria-label="Permalink to &quot;ステートメントの拡張&quot;">​</a></h3><p>式の構文を拡張するだけでなく、ステートメントやローカル変数の宣言に対しても新しい構文を定義できます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- 新しいステートメント</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> terra </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> -- 新しいローカル変数の宣言</span></span></code></pre></div><p>これは、言語テーブルに<code>statement</code>および<code>localstatement</code>関数を指定することで行います。これらの関数は、<code>expression</code>関数と同様に動作しますが、定義する名前のリストをオプションで返すことができます。ファイル<code>test/lib/def.t</code>には、この方法を使って<code>def</code>コンストラクタでステートメントをサポートする方法が示されています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">def </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a) luaexpr </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- グローバル変数 foo を定義</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> def </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a) luaexpr </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- ローカル変数 bar を定義</span></span></code></pre></div><h3 id="prattパーサによる高レベルの解析" tabindex="-1">Prattパーサによる高レベルの解析 <a class="header-anchor" href="#prattパーサによる高レベルの解析" aria-label="Permalink to &quot;Prattパーサによる高レベルの解析&quot;">​</a></h3><p>直接的に字句解析器インターフェースを使ってパーサを書くのは手間がかかります。解析を簡単にするためのシンプルな方法の一つに、Prattパーサ（トップダウンの優先度解析、詳細は<a href="http://javascript.crockford.com/tdop/tdop.html" target="_blank" rel="noreferrer">こちら</a>）があります。この方法は、特に複数の優先度レベルがある式に対して便利です。Lexerインターフェース上に構築されたライブラリを提供しており、APIのドキュメントと共に<code>tests/lib/parsing.t</code>で見つけることができます。このライブラリを使用した拡張の例は<code>tests/lib/pratttest.t</code>、およびそれを使用したプログラムの例は<code>tests/pratttest1.t</code>にあります。</p><h3 id="言語とlexer-api" tabindex="-1">言語とLexer API <a class="header-anchor" href="#言語とlexer-api" aria-label="Permalink to &quot;言語とLexer API&quot;">​</a></h3><p>このセクションでは、言語を定義し、<code>lexer</code>オブジェクトとやり取りするためのAPIについて詳しく説明します。</p><h4 id="言語テーブル" tabindex="-1">言語テーブル <a class="header-anchor" href="#言語テーブル" aria-label="Permalink to &quot;言語テーブル&quot;">​</a></h4><p>言語拡張は、次のフィールドを持つLuaテーブルによって定義されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span></span></code></pre></div><p>デバッグに使用する言語の名前</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">entrypoints</span></span></code></pre></div><p>この言語での項を開始できるキーワードを指定するLuaリストです。これらのキーワードは、TerraやLuaのキーワードであってはならず、他の読み込まれた言語のエントリーポイントと重複してはなりません（将来的には、言語を読み込む際にエントリーポイントの名前を変更して競合を解決できるようにする可能性があります）。これらのキーワードは有効なLua識別子でなければなりません（すなわち、英数字で構成され、数字で始まってはなりません）。将来的には任意の演算子（例：<code>+=</code>）を許可することを検討しています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">keywords</span></span></code></pre></div><p>言語内で使用する追加のキーワードを指定するLuaリストです。エントリーポイントと同様に、これらも有効な識別子である必要があります。LuaやTerra内でキーワードとされるものは常にあなたの言語でもキーワードとして扱われるため、ここにリストする必要はありません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">expression</span></span></code></pre></div><p>（オプション）Luaの式の先頭にエントリーポイントキーワードが出現した場合に呼び出されるLuaメソッド<code>function(self,lexer)</code>です。<code>self</code>は言語オブジェクト、<code>lexer</code>はトークンの取得やエラーの報告を行うためにTerraの字句解析器とやり取りするためのLuaオブジェクトです。そのAPIについては以下で説明します。この<code>expression</code>メソッドは、コンストラクタ関数<code>function(environment_function)</code>を返すべきです。このコンストラクタは式が評価されるたびに呼び出され、その式がLuaコード内で現れる際の値を返す必要があります。引数<code>environment_function</code>は、呼び出されると変数名から値へのLuaテーブルとしてローカルなレキシカル環境を返す関数です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">statement</span></span></code></pre></div><p>（オプション）Lua _ステートメント_の先頭にエントリーポイントキーワードが出現した場合に呼び出されるLuaメソッド<code>function(self,lexer)</code>です。<code>expression</code>と同様にコンストラクタ関数を返します。さらに、変数に対する代入のリストとして二つ目の引数を返すことができます。たとえば、値<code>{ &quot;a&quot;, &quot;b&quot;, {&quot;c&quot;,&quot;d&quot;} }</code>はLuaステートメント<code>a,b,c.d = constructor(...)</code>のように振る舞います。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">localstatement</span></span></code></pre></div><p>（オプション）<code>local</code>ステートメントの先頭にエントリーポイントキーワードが出現した場合（例：<code>local terra foo() end</code>）に呼び出されるLuaメソッド<code>function(self,lexer)</code>です。<code>statement</code>と同様に、このメソッドも名前のリスト（例：<code>{&quot;a&quot;,&quot;b&quot;}</code>）を返すことができます。この場合、これらの名前はローカル変数として定義され、<code>local a, b = constructor(...)</code>のように振る舞います。</p><h4 id="トークン" tabindex="-1">トークン <a class="header-anchor" href="#トークン" aria-label="Permalink to &quot;トークン&quot;">​</a></h4><p>言語のメソッドには、Terraの_字句解析器_（lexer）へのインターフェースである<code>lexer</code>が与えられます。これを使用してトークンのストリームを調べたり、エラーを報告したりできます。_トークン_は以下のフィールドを持つLuaテーブルです。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span></span></code></pre></div><p><em>トークンの種類</em>。キーワードや演算子の場合、これは単なる文字列です（例：<code>&quot;and&quot;</code>や<code>&quot;+&quot;</code>）。<code>lexer.name</code>、<code>lexer.number</code>、<code>lexer.string</code>は、それぞれ識別子（例：<code>myvar</code>）、数値（例：3）、文字列（例：<code>&quot;my string&quot;</code>）を示します。<code>lexer.eof</code>はトークンストリームの終端を示します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span></span></code></pre></div><p>名前、文字列、数値の場合、これは具体的な値になります（例：<code>3.3</code>）。数値は、Luaの数値として表現される場合（浮動小数点数または32ビット整数）と、64ビット整数では<code>[u]int64_t</code>のcdata型として表現されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">valuetype</span></span></code></pre></div><p>数値の場合、これは解析されたリテラルのTerra型です。<code>3</code>は<code>int</code>型、<code>3.3</code>は<code>double</code>型、<code>3.f</code>は<code>float</code>型、<code>3ULL</code>は<code>uint64</code>型、<code>3LL</code>は<code>int64</code>型、<code>3U</code>は<code>uint</code>型になります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">linenumber</span></span></code></pre></div><p>このトークンが出現した行番号です（先読みトークンには利用できません）。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">token.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">offset</span></span></code></pre></div><p>このトークンが発生したファイルの先頭からの文字数のオフセットです（先読みトークンには利用できません）。</p><h4 id="lexer" tabindex="-1">Lexer <a class="header-anchor" href="#lexer" aria-label="Permalink to &quot;Lexer&quot;">​</a></h4><p><code>lexer</code>オブジェクトは、以下のフィールドとメソッドを提供します。<code>lexer</code>自体は解析中のみ有効であり、たとえばコンストラクタ関数から呼び出すことはできません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cur</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>現在の_トークン_を返します。位置は変更しません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookahead</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>現在のトークンの次の_トークン_を返します。位置は変更しません。実装を簡単にするため、1つのトークンのみ先読みが許可されています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">matches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokentype)</span></span></code></pre></div><p><code>lexer:cur().type == tokentype</code> の短縮形</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookaheadmatches</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokentype)</span></span></code></pre></div><p><code>lexer:lookahead().type == tokentype</code> の短縮形</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>現在のトークンを返し、次のトークンに進みます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nextif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokentype)</span></span></code></pre></div><p><code>tokentype</code>が現在のトークンの<code>type</code>と一致する場合、そのトークンを返してlexerを進めます。そうでない場合は<code>false</code>を返し、lexerは進みません。多くの代替案を解析したいときに便利です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokentype)</span></span></code></pre></div><p><code>tokentype</code>が現在のトークンのタイプと一致する場合、そのトークンを返しlexerを進めます。そうでない場合、解析を停止してエラーを発生させます。どのトークンが出現すべきかがわかっている場合に便利です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">expectmatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(tokentype,openingtokentype,linenumber)</span></span></code></pre></div><p><code>expect</code>と同様ですが、マッチしたトークンに対してより良いエラーレポートを提供します。たとえば、リストの閉じカッコ<code>}</code>を解析する際に<code>lexer:expectmatch(&#39;}&#39;,&#39;{&#39;,lineno)</code>を呼び出すと、対応しない括弧や開閉行が報告されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lexer.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">source</span></span></code></pre></div><p>ファイル名またはストリームの識別子を含む文字列（将来のエラーレポートに便利）</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg)</span></span></code></pre></div><p>解析エラーを報告して処理を中断します。<code>msg</code>は文字列です。返り値はありません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">errorexpected</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg)</span></span></code></pre></div><p><code>msg</code>という文字列が予期されていましたが、現れなかったことを報告します。返り値はありません。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">ref</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name)</span></span></code></pre></div><p><code>name</code>は文字列で、Terraのパーサーに対し、言語がLuaの変数<code>name</code>を参照する可能性があることを示します。関心のある自由な識別子について、この関数を必ず呼び出す必要があります。そうしないと、その識別子は_コンストラクタ_関数に渡されるレキシカル環境に現れない可能性があります。参照しない識別子に対して呼び出しても安全ですが、効率が低下します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">luaexpr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>トークンストリームから単一のLua式を解析します。これを使用して言語の式に対しLuaの解析に戻ることができます。たとえば、Terraはこれを使用して型を解析します（型は単なるLua式です）：<code>var a : aluaexpression(4) = 3</code>。この関数は、<code>function(lexicalenv)</code>という関数を返し、現在のレキシカルスコープのテーブル（コンストラクタの<code>environment_function</code>から返されるものなど）を受け取り、そのスコープで評価された式の値を返します。この関数は、Lua式をASTに解析するためのものではありません。現在、Lua式をASTに解析するには、自分でパーサーを書く必要があります。将来的には、言語でLua/Terraの文法の一部を選択して使用できるライブラリを追加する予定です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">luastats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>トークンストリームから一連のLuaステートメントを解析し、ブロックの終了キーワード（<code>end</code>、<code>else</code>、<code>elseif</code>など）に達するまで処理します。これを利用すると、Luaのすべてのパーサを再実装することなく、Luaを拡張したドメイン固有言語を構築するのに役立ちます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terraexpr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>トークンストリームから単一のTerra式を解析します。これを使用すると、Terraを拡張したドメイン固有言語を再実装することなく構築するのに役立ちます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lexer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">terrastats</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>トークンストリームから一連のTerraステートメントを解析し、ブロックの終了キーワード（<code>end</code>、<code>else</code>、<code>elseif</code>など）に達するまで処理します。これを利用して、Terraを拡張したドメイン固有言語を構築するのに役立ちます。</p><h2 id="中間表現と抽象構文記述言語-asdl" tabindex="-1">中間表現と抽象構文記述言語 (ASDL) <a class="header-anchor" href="#中間表現と抽象構文記述言語-asdl" aria-label="Permalink to &quot;中間表現と抽象構文記述言語 (ASDL)&quot;">​</a></h2><p><a href="https://www.usenix.org/legacy/publications/library/proceedings/dsl97/full_papers/wang/wang.pdf" target="_blank" rel="noreferrer">抽象構文記述言語 (ASDL)</a> は、コンパイラの中間表現（IR）やツリーやグラフベースのデータ構造を簡潔に記述する方法です。代数的データ型に似ていますが、一貫したクロス言語仕様を提供します。Pythonのコンパイラではその文法を記述するためにASDLが使用され、Terra内部でもTerraコードを表現するために使用されています。</p><p>ASDL仕様を解析するためのLuaライブラリを提供しており、ドメイン固有言語の構築に役立つIRや他のデータ構造を実装できます。このライブラリを使用すると、ASDL仕様を解析し、IRを構築するためのLuaクラス（実際には特別に定義されたメタテーブル）を作成できます。このライブラリはIRの構築用のコンストラクタ付きでクラスを自動的に設定し、通常のLuaメソッド定義を使って追加メソッドをクラスに追加できます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asdl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;asdl&#39;</span></span></code></pre></div><p>ASDLパッケージはTerraに付属しています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asdl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NewContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>ASDLクラスはコンテキスト内で定義されます。異なるコンテキストは何も共有しません。コンテキスト内の各クラスには一意の名前が必要です。</p><h3 id="asdlクラスの作成" tabindex="-1">ASDLクラスの作成 <a class="header-anchor" href="#asdlクラスの作成" aria-label="Permalink to &quot;ASDLクラスの作成&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> asdl.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NewContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Define</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> [[</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # 2つのメンバーを持つ単純なレコード型を定義</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Real = (number mantissa, number exp)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   #       ^~~~ フィールド型         ^~~~~ フィールド名</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # タグ付きユニオン（バリアント、判別付きユニオン、合計型）</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # をいくつかのオプションのデータ型で定義。</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # この例では型 Stm は3つのサブタイプを持ちます。</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Stm = Compound(Stm head, Stm next)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       | Assign(string lval, Exp rval)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # &#39;*&#39; はフィールドがリストオブジェクトであることを指定</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # &#39;?&#39; はフィールドがオプション（nilまたはその型）であることを指定</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       | Print(Exp* args, string? format)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Exp = Id(string name)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       | Num(number v)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">       | Op(Exp lhs, BinOp op, Exp rhs)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   # タグ付きユニオンで()を省略すると、シングルトン値を作成</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   BinOp = Plus | Minus</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]]</span></span></code></pre></div><p>型はLuaのプリミティブ（<code>type(v)</code>が返すnumber、table、function、string、booleanなど）、他のASDL型、または<code>context:Extern</code>で登録された任意の関数でチェックされた型が使用できます。</p><p>外部型を使用するには、その型に対して名前を登録し、その型のオブジェクトに対してtrueを返す関数を指定します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Extern</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;File&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">   return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> io.type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(obj) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;file&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="asdlクラスの使用" tabindex="-1">ASDLクラスの使用 <a class="header-anchor" href="#asdlクラスの使用" aria-label="Permalink to &quot;ASDLクラスの使用&quot;">​</a></h3><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> assign </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Assign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;x&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,exp)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> real </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Real</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> List </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> require</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;terralist&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">List</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {exp})</span></span></code></pre></div><p>値はクラスを関数として呼び出すことで作成されます。引数は構築時に正しい型であるかチェックされ、間違った型の場合には警告が表示されます。</p><p>フィールドはコンストラクタによって初期化されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(exp.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- 1</span></span></code></pre></div><p>デフォルトでクラスには文字列表現があります。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Assign(lval = x,rval = Num(v = 1))</span></span></code></pre></div><p>メンバーシップを<code>:isclassof</code>で確認することができます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Assign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isclassof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign))</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isclassof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign))</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Exp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isclassof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>シングルトンはクラスではなく値です。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BinOp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">isclassof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Plus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>クラスはその値のメタテーブルであり、<code>Class.__index = Class</code>を持ちます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">getmetatable</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Assign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>タグ付きユニオンには文字列フィールド<code>.kind</code>があり、ユニオン内でその値がどのバリアントであるかを識別します。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(assign.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Assign&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="asdlクラスにメソッドを追加" tabindex="-1">ASDLクラスにメソッドを追加 <a class="header-anchor" href="#asdlクラスにメソッドを追加" aria-label="Permalink to &quot;ASDLクラスにメソッドを追加&quot;">​</a></h3><p>クラスに追加のメソッドを定義して、追加の機能を持たせることができます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> env[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">v</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Op</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">op</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lhs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lhs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rhs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rhs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(env)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Plus&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lhs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rhs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">kind</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Minus&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">     return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lhs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rhs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Op</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Plus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,Types.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Num</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">eval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>また、スーパークラスにメソッドを定義すると、サブクラスにもそのメソッドが定義されます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  print</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">assign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>注意: メタテーブルの構造を簡単に保つために、これは連鎖テーブルで実装されていません。このデザイン上、スーパークラスでのメソッド定義はサブクラスにもコピーされるため、<strong>親のメソッドは子のメソッドより先に定義しなければなりません</strong>。そうでなければ、親のメソッドが子のメソッドを上書きしてしまいます。</p><p><strong>すでに定義済みのメソッド（例えば <code>__tostring</code>）をオーバーライドする必要がある場合は、最初にスーパークラスでそれを<code>nil</code>に設定してください。</strong></p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__tostring</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Stm</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">__tostring</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&lt;Stm&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="名前空間" tabindex="-1">名前空間 <a class="header-anchor" href="#名前空間" aria-label="Permalink to &quot;名前空間&quot;">​</a></h3><p>ASDLの拡張として、名前空間を定義するために<code>module</code>キーワードを使用できます。これにより、コンパイラで多くの異なる<code>Exp</code>や<code>Type</code>を扱う際に役立ちます。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Define</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> [[</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   module Foo {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      Bar = (number a)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      Baz = (Bar b)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   Outside = (Foo.Baz x)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Foo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Bar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="ユニーク" tabindex="-1">ユニーク <a class="header-anchor" href="#ユニーク" aria-label="Permalink to &quot;ユニーク&quot;">​</a></h3><p>もう一つの拡張として、任意の具体型を<code>unique</code>としてマークすることができます。<code>unique</code>型は構築時にメモ化され、同じ引数（Luaの等価性の範囲内で）で構築された場合は、同じLuaオブジェクトが再び返されます。これは、リスト（<code>*</code>）やオプション（<code>?</code>）を含む型にも対応しています。</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Types</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Define</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> [[</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   module U {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      Exp = Id(string name) unique</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          | Num(number v) unique</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">]]</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">assert</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">U</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Types.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">U</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;foo&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/raia-engine/raia-document/edit/main/docs/resource/terra/api.md" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> Edit this page<!--]--></a></div><div class="last-updated" data-v-e257564d><p class="VPLastUpdated" data-v-e257564d data-v-e98dd255>Last updated: <time datetime="2024-11-02T04:25:41.000Z" data-v-e98dd255></time></p></div></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/resource/terra/getting-started.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>はじめに</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/resource/terra/terraforcpp.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>Terra for C++</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"document_about_raia_api.md\":\"DJm_MxLH\",\"document_configure_macos.md\":\"m6WwwQxS\",\"document_index.md\":\"CecH5jVb\",\"document_mac_unix_to_app.md\":\"D6scoT5k\",\"document_memo.md\":\"BWP5je1S\",\"document_plugin.md\":\"CogGepbx\",\"document_qt.md\":\"CIRXy5Zt\",\"document_rag.md\":\"ZZu_3cKu\",\"document_raia_dir_struct.md\":\"B7sjmBxb\",\"document_raia_test.md\":\"C-d13F8G\",\"document_steamdeck.md\":\"CriMjY64\",\"document_usage_index.md\":\"DMbvooqG\",\"document_usage_setup.md\":\"Ck41dm51\",\"document_usage_tutorial_windows_helloworld.md\":\"BhCME6Xh\",\"document_usage_tutorial_windows_image.md\":\"g8wykATg\",\"document_usage_tutorial_windows_input.md\":\"B0q5y9EQ\",\"document_usage_tutorial_windows_mainloop.md\":\"DZpRmnRY\",\"document_usage_tutorial_windows_setup.md\":\"Bx6jFP3e\",\"document_usage_tutorial_windows_shape.md\":\"fQXIa-wl\",\"document_usage_tutorial_windows_surface.md\":\"CV-U4GHZ\",\"download_index.md\":\"C-Ijsxci\",\"index.md\":\"B0Lzji9N\",\"reference_built_in_bit_arshift.md\":\"CsoFOJzs\",\"reference_built_in_bit_band.md\":\"BXFohuR4\",\"reference_built_in_bit_bnot.md\":\"DetrLLiH\",\"reference_built_in_bit_bor.md\":\"RtNL_L6D\",\"reference_built_in_bit_bswap.md\":\"Ba5c9Elv\",\"reference_built_in_bit_bxor.md\":\"4ip4HqPr\",\"reference_built_in_bit_lshift.md\":\"RyOtmWEI\",\"reference_built_in_bit_rol.md\":\"BV2uNzeX\",\"reference_built_in_bit_ror.md\":\"DNrRzPmd\",\"reference_built_in_bit_rshift.md\":\"CbxvOC9z\",\"reference_built_in_bit_tobit.md\":\"BBI36eAN\",\"reference_built_in_bit_tohex.md\":\"CG9s-BE4\",\"reference_built_in_coroutine_create.md\":\"WUbIOjjc\",\"reference_built_in_coroutine_isyieldable.md\":\"CEahW7Jl\",\"reference_built_in_coroutine_resume.md\":\"DkzIYWfz\",\"reference_built_in_coroutine_running.md\":\"DXXlFjnJ\",\"reference_built_in_coroutine_status.md\":\"BPBEH9Zg\",\"reference_built_in_coroutine_wrap.md\":\"CoeM7sLy\",\"reference_built_in_coroutine_yield.md\":\"xoehKc7K\",\"reference_built_in_debug_debug.md\":\"B50uo1hE\",\"reference_built_in_debug_getfenv.md\":\"gZ3_mIxL\",\"reference_built_in_debug_gethook.md\":\"B708awFc\",\"reference_built_in_debug_getinfo.md\":\"Ct6NBQjD\",\"reference_built_in_debug_getlocal.md\":\"QpZOyEt1\",\"reference_built_in_debug_getmetatable.md\":\"C22wfXxh\",\"reference_built_in_debug_getregistry.md\":\"BWAUYmQO\",\"reference_built_in_debug_getupvalue.md\":\"C65JsUR3\",\"reference_built_in_debug_setfenv.md\":\"ZKs2B5Cv\",\"reference_built_in_debug_sethook.md\":\"C8dgF3cU\",\"reference_built_in_debug_setlocal.md\":\"FStNrJxw\",\"reference_built_in_debug_setmetatable.md\":\"CwdSVzeK\",\"reference_built_in_debug_setupvalue.md\":\"_OO7Mo1e\",\"reference_built_in_debug_traceback.md\":\"DU0mJSD_\",\"reference_built_in_debug_upvalueid.md\":\"D_DKOU8O\",\"reference_built_in_debug_upvaluejoin.md\":\"CP9KqDoK\",\"reference_built_in_ffi_abi.md\":\"BTNEqqIz\",\"reference_built_in_ffi_alignof.md\":\"kvHj5YMW\",\"reference_built_in_ffi_arch.md\":\"XC05V9_t\",\"reference_built_in_ffi_c.md\":\"ClWGHWW3\",\"reference_built_in_ffi_cast.md\":\"uY8aCRQa\",\"reference_built_in_ffi_cb_free.md\":\"CWUl98Gc\",\"reference_built_in_ffi_cb_set.md\":\"CX7ma9Z0\",\"reference_built_in_ffi_cdef.md\":\"DODT5Qmr\",\"reference_built_in_ffi_copy.md\":\"BMqmdOS3\",\"reference_built_in_ffi_ctype.md\":\"BD8dBpPz\",\"reference_built_in_ffi_errno.md\":\"DzBSqoiG\",\"reference_built_in_ffi_fill.md\":\"CBMALsxV\",\"reference_built_in_ffi_gc.md\":\"kZuB223-\",\"reference_built_in_ffi_load.md\":\"DTmAzW1z\",\"reference_built_in_ffi_metatype.md\":\"DaduGmk8\",\"reference_built_in_ffi_new.md\":\"CszByGlO\",\"reference_built_in_ffi_offsetof.md\":\"5XpZ8nU7\",\"reference_built_in_ffi_os.md\":\"Dmg7lPpc\",\"reference_built_in_ffi_sizeof.md\":\"nYThoDy4\",\"reference_built_in_ffi_string.md\":\"sFbcU3an\",\"reference_built_in_ffi_typeof.md\":\"CMqWtd1g\",\"reference_built_in_global__g.md\":\"CBnU6bqb\",\"reference_built_in_global__version.md\":\"vmXzgmnH\",\"reference_built_in_index.md\":\"C7dLWryT\",\"reference_built_in_io_close.md\":\"D9R83ivF\",\"reference_built_in_io_file_close.md\":\"D2OQsXi3\",\"reference_built_in_io_file_flush.md\":\"CQgaDbPe\",\"reference_built_in_io_file_lines.md\":\"D_68ll5b\",\"reference_built_in_io_file_read.md\":\"BBq85eg8\",\"reference_built_in_io_file_seek.md\":\"CmtRO2PD\",\"reference_built_in_io_file_setvbuf.md\":\"CooidopG\",\"reference_built_in_io_file_write.md\":\"DPk2XMEm\",\"reference_built_in_io_flush.md\":\"Cl_R-Ws8\",\"reference_built_in_io_input.md\":\"C0A5xapl\",\"reference_built_in_io_lines.md\":\"caiv9gEK\",\"reference_built_in_io_open.md\":\"dnp2qlt9\",\"reference_built_in_io_output.md\":\"D2bL6pw_\",\"reference_built_in_io_popen.md\":\"CfSiIPk0\",\"reference_built_in_io_read.md\":\"DbgigpL4\",\"reference_built_in_io_tmpfile.md\":\"CwiDSjVe\",\"reference_built_in_io_type.md\":\"OudqrCyp\",\"reference_built_in_io_write.md\":\"B1gniLBV\",\"reference_built_in_jit_arch.md\":\"CbzIO_lH\",\"reference_built_in_jit_flush.md\":\"CrWKC0bl\",\"reference_built_in_jit_off.md\":\"zrCEFix-\",\"reference_built_in_jit_on.md\":\"ex_v-Yas\",\"reference_built_in_jit_opt.md\":\"Cy1pAKAV\",\"reference_built_in_jit_os.md\":\"BL9ZDSQx\",\"reference_built_in_jit_status.md\":\"DD2i-tpZ\",\"reference_built_in_jit_util.md\":\"YlC-DC3G\",\"reference_built_in_jit_version.md\":\"ViTPlnR0\",\"reference_built_in_jit_version_num.md\":\"MxlouyR9\",\"reference_built_in_math_abs.md\":\"BRNmF1pY\",\"reference_built_in_math_acos.md\":\"BHSqLi_0\",\"reference_built_in_math_asin.md\":\"ZPhdbhYQ\",\"reference_built_in_math_atan.md\":\"B3T8vCX0\",\"reference_built_in_math_atan2.md\":\"C-54DmAX\",\"reference_built_in_math_ceil.md\":\"uJEDEHra\",\"reference_built_in_math_cos.md\":\"BDjlyztw\",\"reference_built_in_math_cosh.md\":\"B1St-fXi\",\"reference_built_in_math_deg.md\":\"Djk8x8cs\",\"reference_built_in_math_exp.md\":\"D-mZfspM\",\"reference_built_in_math_floor.md\":\"yeAwwgcy\",\"reference_built_in_math_fmod.md\":\"D93SJc9V\",\"reference_built_in_math_frexp.md\":\"aUwdjbhh\",\"reference_built_in_math_huge.md\":\"BW36han_\",\"reference_built_in_math_ldexp.md\":\"DCrCes7z\",\"reference_built_in_math_log.md\":\"CbdZ6rUJ\",\"reference_built_in_math_log10.md\":\"CHtpfbnX\",\"reference_built_in_math_max.md\":\"D0Wn_WYe\",\"reference_built_in_math_min.md\":\"O0E6YckV\",\"reference_built_in_math_modf.md\":\"BSIyHMz2\",\"reference_built_in_math_pi.md\":\"D2Hk3B1K\",\"reference_built_in_math_pow.md\":\"DHb3hkj2\",\"reference_built_in_math_rad.md\":\"CTP6gE4p\",\"reference_built_in_math_random.md\":\"8LVvhHZn\",\"reference_built_in_math_randomseed.md\":\"BWFcZpFY\",\"reference_built_in_math_sin.md\":\"BQ0T-X8M\",\"reference_built_in_math_sinh.md\":\"Ck_L6N0B\",\"reference_built_in_math_sqrt.md\":\"DGRLxUyM\",\"reference_built_in_math_tan.md\":\"BEXcIsx3\",\"reference_built_in_math_tanh.md\":\"t6NcjM60\",\"reference_built_in_os_clock.md\":\"DwCGd4EG\",\"reference_built_in_os_date.md\":\"CSzFoTIb\",\"reference_built_in_os_difftime.md\":\"DIRR1dKS\",\"reference_built_in_os_execute.md\":\"qFUQx47M\",\"reference_built_in_os_exit.md\":\"C9stdXtB\",\"reference_built_in_os_getenv.md\":\"JA-1FKHX\",\"reference_built_in_os_remove.md\":\"CEf7lcfm\",\"reference_built_in_os_rename.md\":\"BoeZLMJT\",\"reference_built_in_os_setlocale.md\":\"CUfOxH6f\",\"reference_built_in_os_time.md\":\"Cmjss_ry\",\"reference_built_in_os_tmpname.md\":\"CFPOY2tY\",\"reference_built_in_package_cpath.md\":\"DfHpjbEz\",\"reference_built_in_package_loaded.md\":\"BTFUfLQ1\",\"reference_built_in_package_loaders.md\":\"yhAUGWqy\",\"reference_built_in_package_loadlib.md\":\"BhA_z1XF\",\"reference_built_in_package_module.md\":\"D8wHoxiT\",\"reference_built_in_package_path.md\":\"BhO2NTsC\",\"reference_built_in_package_preload.md\":\"HhXoQOGN\",\"reference_built_in_package_require.md\":\"Dbub6NSo\",\"reference_built_in_package_searchpath.md\":\"5OKUE5D1\",\"reference_built_in_package_seeall.md\":\"ChaeyqLF\",\"reference_built_in_std_assert.md\":\"80TWgLse\",\"reference_built_in_std_collectgarbage.md\":\"B26VBnWK\",\"reference_built_in_std_dofile.md\":\"DO7yTX3C\",\"reference_built_in_std_error.md\":\"DWtCExTm\",\"reference_built_in_std_getfenv.md\":\"DbYtqLG8\",\"reference_built_in_std_getmetatable.md\":\"C8B0SkCY\",\"reference_built_in_std_ipairs.md\":\"xe-BtrxP\",\"reference_built_in_std_load.md\":\"gTLldpJM\",\"reference_built_in_std_loadfile.md\":\"CMPtDFiT\",\"reference_built_in_std_loadstring.md\":\"alkQUNdo\",\"reference_built_in_std_next.md\":\"D8zqQwN1\",\"reference_built_in_std_pairs.md\":\"Cl4dynQR\",\"reference_built_in_std_pcall.md\":\"MCb3qqSk\",\"reference_built_in_std_print.md\":\"72DLC0NF\",\"reference_built_in_std_rawequal.md\":\"BG9VQol_\",\"reference_built_in_std_rawget.md\":\"72cpok-q\",\"reference_built_in_std_rawset.md\":\"DY-wQtJs\",\"reference_built_in_std_select.md\":\"Cbw6w7b-\",\"reference_built_in_std_setfenv.md\":\"aLsk2xrr\",\"reference_built_in_std_setmetatable.md\":\"C3nICCiN\",\"reference_built_in_std_tonumber.md\":\"CNObrb8o\",\"reference_built_in_std_tostring.md\":\"1TSxj-ps\",\"reference_built_in_std_type.md\":\"Botuvf0M\",\"reference_built_in_std_unpack.md\":\"Dg7o58x8\",\"reference_built_in_std_xpcall.md\":\"BukvNjgB\",\"reference_built_in_string_buffer_buf_free.md\":\"5IxrU1Ga\",\"reference_built_in_string_buffer_buf_get.md\":\"D6VCQTYh\",\"reference_built_in_string_buffer_buf_put.md\":\"BibRycpW\",\"reference_built_in_string_buffer_buf_putcdata.md\":\"Bymq80EC\",\"reference_built_in_string_buffer_buf_putf.md\":\"CBIU5Oze\",\"reference_built_in_string_buffer_buf_ref.md\":\"ZmHJlmPn\",\"reference_built_in_string_buffer_buf_reserve.md\":\"DFSgSF_X\",\"reference_built_in_string_buffer_buf_reset.md\":\"CbG2xurP\",\"reference_built_in_string_buffer_buf_set.md\":\"DIPkfeT6\",\"reference_built_in_string_buffer_buf_skip.md\":\"Do-kvZ3l\",\"reference_built_in_string_buffer_buf_tostring.md\":\"CbTfosKd\",\"reference_built_in_string_buffer_decode.md\":\"Cl8K9jvH\",\"reference_built_in_string_buffer_encode.md\":\"BEwbTo6O\",\"reference_built_in_string_buffer_new.md\":\"u4WUPj5H\",\"reference_built_in_string_byte.md\":\"BB9_zfa2\",\"reference_built_in_string_char.md\":\"BcUyLZM1\",\"reference_built_in_string_dump.md\":\"yLL-qpM7\",\"reference_built_in_string_find.md\":\"JsxXQ4zP\",\"reference_built_in_string_format.md\":\"C9LSiUNG\",\"reference_built_in_string_gmatch.md\":\"DdsynO4i\",\"reference_built_in_string_gsub.md\":\"CqpaoyMR\",\"reference_built_in_string_len.md\":\"Bx6I8YSv\",\"reference_built_in_string_lower.md\":\"Dhkp5dLu\",\"reference_built_in_string_match.md\":\"SahVN0Ac\",\"reference_built_in_string_rep.md\":\"Bm89uHLP\",\"reference_built_in_string_reverse.md\":\"HsJqdLcc\",\"reference_built_in_string_sub.md\":\"CF9XckTV\",\"reference_built_in_string_upper.md\":\"B95c_Tbx\",\"reference_built_in_table_clear.md\":\"BANAxFGu\",\"reference_built_in_table_concat.md\":\"CWsB6XA_\",\"reference_built_in_table_insert.md\":\"Dl_YJub8\",\"reference_built_in_table_maxn.md\":\"ENvoK7-P\",\"reference_built_in_table_move.md\":\"DkmnY7LN\",\"reference_built_in_table_new.md\":\"Ddq2zjkr\",\"reference_built_in_table_remove.md\":\"B4PwY6uV\",\"reference_built_in_table_sort.md\":\"Hlpbd-S-\",\"reference_index.md\":\"K_3SZlPH\",\"reference_lua_c_index.md\":\"DxxxZEUV\",\"resource_glfw_guides_building_applications.md\":\"elTNYlF2\",\"resource_glfw_guides_context_guide.md\":\"B-qtjtPO\",\"resource_glfw_guides_index.md\":\"CgTRU2Yz\",\"resource_glfw_guides_input_guide.md\":\"BsGbFIah\",\"resource_glfw_guides_introduction_to_the_api.md\":\"DIlKONef\",\"resource_glfw_guides_monitor_guide.md\":\"Cw9VyofR\",\"resource_glfw_guides_window_guide.md\":\"B3foIW0F\",\"resource_glfw_index.md\":\"DXLFd8dP\",\"resource_glfw_introduction.md\":\"CfbcUkJ_\",\"resource_glfw_reference_context.md\":\"Bi3uMPGd\",\"resource_glfw_reference_error.md\":\"Dqaf7nb0\",\"resource_glfw_reference_gamepad_axes.md\":\"DL2zyBvM\",\"resource_glfw_reference_gamepad_buttons.md\":\"BuwBLJ-J\",\"resource_glfw_reference_index.md\":\"DJX0OK5x\",\"resource_glfw_reference_init.md\":\"DYmQF234\",\"resource_glfw_reference_input.md\":\"B3tDgVTd\",\"resource_glfw_reference_joystick_hat_states.md\":\"Q5MUNl0w\",\"resource_glfw_reference_joysticks.md\":\"BYearoX5\",\"resource_glfw_reference_keyboard_keys.md\":\"9GrlYPwM\",\"resource_glfw_reference_modifier_key_flags.md\":\"BmgLbOTS\",\"resource_glfw_reference_monitor.md\":\"CeY7kNzt\",\"resource_glfw_reference_mouse_buttons.md\":\"DFayKu9B\",\"resource_glfw_reference_native.md\":\"Cv4ORS24\",\"resource_glfw_reference_standard_cursor_shapes.md\":\"BN7FAm27\",\"resource_glfw_reference_vulkan.md\":\"C7obmlsx\",\"resource_glfw_reference_window.md\":\"DEN-DRUr\",\"resource_glfw_tutorial_index.md\":\"tAH5-ZXH\",\"resource_imgui_backends.md\":\"CONeZDIY\",\"resource_imgui_changelog.md\":\"DRZlqaXR\",\"resource_imgui_contributing.md\":\"CcOG2M-s\",\"resource_imgui_examples.md\":\"Cl4WlzUJ\",\"resource_imgui_faq.md\":\"D5oYnMuS\",\"resource_imgui_fonts.md\":\"DtP2yKJf\",\"resource_imgui_imgui_h.md\":\"BbC53Gyx\",\"resource_imgui_index.md\":\"BTj7hJ3N\",\"resource_imgui_todo.md\":\"CMh0Kfwq\",\"resource_lua_5.1_manual.md\":\"ChxbQ7M7\",\"resource_lua_5.2_manual.md\":\"DMKRra8x\",\"resource_lua_5.3_manual.md\":\"BRNPbYmv\",\"resource_lua_5.4_manual.md\":\"DFTHuobI\",\"resource_lua_authors.md\":\"BBKwOqSe\",\"resource_lua_community.md\":\"RBzId1Lw\",\"resource_lua_contact.md\":\"HgjekHgt\",\"resource_lua_demo.md\":\"DbmfNoJh\",\"resource_lua_documentation.md\":\"CInczg1M\",\"resource_lua_download.md\":\"Iv9eQv3m\",\"resource_lua_faq.md\":\"DmCxPsTc\",\"resource_lua_getting_started.md\":\"CaDZHmNO\",\"resource_lua_index.md\":\"C0frSB-0\",\"resource_lua_license.md\":\"CaZNiFnf\",\"resource_lua_news.md\":\"Dsyzvlsc\",\"resource_lua_press.md\":\"kx0k1flo\",\"resource_lua_quotes.md\":\"DL8RHjPt\",\"resource_lua_reference_manual.md\":\"BvGGDbhT\",\"resource_lua_showcase.md\":\"RZNvnBzM\",\"resource_lua_thanks.md\":\"D0UDVNK5\",\"resource_lua_uses.md\":\"Iig03JuQ\",\"resource_lua_versions.md\":\"DS71r7z9\",\"resource_luajit_download.md\":\"LFPmJKOn\",\"resource_luajit_extensions.md\":\"0Z2MjPn5\",\"resource_luajit_faq.md\":\"fxLOm-YD\",\"resource_luajit_ffi_api.md\":\"CPvo2Gc7\",\"resource_luajit_ffi_library.md\":\"n7SvBkeM\",\"resource_luajit_ffi_semantics.md\":\"CpcxI580\",\"resource_luajit_ffi_tutorial.md\":\"DyJxtrlv\",\"resource_luajit_index.md\":\"DORNnUd3\",\"resource_luajit_installation.md\":\"BCvVOvJK\",\"resource_luajit_jit_library.md\":\"CkIMHBF2\",\"resource_luajit_lua_c_api.md\":\"C4Bx5wXQ\",\"resource_luajit_luajit.md\":\"hPuXHBmw\",\"resource_luajit_mailing_list.md\":\"CX28yIdd\",\"resource_luajit_profiler.md\":\"Brv2ffKL\",\"resource_luajit_running.md\":\"emR08Sjy\",\"resource_luajit_sponsors.md\":\"CdUtG_Ue\",\"resource_luajit_status.md\":\"CGLAJv9Q\",\"resource_luajit_string_buffers.md\":\"BIxnBdC8\",\"resource_skia_how_to_build_skia.md\":\"Bdf0UKPA\",\"resource_skia_how_to_download_skia.md\":\"O2sGvqcr\",\"resource_skia_index.md\":\"Du0Jd9Y3\",\"resource_skia_skia_build_gn.md\":\"BwtiOueF\",\"resource_skia_skia_gn_buildconfig_gn.md\":\"CFb4Bvf4\",\"resource_skia_skia_gn_skia_build_gn.md\":\"CA_P69HY\",\"resource_skia_skia_gn_skia_gni.md\":\"BWklKsjY\",\"resource_skia_skia_gn_toolchain_build_gn.md\":\"Pwwavn4T\",\"resource_terra_about.md\":\"Bd2hjlot\",\"resource_terra_api.md\":\"CcAXz862\",\"resource_terra_community.md\":\"D3pAGLao\",\"resource_terra_getting-started.md\":\"DmyOMLOP\",\"resource_terra_index.md\":\"C8F3-9Gn\",\"resource_terra_publications.md\":\"BcH2teRI\",\"resource_terra_terraforcpp.md\":\"Doz2LZHS\",\"tutorial_index.md\":\"X0ZXaXQ-\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"ja\",\"dir\":\"ltr\",\"title\":\"RaiaEngine\",\"description\":\"WebAPI-compatible framework for building apps that run in native environments.\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"search\":{\"provider\":\"local\"},\"editLink\":{\"pattern\":\"https://github.com/raia-engine/raia-document/edit/main/docs/:path\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/dolphilia/raia\"}],\"nav\":[{\"text\":\"ホーム\",\"link\":\"/\"},{\"text\":\"チュートリアル\",\"link\":\"/tutorial/\"},{\"text\":\"ドキュメント\",\"link\":\"/document\"},{\"text\":\"リファレンス\",\"items\":[{\"text\":\"LuaJITライブラリ\",\"link\":\"/reference/built_in/\"},{\"text\":\"Lua/Cライブラリ\",\"link\":\"/reference/lua_c/\"}]},{\"text\":\"リソース\",\"items\":[{\"text\":\"GLFW\",\"link\":\"/resource/glfw/\"},{\"text\":\"ImGui\",\"link\":\"/resource/imgui/\"},{\"text\":\"Lua\",\"link\":\"/resource/lua/\"},{\"text\":\"LuaJIT\",\"link\":\"/resource/luajit/\"},{\"text\":\"Skia\",\"link\":\"/resource/skia/\"},{\"text\":\"Terra\",\"link\":\"/resource/terra/\"}]},{\"text\":\"ダウンロード\",\"link\":\"/download/\"}],\"sidebar\":{\"/download/\":[{\"text\":\"ダウンロード\",\"items\":[{\"text\":\"はじめに\",\"link\":\"/download/\"}]}],\"/usage/\":[{\"text\":\"使い方\",\"collapsed\":false,\"items\":[{\"text\":\"はじめに\",\"link\":\"/usage/\"},{\"text\":\"インストールとセットアップ\",\"link\":\"/usage/setup\"}]},{\"text\":\"チュートリアル\",\"collapsed\":false,\"items\":[{\"text\":\"Windows編\",\"collapsed\":false,\"items\":[{\"text\":\"Hello World\",\"link\":\"/usage/tutorial/windows/helloworld\"},{\"text\":\"図形を描画する\",\"link\":\"/usage/tutorial/windows/shape\"},{\"text\":\"画像を表示する\",\"link\":\"/usage/tutorial/windows/image\"},{\"text\":\"サーフェスに描画する\",\"link\":\"/usage/tutorial/windows/surface\"},{\"text\":\"メインループを使う\",\"link\":\"/usage/tutorial/windows/mainloop\"},{\"text\":\"入力を検知する\",\"link\":\"/usage/tutorial/windows/input\"}]},{\"text\":\"macOS編\",\"link\":\"/usage/tutorial/macos/\"},{\"text\":\"Linux編\",\"link\":\"/usage/tutorial/linux/\"}]}],\"/reference/built_in\":[{\"text\":\"はじめに\",\"collapsed\":false,\"items\":[{\"text\":\"LuaJITライブラリ\",\"link\":\"/reference/built_in/\"}]},{\"text\":\"グローバル変数\",\"collapsed\":true,\"items\":[{\"text\":\"_G\",\"link\":\"/reference/built_in/global/_g.md\"},{\"text\":\"_VERSION\",\"link\":\"/reference/built_in/global/_version.md\"}]},{\"text\":\"基本関数\",\"collapsed\":true,\"items\":[{\"text\":\"assert\",\"link\":\"/reference/built_in/std/assert.md\"},{\"text\":\"collectgarbage\",\"link\":\"/reference/built_in/std/collectgarbage.md\"},{\"text\":\"dofile\",\"link\":\"/reference/built_in/std/dofile.md\"},{\"text\":\"error\",\"link\":\"/reference/built_in/std/error.md\"},{\"text\":\"getfenv\",\"link\":\"/reference/built_in/std/getfenv.md\"},{\"text\":\"getmetatable\",\"link\":\"/reference/built_in/std/getmetatable.md\"},{\"text\":\"ipairs\",\"link\":\"/reference/built_in/std/ipairs.md\"},{\"text\":\"load\",\"link\":\"/reference/built_in/std/load.md\"},{\"text\":\"loadfile\",\"link\":\"/reference/built_in/std/loadfile.md\"},{\"text\":\"loadstring\",\"link\":\"/reference/built_in/std/loadstring.md\"},{\"text\":\"next\",\"link\":\"/reference/built_in/std/next.md\"},{\"text\":\"pairs\",\"link\":\"/reference/built_in/std/pairs.md\"},{\"text\":\"pcall\",\"link\":\"/reference/built_in/std/pcall.md\"},{\"text\":\"print\",\"link\":\"/reference/built_in/std/print.md\"},{\"text\":\"rawequal\",\"link\":\"/reference/built_in/std/rawequal.md\"},{\"text\":\"rawget\",\"link\":\"/reference/built_in/std/rawget.md\"},{\"text\":\"rawset\",\"link\":\"/reference/built_in/std/rawset.md\"},{\"text\":\"select\",\"link\":\"/reference/built_in/std/select.md\"},{\"text\":\"setfenv\",\"link\":\"/reference/built_in/std/setfenv.md\"},{\"text\":\"setmetatable\",\"link\":\"/reference/built_in/std/setmetatable.md\"},{\"text\":\"tonumber\",\"link\":\"/reference/built_in/std/tonumber.md\"},{\"text\":\"tostring\",\"link\":\"/reference/built_in/std/tostring.md\"},{\"text\":\"type\",\"link\":\"/reference/built_in/std/type.md\"},{\"text\":\"unpack\",\"link\":\"/reference/built_in/std/unpack.md\"},{\"text\":\"xpcall\",\"link\":\"/reference/built_in/std/xpcall.md\"}]},{\"text\":\"コルーチン操作\",\"collapsed\":true,\"items\":[{\"text\":\"coroutine.create\",\"link\":\"/reference/built_in/coroutine/create.md\"},{\"text\":\"coroutine.resume\",\"link\":\"/reference/built_in/coroutine/resume.md\"},{\"text\":\"coroutine.running\",\"link\":\"/reference/built_in/coroutine/running.md\"},{\"text\":\"coroutine.status\",\"link\":\"/reference/built_in/coroutine/status.md\"},{\"text\":\"coroutine.wrap\",\"link\":\"/reference/built_in/coroutine/wrap.md\"},{\"text\":\"coroutine.yield\",\"link\":\"/reference/built_in/coroutine/yield.md\"},{\"text\":\"coroutine.isyieldable\",\"link\":\"/reference/built_in/coroutine/isyieldable.md\"}]},{\"text\":\"モジュール\",\"collapsed\":true,\"items\":[{\"text\":\"module\",\"link\":\"/reference/built_in/package/module.md\"},{\"text\":\"require\",\"link\":\"/reference/built_in/package/require.md\"},{\"text\":\"package.cpath\",\"link\":\"/reference/built_in/package/cpath.md\"},{\"text\":\"package.loaded\",\"link\":\"/reference/built_in/package/loaded.md\"},{\"text\":\"package.loaders\",\"link\":\"/reference/built_in/package/loaders.md\"},{\"text\":\"package.loadlib\",\"link\":\"/reference/built_in/package/loadlib.md\"},{\"text\":\"package.path\",\"link\":\"/reference/built_in/package/path.md\"},{\"text\":\"package.preload\",\"link\":\"/reference/built_in/package/preload.md\"},{\"text\":\"package.seeall\",\"link\":\"/reference/built_in/package/seeall.md\"},{\"text\":\"package.searchpath\",\"link\":\"/reference/built_in/package/searchpath.md\"}]},{\"text\":\"文字列操作\",\"collapsed\":true,\"items\":[{\"text\":\"string.byte\",\"link\":\"/reference/built_in/string/byte.md\"},{\"text\":\"string.char\",\"link\":\"/reference/built_in/string/char.md\"},{\"text\":\"string.dump\",\"link\":\"/reference/built_in/string/dump.md\"},{\"text\":\"string.find\",\"link\":\"/reference/built_in/string/find.md\"},{\"text\":\"string.format\",\"link\":\"/reference/built_in/string/format.md\"},{\"text\":\"string.gmatch\",\"link\":\"/reference/built_in/string/gmatch.md\"},{\"text\":\"string.gsub\",\"link\":\"/reference/built_in/string/gsub.md\"},{\"text\":\"string.len\",\"link\":\"/reference/built_in/string/len.md\"},{\"text\":\"string.lower\",\"link\":\"/reference/built_in/string/lower.md\"},{\"text\":\"string.match\",\"link\":\"/reference/built_in/string/match.md\"},{\"text\":\"string.rep\",\"link\":\"/reference/built_in/string/rep.md\"},{\"text\":\"string.reverse\",\"link\":\"/reference/built_in/string/reverse.md\"},{\"text\":\"string.sub\",\"link\":\"/reference/built_in/string/sub.md\"},{\"text\":\"string.upper\",\"link\":\"/reference/built_in/string/upper.md\"}]},{\"text\":\"テーブル操作\",\"collapsed\":true,\"items\":[{\"text\":\"table.concat\",\"link\":\"/reference/built_in/table/concat.md\"},{\"text\":\"table.insert\",\"link\":\"/reference/built_in/table/insert.md\"},{\"text\":\"table.maxn\",\"link\":\"/reference/built_in/table/maxn.md\"},{\"text\":\"table.remove\",\"link\":\"/reference/built_in/table/remove.md\"},{\"text\":\"table.sort\",\"link\":\"/reference/built_in/table/sort.md\"},{\"text\":\"table.new\",\"link\":\"/reference/built_in/table/new.md\"},{\"text\":\"table.clear\",\"link\":\"/reference/built_in/table/clear.md\"},{\"text\":\"table.move\",\"link\":\"/reference/built_in/table/move.md\"}]},{\"text\":\"数学関数\",\"collapsed\":true,\"items\":[{\"text\":\"math.abs\",\"link\":\"/reference/built_in/math/abs.md\"},{\"text\":\"math.acos\",\"link\":\"/reference/built_in/math/acos.md\"},{\"text\":\"math.asin\",\"link\":\"/reference/built_in/math/asin.md\"},{\"text\":\"math.atan\",\"link\":\"/reference/built_in/math/atan.md\"},{\"text\":\"math.atan2\",\"link\":\"/reference/built_in/math/atan2.md\"},{\"text\":\"math.ceil\",\"link\":\"/reference/built_in/math/ceil.md\"},{\"text\":\"math.cos\",\"link\":\"/reference/built_in/math/cos.md\"},{\"text\":\"math.cosh\",\"link\":\"/reference/built_in/math/cosh.md\"},{\"text\":\"math.deg\",\"link\":\"/reference/built_in/math/deg.md\"},{\"text\":\"math.exp\",\"link\":\"/reference/built_in/math/exp.md\"},{\"text\":\"math.floor\",\"link\":\"/reference/built_in/math/floor.md\"},{\"text\":\"math.fmod\",\"link\":\"/reference/built_in/math/fmod.md\"},{\"text\":\"math.frexp\",\"link\":\"/reference/built_in/math/frexp.md\"},{\"text\":\"math.huge\",\"link\":\"/reference/built_in/math/huge.md\"},{\"text\":\"math.ldexp\",\"link\":\"/reference/built_in/math/ldexp.md\"},{\"text\":\"math.log\",\"link\":\"/reference/built_in/math/log.md\"},{\"text\":\"math.log10\",\"link\":\"/reference/built_in/math/log10.md\"},{\"text\":\"math.max\",\"link\":\"/reference/built_in/math/max.md\"},{\"text\":\"math.min\",\"link\":\"/reference/built_in/math/min.md\"},{\"text\":\"math.modf\",\"link\":\"/reference/built_in/math/modf.md\"},{\"text\":\"math.pi\",\"link\":\"/reference/built_in/math/pi.md\"},{\"text\":\"math.pow\",\"link\":\"/reference/built_in/math/pow.md\"},{\"text\":\"math.rad\",\"link\":\"/reference/built_in/math/rad.md\"},{\"text\":\"math.random\",\"link\":\"/reference/built_in/math/random.md\"},{\"text\":\"math.randomseed\",\"link\":\"/reference/built_in/math/randomseed.md\"},{\"text\":\"math.sin\",\"link\":\"/reference/built_in/math/sin.md\"},{\"text\":\"math.sinh\",\"link\":\"/reference/built_in/math/sinh.md\"},{\"text\":\"math.sqrt\",\"link\":\"/reference/built_in/math/sqrt.md\"},{\"text\":\"math.tan\",\"link\":\"/reference/built_in/math/tan.md\"},{\"text\":\"math.tanh\",\"link\":\"/reference/built_in/math/tanh.md\"}]},{\"text\":\"入出力機能\",\"collapsed\":true,\"items\":[{\"text\":\"io.close\",\"link\":\"/reference/built_in/io/close.md\"},{\"text\":\"io.flush\",\"link\":\"/reference/built_in/io/flush.md\"},{\"text\":\"io.input\",\"link\":\"/reference/built_in/io/input.md\"},{\"text\":\"io.lines\",\"link\":\"/reference/built_in/io/lines.md\"},{\"text\":\"io.open\",\"link\":\"/reference/built_in/io/open.md\"},{\"text\":\"io.output\",\"link\":\"/reference/built_in/io/output.md\"},{\"text\":\"io.popen\",\"link\":\"/reference/built_in/io/popen.md\"},{\"text\":\"io.read\",\"link\":\"/reference/built_in/io/read.md\"},{\"text\":\"io.tmpfile\",\"link\":\"/reference/built_in/io/tmpfile.md\"},{\"text\":\"io.type\",\"link\":\"/reference/built_in/io/type.md\"},{\"text\":\"io.write\",\"link\":\"/reference/built_in/io/write.md\"},{\"text\":\"file:close\",\"link\":\"/reference/built_in/io/file_close.md\"},{\"text\":\"file:flush\",\"link\":\"/reference/built_in/io/file_flush.md\"},{\"text\":\"file:lines\",\"link\":\"/reference/built_in/io/file_lines.md\"},{\"text\":\"file:read\",\"link\":\"/reference/built_in/io/file_read.md\"},{\"text\":\"file:seek\",\"link\":\"/reference/built_in/io/file_seek.md\"},{\"text\":\"file:setvbuf\",\"link\":\"/reference/built_in/io/file_setvbuf.md\"},{\"text\":\"file:write\",\"link\":\"/reference/built_in/io/file_write.md\"}]},{\"text\":\"OSの機能\",\"collapsed\":true,\"items\":[{\"text\":\"os.clock\",\"link\":\"/reference/built_in/os/clock.md\"},{\"text\":\"os.date\",\"link\":\"/reference/built_in/os/date.md\"},{\"text\":\"os.difftime\",\"link\":\"/reference/built_in/os/difftime.md\"},{\"text\":\"os.execute\",\"link\":\"/reference/built_in/os/execute.md\"},{\"text\":\"os.exit\",\"link\":\"/reference/built_in/os/exit.md\"},{\"text\":\"os.getenv\",\"link\":\"/reference/built_in/os/getenv.md\"},{\"text\":\"os.remove\",\"link\":\"/reference/built_in/os/remove.md\"},{\"text\":\"os.rename\",\"link\":\"/reference/built_in/os/rename.md\"},{\"text\":\"os.setlocale\",\"link\":\"/reference/built_in/os/setlocale.md\"},{\"text\":\"os.time\",\"link\":\"/reference/built_in/os/time.md\"},{\"text\":\"os.tmpname\",\"link\":\"/reference/built_in/os/tmpname.md\"}]},{\"text\":\"デバッグ機能\",\"collapsed\":true,\"items\":[{\"text\":\"debug.debug\",\"link\":\"/reference/built_in/debug/debug.md\"},{\"text\":\"debug.getfenv\",\"link\":\"/reference/built_in/debug/getfenv.md\"},{\"text\":\"debug.gethook\",\"link\":\"/reference/built_in/debug/gethook.md\"},{\"text\":\"debug.getinfo\",\"link\":\"/reference/built_in/debug/getinfo.md\"},{\"text\":\"debug.getlocal\",\"link\":\"/reference/built_in/debug/getlocal.md\"},{\"text\":\"debug.getmetatable\",\"link\":\"/reference/built_in/debug/getmetatable.md\"},{\"text\":\"debug.getregistry\",\"link\":\"/reference/built_in/debug/getregistry.md\"},{\"text\":\"debug.getupvalue\",\"link\":\"/reference/built_in/debug/getupvalue.md\"},{\"text\":\"debug.setfenv\",\"link\":\"/reference/built_in/debug/setfenv.md\"},{\"text\":\"debug.sethook\",\"link\":\"/reference/built_in/debug/sethook.md\"},{\"text\":\"debug.setlocal\",\"link\":\"/reference/built_in/debug/setlocal.md\"},{\"text\":\"debug.setmetatable\",\"link\":\"/reference/built_in/debug/setmetatable.md\"},{\"text\":\"debug.setupvalue\",\"link\":\"/reference/built_in/debug/setupvalue.md\"},{\"text\":\"debug.traceback\",\"link\":\"/reference/built_in/debug/traceback.md\"},{\"text\":\"debug.upvalueid\",\"link\":\"/reference/built_in/debug/upvalueid.md\"},{\"text\":\"debug.upvaluejoin\",\"link\":\"/reference/built_in/debug/upvaluejoin.md\"}]},{\"text\":\"ビット操作\",\"collapsed\":true,\"items\":[{\"text\":\"bit.tobit\",\"link\":\"/reference/built_in/bit/tobit.md\"},{\"text\":\"bit.tohex\",\"link\":\"/reference/built_in/bit/tohex.md\"},{\"text\":\"bit.bnot\",\"link\":\"/reference/built_in/bit/bnot.md\"},{\"text\":\"bit.band\",\"link\":\"/reference/built_in/bit/band.md\"},{\"text\":\"bit.bor\",\"link\":\"/reference/built_in/bit/bor.md\"},{\"text\":\"bit.bxor\",\"link\":\"/reference/built_in/bit/bxor.md\"},{\"text\":\"bit.lshift\",\"link\":\"/reference/built_in/bit/lshift.md\"},{\"text\":\"bit.rshift\",\"link\":\"/reference/built_in/bit/rshift.md\"},{\"text\":\"bit.arshift\",\"link\":\"/reference/built_in/bit/arshift.md\"},{\"text\":\"bit.rol\",\"link\":\"/reference/built_in/bit/rol.md\"},{\"text\":\"bit.ror\",\"link\":\"/reference/built_in/bit/ror.md\"},{\"text\":\"bit.bswap\",\"link\":\"/reference/built_in/bit/bswap.md\"}]},{\"text\":\"FFI\",\"collapsed\":true,\"items\":[{\"text\":\"ffi.os\",\"link\":\"/reference/built_in/ffi/os.md\"},{\"text\":\"ffi.arch\",\"link\":\"/reference/built_in/ffi/arch.md\"},{\"text\":\"ffi.cdef\",\"link\":\"/reference/built_in/ffi/cdef.md\"},{\"text\":\"ffi.C\",\"link\":\"/reference/built_in/ffi/c.md\"},{\"text\":\"ffi.load\",\"link\":\"/reference/built_in/ffi/load.md\"},{\"text\":\"ffi.new\",\"link\":\"/reference/built_in/ffi/new.md\"},{\"text\":\"ctype\",\"link\":\"/reference/built_in/ffi/ctype.md\"},{\"text\":\"ffi.typeof\",\"link\":\"/reference/built_in/ffi/typeof.md\"},{\"text\":\"ffi.cast\",\"link\":\"/reference/built_in/ffi/cast.md\"},{\"text\":\"ffi.metatype\",\"link\":\"/reference/built_in/ffi/metatype.md\"},{\"text\":\"ffi.gc\",\"link\":\"/reference/built_in/ffi/gc.md\"},{\"text\":\"ffi.sizeof\",\"link\":\"/reference/built_in/ffi/sizeof.md\"},{\"text\":\"ffi.alignof\",\"link\":\"/reference/built_in/ffi/alignof.md\"},{\"text\":\"ffi.offsetof\",\"link\":\"/reference/built_in/ffi/offsetof.md\"},{\"text\":\"ffi.errno\",\"link\":\"/reference/built_in/ffi/errno.md\"},{\"text\":\"ffi.string\",\"link\":\"/reference/built_in/ffi/string.md\"},{\"text\":\"ffi.copy\",\"link\":\"/reference/built_in/ffi/copy.md\"},{\"text\":\"ffi.fill\",\"link\":\"/reference/built_in/ffi/fill.md\"},{\"text\":\"ffi.abi\",\"link\":\"/reference/built_in/ffi/abi.md\"},{\"text\":\"cb:free\",\"link\":\"/reference/built_in/ffi/cb_free.md\"},{\"text\":\"cb:set\",\"link\":\"/reference/built_in/ffi/cb_set.md\"}]},{\"text\":\"文字列バッファ\",\"collapsed\":true,\"items\":[{\"text\":\"buffer.new\",\"link\":\"/reference/built_in/string_buffer/new.md\"},{\"text\":\"buf:reset\",\"link\":\"/reference/built_in/string_buffer/buf_reset.md\"},{\"text\":\"buf:free\",\"link\":\"/reference/built_in/string_buffer/buf_free.md\"},{\"text\":\"buf:put\",\"link\":\"/reference/built_in/string_buffer/buf_put.md\"},{\"text\":\"buf:putf\",\"link\":\"/reference/built_in/string_buffer/buf_putf.md\"},{\"text\":\"buf:putcdata\",\"link\":\"/reference/built_in/string_buffer/buf_putcdata.md\"},{\"text\":\"buf:set\",\"link\":\"/reference/built_in/string_buffer/buf_set.md\"},{\"text\":\"buf:reserve\",\"link\":\"/reference/built_in/string_buffer/buf_reserve.md\"},{\"text\":\"buf:skip\",\"link\":\"/reference/built_in/string_buffer/buf_skip.md\"},{\"text\":\"buf:get\",\"link\":\"/reference/built_in/string_buffer/buf_get.md\"},{\"text\":\"buf:tostring\",\"link\":\"/reference/built_in/string_buffer/buf_tostring.md\"},{\"text\":\"buf:ref\",\"link\":\"/reference/built_in/string_buffer/buf_ref.md\"},{\"text\":\"buffer.encode\",\"link\":\"/reference/built_in/string_buffer/encode.md\"},{\"text\":\"buffer.decode\",\"link\":\"/reference/built_in/string_buffer/decode.md\"}]},{\"text\":\"JIT\",\"collapsed\":true,\"items\":[{\"text\":\"jit.version\",\"link\":\"/reference/built_in/jit/version.md\"},{\"text\":\"jit.version_num\",\"link\":\"/reference/built_in/jit/version_num.md\"},{\"text\":\"jit.os\",\"link\":\"/reference/built_in/jit/os.md\"},{\"text\":\"jit.arch\",\"link\":\"/reference/built_in/jit/arch.md\"},{\"text\":\"jit.on\",\"link\":\"/reference/built_in/jit/on.md\"},{\"text\":\"jit.off\",\"link\":\"/reference/built_in/jit/off.md\"},{\"text\":\"jit.flush\",\"link\":\"/reference/built_in/jit/flush.md\"},{\"text\":\"jit.status\",\"link\":\"/reference/built_in/jit/status.md\"}]}],\"/reference/lua_c\":[{\"text\":\"はじめに\",\"collapsed\":false,\"items\":[{\"text\":\"Lua/Cライブラリ\",\"link\":\"/reference/lua_c/\"}]}],\"/api/\":[{\"text\":\"API\",\"items\":[{\"text\":\"はじめに\",\"link\":\"/api/\"}]}],\"/resource/glfw/\":[{\"text\":\"GLFW\",\"collapsed\":false,\"items\":[{\"text\":\"はじめに\",\"link\":\"/resource/glfw/\"},{\"text\":\"イントロダクション\",\"link\":\"/resource/glfw/introduction.md\"},{\"text\":\"チュートリアル\",\"link\":\"/resource/glfw/tutorial/\"}]},{\"text\":\"プログラミングガイド\",\"collapsed\":false,\"items\":[{\"text\":\"API入門\",\"link\":\"/resource/glfw/guides/introduction_to_the_api.md\"},{\"text\":\"ウィンドウガイド\",\"link\":\"/resource/glfw/guides/window_guide.md\"},{\"text\":\"コンテキストガイド\",\"link\":\"/resource/glfw/guides/context_guide.md\"},{\"text\":\"モニターガイド\",\"link\":\"/resource/glfw/guides/monitor_guide.md\"},{\"text\":\"入力ガイド\",\"link\":\"/resource/glfw/guides/input_guide.md\"}]},{\"text\":\"リファレンス\",\"collapsed\":false,\"items\":[{\"text\":\"目次\",\"link\":\"/resource/glfw/reference/\"},{\"text\":\"コンテキスト\",\"link\":\"/resource/glfw/reference/context.md\"},{\"text\":\"初期化など\",\"link\":\"/resource/glfw/reference/init.md\"},{\"text\":\"エラーコード\",\"link\":\"/resource/glfw/reference/error.md\"},{\"text\":\"入力\",\"link\":\"/resource/glfw/reference/input.md\"},{\"text\":\"ゲームパッドの軸\",\"link\":\"/resource/glfw/reference/gamepad_axes.md\"},{\"text\":\"ゲームパッドのボタン\",\"link\":\"/resource/glfw/reference/gamepad_buttons.md\"},{\"text\":\"ジョイスティックのハット\",\"link\":\"/resource/glfw/reference/joystick_hat_states.md\"},{\"text\":\"ジョイスティック\",\"link\":\"/resource/glfw/reference/joysticks.md\"},{\"text\":\"キーボードのキー\",\"link\":\"/resource/glfw/reference/keyboard_keys.md\"},{\"text\":\"修飾キー\",\"link\":\"/resource/glfw/reference/modifier_key_flags.md\"},{\"text\":\"マウスボタン\",\"link\":\"/resource/glfw/reference/mouse_buttons.md\"},{\"text\":\"カーソルの形状\",\"link\":\"/resource/glfw/reference/standard_cursor_shapes.md\"},{\"text\":\"モニター\",\"link\":\"/resource/glfw/reference/monitor.md\"},{\"text\":\"ネイティブアクセス\",\"link\":\"/resource/glfw/reference/native.md\"},{\"text\":\"Vulkanサポート\",\"link\":\"/resource/glfw/reference/vulkan.md\"},{\"text\":\"ウィンドウ\",\"link\":\"/resource/glfw/reference/window.md\"}]}],\"/resource/imgui/\":[{\"text\":\"はじめに\",\"collapsed\":false,\"items\":[{\"text\":\"ImGUI\",\"link\":\"/resource/imgui/\"}]},{\"text\":\"ドキュメント\",\"collapsed\":false,\"items\":[{\"text\":\"バックエンド\",\"link\":\"/resource/imgui/backends.md\"},{\"text\":\"更新履歴\",\"link\":\"/resource/imgui/changelog.md\"},{\"text\":\"貢献する\",\"link\":\"/resource/imgui/contributing.md\"},{\"text\":\"サンプルコード\",\"link\":\"/resource/imgui/examples.md\"},{\"text\":\"よくある質問\",\"link\":\"/resource/imgui/faq.md\"},{\"text\":\"フォント\",\"link\":\"/resource/imgui/fonts.md\"},{\"text\":\"ToDo\",\"link\":\"/resource/imgui/todo.md\"}]},{\"text\":\"ヘッダーファイル\",\"collapsed\":false,\"items\":[{\"text\":\"imgui.h\",\"link\":\"/resource/imgui/imgui_h.md\"}]}],\"/resource/lua/\":[{\"text\":\"はじめに\",\"collapsed\":false,\"items\":[{\"text\":\"Luaについて\",\"link\":\"/resource/lua/\"},{\"text\":\"お問い合わせ\",\"link\":\"/resource/lua/contact\"}]},{\"text\":\"Luaの紹介\",\"collapsed\":false,\"items\":[{\"text\":\"ニュース\",\"link\":\"/resource/lua/news\"},{\"text\":\"ショーケース\",\"link\":\"/resource/lua/showcase\"},{\"text\":\"活用事例\",\"link\":\"/resource/lua/uses\"},{\"text\":\"引用集\",\"link\":\"/resource/lua/quotes\"},{\"text\":\"プレス記事\",\"link\":\"/resource/lua/press\"},{\"text\":\"開発者\",\"link\":\"/resource/lua/authors\"},{\"text\":\"謝辞\",\"link\":\"/resource/lua/thanks\"}]},{\"text\":\"ダウンロード\",\"collapsed\":false,\"items\":[{\"text\":\"ダウンロード\",\"link\":\"/resource/lua/download\"},{\"text\":\"ライセンス\",\"link\":\"/resource/lua/license\"},{\"text\":\"デモ\",\"link\":\"/resource/lua/demo\"}]},{\"text\":\"ドキュメント\",\"collapsed\":false,\"items\":[{\"text\":\"ドキュメント\",\"link\":\"/resource/lua/documentation\"},{\"text\":\"はじめに\",\"link\":\"/resource/lua/getting_started\"},{\"text\":\"リファレンス\",\"collapsed\":false,\"items\":[{\"text\":\"リファレンス\",\"link\":\"/resource/lua/reference_manual\"},{\"text\":\"5.4 マニュアル\",\"link\":\"/resource/lua/5.4_manual\"},{\"text\":\"5.3 マニュアル\",\"link\":\"/resource/lua/5.3_manual\"},{\"text\":\"5.2 マニュアル\",\"link\":\"/resource/lua/5.2_manual\"},{\"text\":\"5.1 マニュアル\",\"link\":\"/resource/lua/5.1_manual\"}]},{\"text\":\"FAQ\",\"link\":\"/resource/lua/faq\"},{\"text\":\"バージョン履歴\",\"link\":\"/resource/lua/versions\"}]},{\"text\":\"コミュニティ\",\"collapsed\":false,\"items\":[{\"text\":\"コミュニティ\",\"link\":\"/resource/lua/community\"}]}],\"/resource/luajit/\":[{\"text\":\"LuaJIT\",\"collapsed\":false,\"items\":[{\"text\":\"ホーム\",\"link\":\"/resource/luajit/\"},{\"text\":\"LuaJIT\",\"link\":\"/resource/luajit/luajit\"},{\"text\":\"ダウンロード\",\"link\":\"/resource/luajit/download\"},{\"text\":\"インストール\",\"link\":\"/resource/luajit/installation\"},{\"text\":\"実行する\",\"link\":\"/resource/luajit/running\"},{\"text\":\"拡張機能\",\"link\":\"/resource/luajit/extensions\"},{\"text\":\"FFIライブラリ\",\"link\":\"/resource/luajit/ffi_library\"},{\"text\":\"FFIチュートリアル\",\"link\":\"/resource/luajit/ffi_tutorial\"},{\"text\":\"ffi.* API\",\"link\":\"/resource/luajit/ffi_api\"},{\"text\":\"FFIセマンティクス\",\"link\":\"/resource/luajit/ffi_semantics\"},{\"text\":\"String Buffers\",\"link\":\"/resource/luajit/string_buffers\"},{\"text\":\"jit.* Library\",\"link\":\"/resource/luajit/jit_library\"},{\"text\":\"Lua/C API\",\"link\":\"/resource/luajit/lua_c_api\"},{\"text\":\"プロファイラ\",\"link\":\"/resource/luajit/profiler\"},{\"text\":\"ステータス\",\"link\":\"/resource/luajit/status\"},{\"text\":\"FAQ\",\"link\":\"/resource/luajit/faq\"},{\"text\":\"メーリングリスト\",\"link\":\"/resource/luajit/mailing_list\"},{\"text\":\"スポンサー\",\"link\":\"/resource/luajit/sponsors\"}]}],\"/resource/skia/\":[{\"text\":\"Skia\",\"collapsed\":false,\"items\":[{\"text\":\"はじめに\",\"link\":\"/resource/skia/\"},{\"text\":\"Skiaのダウンロード方法\",\"link\":\"/resource/skia/how_to_download_skia.md\"},{\"text\":\"Skiaのビルド方法\",\"link\":\"/resource/skia/how_to_build_skia.md\"},{\"text\":\"skia/BUILD.gn\",\"link\":\"/resource/skia/skia_build_gn.md\"},{\"text\":\"skia/gn/BUILDCONFIG.gn\",\"link\":\"/resource/skia/skia_gn_buildconfig_gn.md\"},{\"text\":\"skia/gn/skia.gni\",\"link\":\"/resource/skia/skia_gn_skia_gni.md\"},{\"text\":\"skia/gn/skia/BUILD.gn\",\"link\":\"/resource/skia/skia_gn_skia_build_gn.md\"},{\"text\":\"skia/gn/toolchain/BUILD.gn\",\"link\":\"/resource/skia/skia_gn_toolchain_build_gn.md\"}]}],\"/resource/terra/\":[{\"text\":\"Terra\",\"collapsed\":false,\"items\":[{\"text\":\"トップ\",\"link\":\"/resource/terra/\"},{\"text\":\"はじめに\",\"link\":\"/resource/terra/getting-started.md\"},{\"text\":\"APIリファレンス\",\"link\":\"/resource/terra/api.md\"},{\"text\":\"Terra for C++\",\"link\":\"/resource/terra/terraforcpp.md\"},{\"text\":\"出版物\",\"link\":\"/resource/terra/publications.md\"},{\"text\":\"コミュニティ\",\"link\":\"/resource/terra/community.md\"}]}]}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>