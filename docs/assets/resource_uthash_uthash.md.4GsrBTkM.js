import{_ as i,c as a,a2 as n,o as h}from"./chunks/framework.DPuwY6B9.js";const g=JSON.parse('{"title":"uthash ユーザーガイド","description":"","frontmatter":{},"headers":[],"relativePath":"resource/uthash/uthash.md","filePath":"resource/uthash/uthash.md","lastUpdated":1732350347000}'),t={name:"resource/uthash/uthash.md"};function l(k,s,p,e,E,d){return h(),a("div",null,s[0]||(s[0]=[n(`<h1 id="uthash-ユーザーガイド" tabindex="-1">uthash ユーザーガイド <a class="header-anchor" href="#uthash-ユーザーガイド" aria-label="Permalink to &quot;uthash ユーザーガイド&quot;">​</a></h1><ul><li>Troy D. Hanson, Arthur O&#39;Dwyer</li><li>version 2.3.0, February 2021</li></ul><p>uthashをダウンロードするには、このリンクをたどってGitHubのプロジェクトページに戻ってください。私の他のプロジェクトに戻る。</p><nav class="table-of-contents"><ul><li><a href="#cのハッシュ">Cのハッシュ</a><ul><li><a href="#どんなことができるのでしょうか">どんなことができるのでしょうか？</a></li><li><a href="#速いですか">速いですか？</a></li><li><a href="#ライブラリなのでしょうか">ライブラリなのでしょうか？</a></li><li><a href="#c-c-とプラットフォーム">C/C++とプラットフォーム</a></li><li><a href="#bsdライセンス">BSDライセンス</a></li><li><a href="#uthashのダウンロード">uthashのダウンロード</a></li><li><a href="#ヘルプを受ける">ヘルプを受ける</a></li><li><a href="#貢献度">貢献度</a></li><li><a href="#エクストラを含む">エクストラを含む</a></li><li><a href="#沿革">沿革</a></li></ul></li><li><a href="#あなたの構造">あなたの構造</a><ul><li><a href="#キーとなる">キーとなる</a></li><li><a href="#ハッシュハンドル">ハッシュハンドル</a></li><li><a href="#メモリについて一言">メモリについて一言</a></li></ul></li><li><a href="#ハッシュ演算">ハッシュ演算</a><ul><li><a href="#ハッシュを宣言する">ハッシュを宣言する</a></li><li><a href="#項目を追加する">項目を追加する</a></li><li><a href="#アイテム置換">アイテム置換</a></li><li><a href="#アイテムを探す">アイテムを探す</a></li><li><a href="#項目を削除する">項目を削除する</a></li><li><a href="#count-items">Count items</a></li><li><a href="#反復処理と並べ替え">反復処理と並べ替え</a></li><li><a href="#完全な例">完全な例</a></li></ul></li><li><a href="#標準的なキータイプ">標準的なキータイプ</a><ul><li><a href="#整数キー">整数キー</a></li><li><a href="#文字列キー">文字列キー</a></li><li><a href="#ポインターキー">ポインターキー</a></li><li><a href="#構造キー">構造キー</a></li></ul></li><li><a href="#アドバンスド・トピックス">アドバンスド・トピックス</a><ul><li><a href="#複合キー">複合キー</a></li><li><a href="#多階層ハッシュテーブル">多階層ハッシュテーブル</a></li><li><a href="#複数のハッシュテーブルの中の項目">複数のハッシュテーブルの中の項目</a></li><li><a href="#複数のキーを持つアイテム">複数のキーを持つアイテム</a></li><li><a href="#新規アイテムのソート挿入">新規アイテムのソート挿入</a></li><li><a href="#数種類のソート順">数種類のソート順</a></li><li><a href="#ブルームフィルタ-高速ミス">ブルームフィルタ(高速ミス)</a></li><li><a href="#選択">選択</a></li><li><a href="#代替キー比較機能を指定する">代替キー比較機能を指定する</a></li><li><a href="#ハッシュ関数内蔵">ハッシュ関数内蔵</a></li><li><a href="#hashscan">hashscan</a></li><li><a href="#拡張インターナル">拡張インターナル</a></li><li><a href="#フック類">フック類</a></li><li><a href="#デバッグモード">デバッグモード</a></li><li><a href="#スレッドの安全性">スレッドの安全性</a></li></ul></li><li><a href="#マクロリファレンス">マクロリファレンス</a><ul><li><a href="#便利なマクロ">便利なマクロ</a></li><li><a href="#一般的なマクロ">一般的なマクロ</a></li></ul></li></ul></nav><h2 id="cのハッシュ" tabindex="-1">Cのハッシュ <a class="header-anchor" href="#cのハッシュ" aria-label="Permalink to &quot;Cのハッシュ&quot;">​</a></h2><p>この文書はC言語プログラマー向けに書かれています。これを読んでいるあなたは、ハッシュがキーで項目を検索するために使われることを知っている可能性があります。スクリプト言語では、ハッシュや「辞書」は常に使用されています。C言語では、ハッシュは言語自体に存在しません。本ソフトウェアは、C言語の構造体に対してハッシュテーブルを提供します。</p><h3 id="どんなことができるのでしょうか" tabindex="-1">どんなことができるのでしょうか？ <a class="header-anchor" href="#どんなことができるのでしょうか" aria-label="Permalink to &quot;どんなことができるのでしょうか？&quot;">​</a></h3><p>本ソフトウェアは、ハッシュテーブル内の項目に対する以下の操作をサポートしています。:</p><ol><li>add/replace</li><li>find</li><li>delete</li><li>count</li><li>iterate</li><li>sort</li></ol><h3 id="速いですか" tabindex="-1">速いですか？ <a class="header-anchor" href="#速いですか" aria-label="Permalink to &quot;速いですか？&quot;">​</a></h3><p>追加、検索、削除は通常、一定時間の操作です。これは、キードメインとハッシュ関数に影響されます。</p><p>このハッシュは、ミニマムで効率的なハッシュを目指しています。マクロで実装されているため、自動的にインライン化されます。ハッシュ関数がキーに適している限りは高速です。デフォルトのハッシュ関数を使うこともできますし、他のいくつかの組み込みハッシュ関数の中から性能を簡単に比較して選ぶこともできます。</p><h3 id="ライブラリなのでしょうか" tabindex="-1">ライブラリなのでしょうか？ <a class="header-anchor" href="#ライブラリなのでしょうか" aria-label="Permalink to &quot;ライブラリなのでしょうか？&quot;">​</a></h3><p>いいえ、uthash.hという1つのヘッダーファイルだけです。このヘッダーファイルをあなたのプロジェクトにコピーするだけです：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span></code></pre></div><p>uthashはヘッダーファイルのみなので、リンクするためのライブラリコードは存在しません。</p><h3 id="c-c-とプラットフォーム" tabindex="-1">C/C++とプラットフォーム <a class="header-anchor" href="#c-c-とプラットフォーム" aria-label="Permalink to &quot;C/C++とプラットフォーム&quot;">​</a></h3><p>本ソフトウェアは、CおよびC++プログラムで使用することができます。でテスト済みです。:</p><ul><li>Linux</li><li>Windows using Visual Studio 2008 and 2010</li><li>Solaris</li><li>OpenBSD</li><li>FreeBSD</li><li>Android</li></ul><h4 id="test-suite" tabindex="-1">Test suite <a class="header-anchor" href="#test-suite" aria-label="Permalink to &quot;Test suite&quot;">​</a></h4><p>テストスイートを実行するには、testsディレクトリに入ります。そして</p><ul><li>Unixプラットフォームでは、makeを実行してください。</li><li>Windowsの場合は、「do_tests_win32.cmd」バッチファイルを実行します。(Visual Studioが標準的でない場所にインストールされている場合は、バッチファイルを編集することができます)。</li></ul><h3 id="bsdライセンス" tabindex="-1">BSDライセンス <a class="header-anchor" href="#bsdライセンス" aria-label="Permalink to &quot;BSDライセンス&quot;">​</a></h3><p>本ソフトウェアは、改訂版BSDライセンスで提供されています。フリーでオープンソースです。</p><h3 id="uthashのダウンロード" tabindex="-1">uthashのダウンロード <a class="header-anchor" href="#uthashのダウンロード" aria-label="Permalink to &quot;uthashのダウンロード&quot;">​</a></h3><p><a href="https://github.com/troydhanson/uthash" target="_blank" rel="noreferrer">https://github.com/troydhanson/uthash</a> のリンクに従って、uthash をクローンするか、ZIP ファイルを入手してください。</p><h3 id="ヘルプを受ける" tabindex="-1">ヘルプを受ける <a class="header-anchor" href="#ヘルプを受ける" aria-label="Permalink to &quot;ヘルプを受ける&quot;">​</a></h3><p>ご質問は、uthash Google Groupをご利用ください。uthash@googlegroups.com にメールしてください。</p><h3 id="貢献度" tabindex="-1">貢献度 <a class="header-anchor" href="#貢献度" aria-label="Permalink to &quot;貢献度&quot;">​</a></h3><p>GitHubを通じてプルリクエストを提出することができます。しかし、uthashのメンテナンス担当者は、ベルやホイッスルを追加するのではなく、uthashを変更しないことを大切にしています。</p><h3 id="エクストラを含む" tabindex="-1">エクストラを含む <a class="header-anchor" href="#エクストラを含む" aria-label="Permalink to &quot;エクストラを含む&quot;">​</a></h3><p>uthashには3つの「エクストラ」が付属しています。これらはリスト、動的配列、文字列を提供します。:</p><ul><li>utlist.h は、C 言語の構造体に対するリンクリストマクロを提供します。</li><li>utarray.hはマクロを使った動的配列の実装です。</li><li>utstring.hは、基本的な動的文字列を実装しています。</li></ul><h3 id="沿革" tabindex="-1">沿革 <a class="header-anchor" href="#沿革" aria-label="Permalink to &quot;沿革&quot;">​</a></h3><p>私は2004年から2006年にかけて、私自身の目的のためにuthashを書きました。もともとはSourceForgeでホストされていました。uthashは2006年から2013年の間に約30,000回ダウンロードされ、その後GitHubに移行しました。商用ソフトウェア、学術研究、そして他のオープンソースソフトウェアに組み込まれました。また、多くのUnix系ディストロのネイティブパッケージリポジトリに追加されました。</p><p>uthashが書かれた当時は、C言語で汎用的なハッシュテーブルを作成するためのオプションは、現在よりも少なかったです。より高速なハッシュテーブル、よりメモリ効率の良いハッシュテーブル、そして全く異なるAPIが存在するのが現状です。しかし、ミニバンを運転するように、uthashは便利で、多くの用途で仕事をこなすことができます。</p><p>2016年7月現在、uthashはArthur O&#39;Dwyerによってメンテナンスされています。</p><h2 id="あなたの構造" tabindex="-1">あなたの構造 <a class="header-anchor" href="#あなたの構造" aria-label="Permalink to &quot;あなたの構造&quot;">​</a></h2><p>uthashでは、ハッシュテーブルは構造体で構成されています。各構造体は、キーと値の関連性を表す。構造体の1つ以上のフィールドがキーを構成する。構造体のポインタそのものが値である。</p><p>ハッシュ化可能な構造を定義する:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    /* キー */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* この構造体をハッシャブルにする */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>uthashでは、ハッシュテーブルに構造体を追加しても、構造体が別の場所に移動したりコピーされたりすることはない。つまり、ハッシュテーブルに構造体を追加したり削除したりしても、その構造体を安全に指す他のデータ構造を保持することができるのです。</p><h3 id="キーとなる" tabindex="-1">キーとなる <a class="header-anchor" href="#キーとなる" aria-label="Permalink to &quot;キーとなる&quot;">​</a></h3><p>キーフィールドのデータ型や名称は特に制限されない。また、キーは、任意の名称とデータ型を持つ、連続した複数のフィールドで構成することができる。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>どんなデータ型でも...本当に？</p><p>はい、キーと構造体はどのようなデータ型でもかまいません。プロトタイプが固定された関数呼び出しとは異なり、uthashはマクロで構成され、その引数は型付けされていませんので、どんなタイプの構造体やキーでも扱うことができます。</p></div><h4 id="ユニークなキー" tabindex="-1">ユニークなキー <a class="header-anchor" href="#ユニークなキー" aria-label="Permalink to &quot;ユニークなキー&quot;">​</a></h4><p>どのハッシュでもそうですが、すべての項目は一意のキーを持たなければなりません。アプリケーションはキーの一意性を強制しなければなりません。ハッシュテーブルに項目を追加する前に、まずそのキーがすでに使用されていないことを確認する必要があります（疑問があれば、確認してください！）。ハッシュテーブルにキーが既に存在するかどうかは、HASH_FINDを使って確認することができます。</p><h3 id="ハッシュハンドル" tabindex="-1">ハッシュハンドル <a class="header-anchor" href="#ハッシュハンドル" aria-label="Permalink to &quot;ハッシュハンドル&quot;">​</a></h3><p>UT_hash_handleフィールドは、構造体の中に存在しなければなりません。これは、ハッシュを機能させるための内部帳簿に使用されます。初期化は必要ありません。このフィールドにはどんな名前でもつけられますが、hhという名前をつけることで問題を単純化することができます。これにより、アイテムの追加、検索、削除に、より簡単な「コンビニエンス」マクロを使用することができます。</p><h3 id="メモリについて一言" tabindex="-1">メモリについて一言 <a class="header-anchor" href="#メモリについて一言" aria-label="Permalink to &quot;メモリについて一言&quot;">​</a></h3><h4 id="オーバーヘッド" tabindex="-1">オーバーヘッド <a class="header-anchor" href="#オーバーヘッド" aria-label="Permalink to &quot;オーバーヘッド&quot;">​</a></h4><p>ハッシュハンドルは、32ビットシステムで1項目あたり約32バイト、64ビットシステムで1項目あたり56バイトを消費する。バケットとテーブルという他のオーバーヘッド費用は、それに比べればごくわずかなものです。HASH_OVERHEADを使用すると、ハッシュテーブルのオーバーヘッドサイズをバイト単位で取得することができます。マクロリファレンス」を参照してください。</p><h4 id="クリーンアップの発生方法" tabindex="-1">クリーンアップの発生方法 <a class="header-anchor" href="#クリーンアップの発生方法" aria-label="Permalink to &quot;クリーンアップの発生方法&quot;">​</a></h4><p>uthashはどうやって内部メモリを整理しているのか、という質問がありました。答えは簡単です。ハッシュテーブルから最後の項目を削除すると、uthashはそのハッシュテーブルに関連するすべての内部メモリを解放し、そのポインタをNULLに設定します。</p><h2 id="ハッシュ演算" tabindex="-1">ハッシュ演算 <a class="header-anchor" href="#ハッシュ演算" aria-label="Permalink to &quot;ハッシュ演算&quot;">​</a></h2><p>ここでは、uthashのマクロを例によって紹介します。より簡潔な一覧は、マクロリファレンスを参照してください。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>便利なマクロと一般的なマクロの比較：</p><p>uthashのマクロは2つのカテゴリに分類されます。便利なマクロは、整数、ポインタ、文字列のキーで使用できます（UT_hash_handleフィールドには、従来の名前hhを選択する必要があります）。便利なマクロは一般的なマクロよりも少ない引数を取るので、これらの一般的なタイプのキーでは使い方が少し単純になります。</p><p>一般的なマクロは、あらゆるタイプのキー、マルチフィールドキー、UT_hash_handleの名前がhh以外のものである場合に使用できます。これらのマクロはより多くの引数を取り、より柔軟な見返りを提供します。しかし、もし便利なマクロがあなたのニーズに合っているならば、それを使ってください--あなたのコードはより読みやすくなるでしょう。</p></div><h3 id="ハッシュを宣言する" tabindex="-1">ハッシュを宣言する <a class="header-anchor" href="#ハッシュを宣言する" aria-label="Permalink to &quot;ハッシュを宣言する&quot;">​</a></h3><p>ハッシュは、構造体へのNULL初期化ポインタとして宣言する必要があります。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 重要！NULLに初期化する */</span></span></code></pre></div><h3 id="項目を追加する" tabindex="-1">項目を追加する <a class="header-anchor" href="#項目を追加する" aria-label="Permalink to &quot;項目を追加する&quot;">​</a></h3><p>適当に構造体を割り当てて初期化する。uthashにとって重要なのは、キーが一意な値で初期化されていなければならないという点だけです。次にHASH_ADDを呼び出します（ここでは、int型のキーに対して簡便に使用できる便利なマクロHASH_ADD_INTを使用します）。</p><h4 id="ハッシュに項目を追加する" tabindex="-1">ハッシュに項目を追加する <a class="header-anchor" href="#ハッシュに項目を追加する" aria-label="Permalink to &quot;ハッシュに項目を追加する&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name, name);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ADD_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* id: キーフィールドの名前 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>HASH_ADD_INTの第1パラメータはハッシュテーブルで、第2パラメータはキーフィールドの名前です。ここでは、idとなっています。最後のパラメータは、追加される構造体へのポインタである。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>待てよ、パラメータはフィールド名なのか？</p><p>構造体のフィールド名であるidがパラメータとして渡されることに違和感を覚えたなら...マクロの世界へようこそ。心配しないでください。Cプリプロセッサーはこれを有効なCコードに展開します。</p></div><h4 id="使用中に鍵が変更されないようにすること" tabindex="-1">使用中に鍵が変更されないようにすること <a class="header-anchor" href="#使用中に鍵が変更されないようにすること" aria-label="Permalink to &quot;使用中に鍵が変更されないようにすること&quot;">​</a></h4><p>構造体がハッシュに追加された後は、そのキーの値を変更しないでください。代わりに、ハッシュからその項目を削除し、キーを変更してから、再度追加する。</p><h4 id="独自性の確認" tabindex="-1">独自性の確認 <a class="header-anchor" href="#独自性の確認" aria-label="Permalink to &quot;独自性の確認&quot;">​</a></h4><p>上の例では、user_idがすでにハッシュ内の既存のアイテムのキーになっているかどうかをチェックしていません。もし、あなたのプログラムによって重複したキーが生成される可能性があるなら、キーをハッシュに追加する前に明示的に一意性をチェックする必要があります。キーがすでにハッシュ内にある場合は、項目を追加するのではなく、単にハッシュ内の既存の構造を変更すればよい。同じキーを持つ2つの項目をハッシュテーブルに追加するのはエラーです。</p><p>add_user関数を書き換えて、idがハッシュに存在するかどうかをチェックするようにしましょう。idがハッシュに存在しない場合のみ、アイテムを作成し、それを追加します。そうでない場合は、すでに存在する構造体を修正するだけです。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* idはすでにハッシュの中にあるのか？ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      s-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_ADD_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* id: キーフィールドの名前 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name, name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>なぜuthashは鍵の一意性をチェックしないのですか？例えば、キーがインクリメントされた非反復カウンタによって生成されるプログラムなど、ハッシュ検索を必要としないプログラムのために、ハッシュ検索のコストを節約するためです。</p><p>しかし、置換が一般的な操作であれば、HASH_REPLACEマクロを使用することが可能です。このマクロは、アイテムを追加する前に、同じキーを持つアイテムを見つけ、先にそれを削除しようとします。また、置換されたアイテムへのポインタを返すので、ユーザはそのメモリの割り当てを解除する機会があります。</p><h4 id="ハッシュポインタを関数に渡す" tabindex="-1">ハッシュポインタを関数に渡す <a class="header-anchor" href="#ハッシュポインタを関数に渡す" aria-label="Permalink to &quot;ハッシュポインタを関数に渡す&quot;">​</a></h4><p>上の例ではusersはグローバル変数ですが、呼び出し側がadd_user関数にハッシュポインタを渡したいと思ったらどうでしょうか。一見すると、usersを引数として渡せばいいように見えますが、それではうまくいきません。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* bad */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ADD_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, id, s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ハッシュポインタへのポインタを渡す必要があります。:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* good */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">**</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ADD_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users, id, s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>HASH_ADDでもポインタを再参照していることに注意してください。</p><p>ハッシュポインタのポインタを扱う必要がある理由は簡単で、ハッシュマクロがそれを変更するからです（言い換えれば、ポインタが指すものだけでなく、ポインタそのものを変更する）。</p><h3 id="アイテム置換" tabindex="-1">アイテム置換 <a class="header-anchor" href="#アイテム置換" aria-label="Permalink to &quot;アイテム置換&quot;">​</a></h3><p>HASH_REPLACEマクロはHASH_ADDマクロと同じですが、最初にアイテムを見つけて削除しようとする点が異なります。アイテムが見つかり削除された場合、そのアイテムのポインタを出力パラメータとして返します。</p><h3 id="アイテムを探す" tabindex="-1">アイテムを探す <a class="header-anchor" href="#アイテムを探す" aria-label="Permalink to &quot;アイテムを探す&quot;">​</a></h3><p>ハッシュの中の構造体を調べるには、そのキーが必要です。そして、HASH_FINDを呼び出します。(ここではint型のキーに対して便利なマクロHASH_FIND_INTを使用しています)。</p><h4 id="構造体のキーを使って構造体を探す" tabindex="-1">構造体のキーを使って構造体を探す <a class="header-anchor" href="#構造体のキーを使って構造体を探す" aria-label="Permalink to &quot;構造体のキーを使って構造体を探す&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* s：出力ポインタ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ここでは、ハッシュテーブルはusersで、&amp;user_idはキー（この場合は整数）を指しています。最後に、sはHASH_FIND_INTの出力変数である。最終的な結果は、sが与えられたキーを持つ構造体を指し、キーがハッシュで見つからなかった場合はNULLになります。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>中間の引数は、キーへのポインタです。HASH_FINDには、キーのリテラル値を渡すことはできません。代わりにリテラル値を変数に代入し、その変数へのポインタを渡します。</p></div><h3 id="項目を削除する" tabindex="-1">項目を削除する <a class="header-anchor" href="#項目を削除する" aria-label="Permalink to &quot;項目を削除する&quot;">​</a></h3><p>ハッシュから構造体を削除するには、その構造体へのポインタを持っている必要があります。(キーしか持っていない場合は、まずHASH_FINDを実行して構造体ポインタを取得します）。</p><h4 id="ハッシュから項目を削除する" tabindex="-1">ハッシュから項目を削除する <a class="header-anchor" href="#ハッシュから項目を削除する" aria-label="Permalink to &quot;ハッシュから項目を削除する&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delete_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* user: pointer to deletee */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* オプションで、あなた次第です！ */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ここでもusersはハッシュテーブルで、userはハッシュから削除したい構造体へのポインタである。</p><h4 id="uthashは構造体を解放することはありません" tabindex="-1">uthashは構造体を解放することはありません <a class="header-anchor" href="#uthashは構造体を解放することはありません" aria-label="Permalink to &quot;uthashは構造体を解放することはありません&quot;">​</a></h4><p>構造体を削除してもハッシュテーブルから削除されるだけで、解放されるわけではありません。いつ構造体を解放するかは完全にあなた次第です。uthashは決して構造体を解放しません。例えば、HASH_REPLACEマクロを使用する場合、ユーザが割り当てを解除できるようにするために、置き換えられた出力引数が返されます。</p><h4 id="deleteでポインターを変更することができます" tabindex="-1">Deleteでポインターを変更することができます <a class="header-anchor" href="#deleteでポインターを変更することができます" aria-label="Permalink to &quot;Deleteでポインターを変更することができます&quot;">​</a></h4><p>ハッシュテーブルのポインタ（最初はハッシュに追加された最初の項目を指す）は、HASH_DELに応答して（すなわち、ハッシュテーブルの最初の項目を削除した場合）変更することができます。</p><h4 id="繰り返し削除" tabindex="-1">繰り返し削除 <a class="header-anchor" href="#繰り返し削除" aria-label="Permalink to &quot;繰り返し削除&quot;">​</a></h4><p>HASH_ITERマクロは、単純なforループに展開される、削除しても安全な反復処理の構成要素です。</p><h4 id="ハッシュから全項目を削除する" tabindex="-1">ハッシュから全項目を削除する <a class="header-anchor" href="#ハッシュから全項目を削除する" aria-label="Permalink to &quot;ハッシュから全項目を削除する&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delete_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">current_user, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, current_user, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, current_user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* 削除、ユーザーは次へ進む */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current_user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* 任意-自由にしたい場合 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="一括削除" tabindex="-1">一括削除 <a class="header-anchor" href="#一括削除" aria-label="Permalink to &quot;一括削除&quot;">​</a></h4><p>もし、すべての項目を削除するだけで、解放や要素ごとのクリーンアップを行わないのであれば、1回の操作でより効率的に行うことができます：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_CLEAR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users);</span></span></code></pre></div><p>その後、リストの先頭（ここではusers）にNULLが設定されます。</p><h3 id="count-items" tabindex="-1">Count items <a class="header-anchor" href="#count-items" aria-label="Permalink to &quot;Count items&quot;">​</a></h3><p>ハッシュテーブルのアイテム数は、HASH_COUNTで取得できます：</p><h4 id="ハッシュテーブルの項目数" tabindex="-1">ハッシュテーブルの項目数 <a class="header-anchor" href="#ハッシュテーブルの項目数" aria-label="Permalink to &quot;ハッシュテーブルの項目数&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num_users;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">num_users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;there are </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, num_users);</span></span></code></pre></div><p>ちなみに、これはリストの先頭（ここではusers）がNULLでも動作し、その場合カウントは0になります。</p><h3 id="反復処理と並べ替え" tabindex="-1">反復処理と並べ替え <a class="header-anchor" href="#反復処理と並べ替え" aria-label="Permalink to &quot;反復処理と並べ替え&quot;">​</a></h3><p>ハッシュ内の項目は、先頭から始めてhh.nextポインタをたどることでループさせることができます。</p><h4 id="ハッシュの全項目に対する反復処理" tabindex="-1">ハッシュの全項目に対する反復処理 <a class="header-anchor" href="#ハッシュの全項目に対する反復処理" aria-label="Permalink to &quot;ハッシュの全項目に対する反復処理&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> print_users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users; s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s-&gt;hh.next) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user id </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: name </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s-&gt;id, s-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>また、hh.prevポインタを使えば、既知の項目からハッシュを逆行させることもできます。</p><h4 id="削除しても安全な反復処理" tabindex="-1">削除しても安全な反復処理 <a class="header-anchor" href="#削除しても安全な反復処理" aria-label="Permalink to &quot;削除しても安全な反復処理&quot;">​</a></h4><p>上の例では、forループの本体でsを削除して解放するのは安全ではありません（ループが反復するたびにsが再参照されるため）。これを正しく書き換えるのは簡単ですが（s-&gt;hh.nextポインタを一時変数にコピーしてからsを解放する）、削除しても安全な反復処理マクロHASH_ITERが含まれているため、頻繁に発生することなのです。これは、for-loopのヘッダに展開されます。このマクロを使用して、前回の例を書き直すと次のようになります：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, s, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user id </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: name </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s-&gt;id, s-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ...それは削除するために安全であり、無料のSはここにあります。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>ハッシュは二重リンクリストでもある。</p><p>hh.prevとhh.nextフィールドがあるため、ハッシュの項目を前後に反復することが可能です。ハッシュのすべての項目は、これらのポインタを繰り返したどることで到達できるため、ハッシュは二重リンクリストでもある。</p></div><p>C++のプログラムでuthashを使う場合、forイテレータに余分なキャストが必要です。例えば、<code>s = static_cast&lt;my_struct*&gt;(s-&gt;hh.next)</code> のように。</p><h4 id="ソート" tabindex="-1">ソート <a class="header-anchor" href="#ソート" aria-label="Permalink to &quot;ソート&quot;">​</a></h4><p>ハッシュの項目は、hh.nextポインタをたどると「挿入順」に訪問されます。HASH_SORTを使えば、項目を新しい順番に並べ替えることができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_SORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, name_sort);</span></span></code></pre></div><p>第2引数は、比較関数へのポインタである。この関数は、2つのポインタ引数（比較する項目）を受け取り、最初の項目が2番目の項目より前、等しい、または後にソートする場合、それぞれ0より小さい、0、または0より大きいintを返さなければならない。(これは、標準Cライブラリのstrcmpやqsortで使われているのと同じ規則である）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* compare a to b (cast a and b appropriately)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * return (int) -1 if (a &lt; b)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * return (int)  0 if (a == b)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   * return (int)  1 if (a &gt; b)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>以下、name_sortとid_sortがソート関数の例です。</p><h4 id="ハッシュ内の項目をソートする" tabindex="-1">ハッシュ内の項目をソートする <a class="header-anchor" href="#ハッシュ内の項目をソートする" aria-label="Permalink to &quot;ハッシュ内の項目をソートする&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> by_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> strcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a-&gt;name, b-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> by_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b-&gt;id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort_by_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_SORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, by_name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort_by_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_SORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, by_id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>ハッシュの項目がソートされるとき、最初の項目の位置が変わることがある。上の例では、HASH_SORTを呼び出した後、ユーザーが別の構造体を指すことがあります。</p><h3 id="完全な例" tabindex="-1">完全な例 <a class="header-anchor" href="#完全な例" aria-label="Permalink to &quot;完全な例&quot;">​</a></h3><p>すべてのコードを繰り返し、main()関数で装飾して、動作例を形成します。</p><p>このコードをuthash.hと同じディレクトリのexample.cというファイルに置くと、次のようにコンパイルして実行することができる：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.c</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./example</span></span></code></pre></div><p>プロンプトに従って、プログラムをお試しください。</p><h4 id="充実したプログラム" tabindex="-1">充実したプログラム <a class="header-anchor" href="#充実したプログラム" aria-label="Permalink to &quot;充実したプログラム&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* printf */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* atoi, malloc */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;string.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* strcpy */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    /* キー */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* この構造体をハッシャブルにする */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* idはすでにハッシュの中にあるのか？ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HASH_ADD_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* idはキーフィールド */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name, name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">find_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> user_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user_id, s);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* s：出力ポインタ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delete_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* user: pointer to deletee */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(user);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delete_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">current_user;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, current_user, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, current_user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* delete it (users advances to next) */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(current_user);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* free it */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> print_users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> users; s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)(s-&gt;hh.next)) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user id </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: name </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s-&gt;id, s-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> by_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> strcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a-&gt;name, b-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> by_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b-&gt;id);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">prompt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> buf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">21</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">? &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, prompt); </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fflush</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(stdout);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fgets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf), stdin);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> strchr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(buf, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        puts</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid input!&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        exit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(EXIT_FAILURE);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> buf;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> running </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> temp;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    while</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (running) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 1. add user</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 2. add or rename user by id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 3. find user</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 4. delete user</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 5. delete all users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 6. sort items by name</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 7. sort items by id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 8. print users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; 9. count users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;10. quit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atoi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Command&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Name (20 char max)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> atoi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                add_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(temp, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Name (20 char max)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atoi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ID to find&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s-&gt;name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;unknown&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atoi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ID to delete&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    delete_user</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                    printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id unknown</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                delete_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                HASH_SORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, by_name);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 7</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                HASH_SORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, by_id);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                print_users</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                temp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_COUNT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">                printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;there are </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> users</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, temp);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            case</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                running </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    delete_all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* free any structures */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>このプログラムは配布物のtests/example.cに含まれているので、そのディレクトリでmake exampleを実行すれば簡単にコンパイルすることができます。</p><h2 id="標準的なキータイプ" tabindex="-1">標準的なキータイプ <a class="header-anchor" href="#標準的なキータイプ" aria-label="Permalink to &quot;標準的なキータイプ&quot;">​</a></h2><p>このセクションでは、さまざまな種類のキーを使用する方法について詳しく説明します。整数、文字列、ポインタ、構造体など、ほとんどすべての種類のキーを使用することができます。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>フロートに関する注意点</p><p>浮動小数点キーを使用することができます。これには、浮動小数点数の等価性をテストするプログラムと同じ注意事項があります。つまり、2つの浮動小数点数のわずかな違いでも、別個のキーになるのです。</p></div><h3 id="整数キー" tabindex="-1">整数キー <a class="header-anchor" href="#整数キー" aria-label="Permalink to &quot;整数キー&quot;">​</a></h3><p>前述の例では、整数キーを使用することを示しました。要約すると、整数キーを持つ構造体には、便利なマクロHASH_ADD_INTとHASH_FIND_INTを使用します。(HASH_DELETEやHASH_SORTなどの他の操作は、すべてのタイプのキーに対して同じです）。</p><h3 id="文字列キー" tabindex="-1">文字列キー <a class="header-anchor" href="#文字列キー" aria-label="Permalink to &quot;文字列キー&quot;">​</a></h3><p>構造体に文字列のキーがある場合、構造体がキーを指すのか（<code>char *</code>）、文字列が構造体の中にあるのか（<code>char a[10]</code> ）によって、使用する演算が異なります。この区別は重要です。後述するように、構造体がキーを指している場合（つまり、キー自体が構造体の外にある場合）にはHASH_ADD_KEYPTRを使う必要があります。一方、構造体の中に含まれる文字列キーにはHASH_ADD_STRを使います。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p><code>char[ ]</code> vs. <code>char*</code></p><p>以下の最初の例では、文字列は構造体の中にあり、nameは<code>char[10]</code>フィールドである。2番目の例では、キーは構造体の外側にあり、nameは<code>char *</code>です。つまり、最初の例ではHASH_ADD_STRを使用しますが、2番目の例ではHASH_ADD_KEYPTRを使用します。このマクロに関する情報は、マクロのリファレンスを参照してください。</p></div><h4 id="構造体内文字列" tabindex="-1">構造体内文字列 <a class="header-anchor" href="#構造体内文字列" aria-label="Permalink to &quot;構造体内文字列&quot;">​</a></h4><p>文字列をキーとするハッシュ（構造体内文字列）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;string.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* strcpy */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* malloc */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* printf */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* キー（文字列は構造体の中にある） */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* この構造体をハッシャブルにする */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">names</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;joe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bob&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HASH_ADD_STR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, name, s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_STR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&#39;s id is </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s-&gt;id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ハッシュテーブルの内容を解放する */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, s, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, s);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この例は、配布物のtests/test15.cに含まれており、プリントされます：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>betty&#39;s id is 2</span></span></code></pre></div><h4 id="構造体内文字列ポインタ" tabindex="-1">構造体内文字列ポインタ <a class="header-anchor" href="#構造体内文字列ポインタ" aria-label="Permalink to &quot;構造体内文字列ポインタ&quot;">​</a></h4><p>さて、同じ例ですが、<code>char [ ]</code>の代わりに<code>char *</code>キーを使用しています：</p><p>文字列をキーとするハッシュ（構造体は文字列を指す）</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;string.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* strcpy */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* malloc */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* printf */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          /* キー */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* この構造体をハッシャブルにする */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">names</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;joe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bob&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i]; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s-&gt;name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> names</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[i];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        s-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        HASH_ADD_KEYPTR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, s-&gt;name, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name), s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND_STR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;betty&#39;s id is </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, s-&gt;id);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ハッシュテーブルの内容を解放する */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, users, s, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(users, s);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この例は、tests/test40.cに含まれています。</p><h3 id="ポインターキー" tabindex="-1">ポインターキー <a class="header-anchor" href="#ポインターキー" aria-label="Permalink to &quot;ポインターキー&quot;">​</a></h3><p>キーはポインタにすることができます。はっきり言って、これはポインタそのものがキーになり得ることを意味します（対照的に、指されたものがキーである場合、これはHASH_ADD_KEYPTRによって処理される別のユースケースとなります）。</p><p>ここでは、構造体がキーと呼ばれるポインタメンバを持つという単純な例を示します。</p><h4 id="ポインターキー-1" tabindex="-1">ポインターキー <a class="header-anchor" href="#ポインターキー-1" aria-label="Permalink to &quot;ポインターキー&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  UT_hash_handle hh;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">el_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">el_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">someaddr </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  el_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">d;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  el_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">el_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e-&gt;key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)someaddr;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e-&gt;i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ADD_PTR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hash, key, e);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_FIND_PTR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hash, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">someaddr, d);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (d) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;found</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* release memory */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hash, e);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この例はtests/test57.cに含まれています。プログラムの終了によってハッシュから要素が削除され、（ハッシュにはもう要素が残っていないので）uthashは内部メモリを解放していることに注意してください。</p><h3 id="構造キー" tabindex="-1">構造キー <a class="header-anchor" href="#構造キー" aria-label="Permalink to &quot;構造キー&quot;">​</a></h3><p>キーフィールドはどのようなデータ型でもかまいません。uthashにとっては、単なるバイト列です。したがって、ネストした構造体でもキーとして使用することができます。一般的なマクロであるHASH_ADDとHASH_FINDを使って、実演してみます。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>構造体にはパディング（構造体のメンバのアライメント要件を満たすために使用される無駄な内部空間）が含まれています。これらのパディングバイトは、ハッシュへの項目の追加や項目の検索を行う前にゼロにする必要があります。したがって、関心のあるメンバを設定する前に、常に構造体全体をゼロにする必要があります。以下の例では、memsetを2回呼び出すことでこれを実現しています。</p></div><h4 id="構造体であるキー" tabindex="-1">構造体であるキー <a class="header-anchor" href="#構造体であるキー" aria-label="Permalink to &quot;構造体であるキー&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_key_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    record_key_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> key;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ... other data ... */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    record_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> l, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">records </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    r-&gt;key.a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    r-&gt;key.b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, records, key, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_key_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), r);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">l, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    l.key.a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;a&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    l.key.b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, records, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">l.key, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">record_key_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), p);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (p) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;found </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%c</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> %d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, p-&gt;key.a, p-&gt;key.b);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, records, p, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(records, p);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(p);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この使い方は、後述する複合キーの使い方とほぼ同じです。</p><p>なお、一般的なマクロでは、第1引数にUT_hash_handleの名前を渡す必要があります（ここでは、hhです）。一般的なマクロは、マクロリファレンスに記載されています。</p><h2 id="アドバンスド・トピックス" tabindex="-1">アドバンスド・トピックス <a class="header-anchor" href="#アドバンスド・トピックス" aria-label="Permalink to &quot;アドバンスド・トピックス&quot;">​</a></h2><h3 id="複合キー" tabindex="-1">複合キー <a class="header-anchor" href="#複合キー" aria-label="Permalink to &quot;複合キー&quot;">​</a></h3><p>キーは、連続した複数のフィールドで構成することも可能です。</p><h4 id="マルチフィールドキー" tabindex="-1">マルチフィールドキー <a class="header-anchor" href="#マルチフィールドキー" aria-label="Permalink to &quot;マルチフィールドキー&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* malloc       */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stddef.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* offsetof     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     /* printf       */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;string.h&gt;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* memset       */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UTF32</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  UT_hash_handle hh;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> len;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encoding;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      /* these two fields */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* comprise the key */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encoding;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookup_key_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argv</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> keylen;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    msg_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msgs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    lookup_key_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lookup_key;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> beijing</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5317</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4eac</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* UTF-32LE for 北京 */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 構造体の確保と初期化 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> /* zero fill */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    msg-&gt;len </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    msg-&gt;encoding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UTF32;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg-&gt;text, beijing, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* パディングを含む鍵長を計算する。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    keylen </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, text)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       /* offset of last key field */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">             /* size of last key field */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             -</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">msg_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, encoding);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* offset of first key field */</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* ハッシュテーブルに構造体を追加する */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, msgs, encoding, keylen, msg);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* うまくいったかどうか調べてみてください :-) */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    msg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lookup_key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">lookup_key_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lookup_key) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memset</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lookup_key, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lookup_key) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    lookup_key-&gt;encoding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> UTF32;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    memcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lookup_key-&gt;text, beijing, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(beijing));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, msgs, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">lookup_key-&gt;encoding, keylen, msg);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;found </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(lookup_key);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, msgs, msg, tmp) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msgs, msg);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>この例は、配布物のtests/test22.cに含まれています。</p><p>マルチフィールドキーを使用する場合、コンパイラは各フィールドのアライメント要件を満たすために、隣接するフィールドをパディングする（未使用のスペースを間に挿入する）ことを認識してください。例えば、charの後にintが続く構造体では、intフィールドを4の倍数アドレス（4はintの長さ）で開始させるために、charの後に通常3バイトの「無駄な」パディングがあります。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>マルチフィールドキーの長さを計算する：</p><p>マルチフィールドキーを使用する場合、キー長を決定するために、コンパイラがアライメントのために追加する構造体パディングを含める必要があります。</p><p>鍵の長さを計算する簡単な方法は、<code>&lt;stddef.h&gt;</code>のoffsetofマクロを使用することです。計算式は以下の通りです：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">key length </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">   offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(last_key_field)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             +</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(last_key_field)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">             -</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> offsetof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(first_key_field)</span></span></code></pre></div><p>上の例では、この式で変数keylenが設定されます。</p></div><p>マルチフィールドキーを扱う場合、ハッシュテーブルにHASH_ADDする前、またはHASH_FINDキーでそのフィールドを使用する前に、構造体をゼロフィルする必要があります。</p><p>前の例では、memsetを使用して構造体をゼロ埋めして初期化しています。これは、キーフィールド間のパディングをゼロにするものです。もし、ゼロフィルを行わなかった場合、このパディングにはランダムな値が含まれることになります。このランダムな値は、HASH_FINDの失敗の原因になります。2つの「同じ」キーが、パディングに違いがあると、不一致に見えるからです。</p><p>また、グローバル鍵比較関数と鍵ハッシュ関数をカスタマイズして、鍵のパディングを無視することも可能です。代替のキー比較関数を指定する」を参照してください。</p><h3 id="多階層ハッシュテーブル" tabindex="-1">多階層ハッシュテーブル <a class="header-anchor" href="#多階層ハッシュテーブル" aria-label="Permalink to &quot;多階層ハッシュテーブル&quot;">​</a></h3><p>多階層ハッシュテーブルは、ハッシュテーブルの各要素がそれ自身の二次ハッシュテーブルを含む場合に発生します。レベルはいくつでも可能です。スクリプト言語では、次のように表示されることがあります：</p><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$items{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">bob</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">age</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">37</span></span></code></pre></div><p>以下のCプログラムは、この例をuthashで構築します。ハッシュテーブルをitemsと呼びます。ハッシュテーブルはitemsと呼ばれ、1つの要素（bob）を含み、そのハッシュテーブルには値37の要素（age）が1つ含まれています。多階層のハッシュテーブルを構築するために特別な関数は必要ない。</p><p>この例では、両レベル（ボブ、エイジ）を同じ構造で表現していますが、2つの異なる構造定義でも問題ありません。また、2つのレベルではなく、3つ以上のレベルがあっても問題ないでしょう。</p><h4 id="多階層ハッシュテーブル-1" tabindex="-1">多階層ハッシュテーブル <a class="header-anchor" href="#多階層ハッシュテーブル-1" aria-label="Permalink to &quot;多階層ハッシュテーブル&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;string.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* ハッシュのハッシュ */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sub;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> val;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  UT_hash_handle hh;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">item_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">items </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> argc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">argvp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  item_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item1, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item2, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp1, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tmp2;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* make initial element */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  item_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">i));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i-&gt;name, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bob&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  i-&gt;sub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  i-&gt;val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ADD_STR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(items, name, i);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* この要素からサブハッシュ・テーブルを追加する */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  item_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s-&gt;name, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;age&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s-&gt;sub </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  s-&gt;val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 37</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ADD_STR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i-&gt;sub, name, s);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* ハッシュの要素に対して反復処理を行う  */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, items, item1, tmp1) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, item1-&gt;sub, item2, tmp2) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$items{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} = </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, item1-&gt;name, item2-&gt;name, item2-&gt;val);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* 両方のハッシュテーブルをきれいにする */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, items, item1, tmp1) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ITER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, item1-&gt;sub, item2, tmp2) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item1-&gt;sub, item2);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item2);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(items, item1);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item1);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>上記の例は、tests/test59.cに含まれています。</p><h3 id="複数のハッシュテーブルの中の項目" tabindex="-1">複数のハッシュテーブルの中の項目 <a class="header-anchor" href="#複数のハッシュテーブルの中の項目" aria-label="Permalink to &quot;複数のハッシュテーブルの中の項目&quot;">​</a></h3><p>構造体は、複数のハッシュテーブルに追加することができます。このようなことをする理由はいくつかあります：</p><ul><li>各ハッシュテーブルは、異なるキーを使用することができる；</li><li>各ハッシュテーブルが独自のソート順を持つことができる；</li><li>あるいは、単にグループ化のために複数のハッシュテーブルを使用することもできます。例えば、admin_usersハッシュテーブルとusersハッシュテーブルでユーザーを持つことができます。</li></ul><p>構造体は、それが追加されるかもしれない各ハッシュテーブルのためのUT_hash_handleフィールドを持つ必要があります。それらにどんな名前をつけてもかまいません。例えば、次のようなものです、</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">UT_hash_handle hh1, hh2;</span></span></code></pre></div><h3 id="複数のキーを持つアイテム" tabindex="-1">複数のキーを持つアイテム <a class="header-anchor" href="#複数のキーを持つアイテム" aria-label="Permalink to &quot;複数のキーを持つアイテム&quot;">​</a></h3><p>IDフィールドをキーとするハッシュテーブルと、ユーザー名をキーとするハッシュテーブル（ユーザー名がユニークな場合）を作成することができます。両方のハッシュテーブルに同じユーザー構造を追加することで、（構造を重複させることなく）ユーザー名やIDでユーザー構造を参照することができます。これを実現する方法は、構造体を追加できる各ハッシュに対して、別々のUT_hash_handleを持つことです。</p><h4 id="_2種類のキーを持つ構造" tabindex="-1">2種類のキーを持つ構造 <a class="header-anchor" href="#_2種類のキーを持つ構造" aria-label="Permalink to &quot;2種類のキーを持つ構造&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    /* 第一キー */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">         /* セカンドキー */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh1;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* 最初のハッシュテーブルのためのハンドル */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh2;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        /* セカンドハッシュテーブルのハンドル */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>上の例では、この構造体を2つの別々のハッシュテーブルに追加することができるようになりました。一方のハッシュではidがキーとなり、もう一方のハッシュではusernameがキーとなります。(2つのハッシュが異なるキーフィールドを持つ必要はありません。idのような同じキーを使用することも可能です)。</p><p>この構造体には2つのハッシュハンドル（hh1、hh2）があることに注意してください。以下のコードでは、それぞれのハッシュハンドルが特定のハッシュテーブルと排他的に使用されることに注目してください。(hh1はusers_by_idハッシュで、hh2はusers_by_nameハッシュテーブルで常に使用されます)。</p><h4 id="構造上の2つのキー" tabindex="-1">構造上の2つのキー <a class="header-anchor" href="#構造上の2つのキー" aria-label="Permalink to &quot;構造上の2つのキー&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users_by_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users_by_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">s;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    strcpy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;thanson&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 両方のハッシュテーブルに構造体を追加する */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh1, users_by_id, id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), s);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_ADD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh2, users_by_name, username, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), s);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* users_by_id &quot;ハッシュテーブルからIDでユーザーを検索する。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh1, users_by_id, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">sizeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;found id </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, i, s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">username</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* users_by_nameハッシュテーブルからユーザー名を指定してユーザーを検索する。 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;thanson&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    HASH_FIND</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh2, users_by_name, name, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(name), s);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (s) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;found user </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, name, s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="新規アイテムのソート挿入" tabindex="-1">新規アイテムのソート挿入 <a class="header-anchor" href="#新規アイテムのソート挿入" aria-label="Permalink to &quot;新規アイテムのソート挿入&quot;">​</a></h3><p>ソートされたハッシュを維持したい場合、2つのオプションがあります。最初の選択肢は HASH_SRT() マクロを使うことで、順序のないリストを O(n log(n)) でソートできます。これは、ハッシュテーブルをランダムな順番で埋めていき、最終的にHASH_SRT()を1回実行するだけなら、最適な方法です。明らかに、項目を挿入する間にリストが順序付けられた状態になる必要がある場合、この方法は望んだものではありません。挿入操作のたびにHASH_SRT()を使うこともできますが、その場合、計算量はO(n^2 log n)となります。</p><p>2つ目の方法は、インオーダーアドとインオーダーリプレイスマクロを使う方法です。HASH_ADD_INORDER<em>マクロは、HASH_ADD</em>マクロと同様に動作しますが、比較関数の引数が追加されています：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name_sort</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> strcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a-&gt;name, b-&gt;name);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_ADD_KEYPTR_INORDER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh, items, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), item, name_sort);</span></span></code></pre></div><p>新しい項目は挿入時にO(n)でソートされるため、すべての項目を含むハッシュテーブルの作成にかかる総計算量はO(n^2)となる。インオーダーアドが機能するためには、新しいアイテムを挿入する前にリストが順序付けられた状態である必要があります。</p><h3 id="数種類のソート順" tabindex="-1">数種類のソート順 <a class="header-anchor" href="#数種類のソート順" aria-label="Permalink to &quot;数種類のソート順&quot;">​</a></h3><p>2つのハッシュテーブルが異なるソート順を持つことは驚くべきことではありませんが、この事実を有利に利用することで、同じ項目を複数の方法でソートすることも可能です。これは、ある構造を複数のハッシュテーブルに格納できることに基づいている。</p><p>先ほどの例を拡張して、多くのユーザがいるとします。各ユーザーの構造体をusers_by_idハッシュテーブルとusers_by_nameハッシュテーブルに追加しました。(繰り返しになりますが、これは各構造体のコピーを2つ持つ必要なく行われます)。次に、2つのソート関数を定義し、HASH_SRTを使用することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort_by_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b-&gt;id) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b-&gt;id) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> sort_by_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> my_struct </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> strcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a-&gt;username, b-&gt;username);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_SRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh1, users_by_id, sort_by_id);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_SRT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hh2, users_by_name, sort_by_name);</span></span></code></pre></div><p>users_by_idの項目はid順に、users_by_nameの項目はname順に、それぞれ反復処理されることになります。項目はそれぞれの順番で完全に前後方向にリンクされています。したがって、1つのユーザー・セットであっても、2つのハッシュ・テーブルに格納することで、2つの異なるソート順で容易に反復処理を行うことができます。</p><h3 id="ブルームフィルタ-高速ミス" tabindex="-1">ブルームフィルタ(高速ミス) <a class="header-anchor" href="#ブルームフィルタ-高速ミス" aria-label="Permalink to &quot;ブルームフィルタ(高速ミス)&quot;">​</a></h3><p>公平なミス率（HASH_FINDの結果がNULL）を生成するプログラムでは、組み込みのブルームフィルタのサポートが有効です。これは、ヒットだけを生成するプログラムでは、わずかなペナルティが発生するため、デフォルトでは無効になっています。また、削除を行うプログラムでは、ブルーム・フィルターを使用するべきではありません。このプログラムは正しく動作しますが、削除はフィルターの利点を減少させます。ブルーム・フィルターを有効にするには、-DHASH_BLOOM=nのようにコンパイルします：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>-DHASH_BLOOM=27</span></span></code></pre></div><p>ここで、数値は32までの任意の値で、下図のようにフィルターが使用するメモリ量を決定します。より多くのメモリを使用することで、フィルタの精度が向上し、ミスした場合の救済が早くなるため、プログラムの高速化につながる可能性があります。</p><h4 id="表1-ブルームフィルタのサイズ-nの値" tabindex="-1">表1.ブルームフィルタのサイズ（nの値 <a class="header-anchor" href="#表1-ブルームフィルタのサイズ-nの値" aria-label="Permalink to &quot;表1.ブルームフィルタのサイズ（nの値&quot;">​</a></h4><table tabindex="0"><thead><tr><th>n</th><th>ブルームフィルタのサイズ（ハッシュテーブルあたり）</th></tr></thead><tbody><tr><td>16</td><td>8 kilobytes</td></tr><tr><td>20</td><td>128 kilobytes</td></tr><tr><td>24</td><td>2 megabytes</td></tr><tr><td>28</td><td>32 megabytes</td></tr><tr><td>32</td><td>512 megabytes</td></tr></tbody></table><p>ブルームフィルタはあくまで性能のための機能であり、ハッシュ演算の結果を何ら変えるものではありません。ブルーム・フィルターがあなたのプログラムに適しているかどうかを判断する唯一の方法は、テストすることです。ブルーム・フィルターの大きさは、16～32ビットが妥当です。</p><h3 id="選択" tabindex="-1">選択 <a class="header-anchor" href="#選択" aria-label="Permalink to &quot;選択&quot;">​</a></h3><p>与えられた条件を満たすソースハッシュのアイテムをデスティネーションハッシュに挿入する実験的なselect操作が提供される。この挿入は、HASH_ADDを使用する場合よりもいくらか効率的に行われます。すなわち、選択された項目のキーに対してハッシュ関数が再計算されないためです。この操作では、ソースハッシュからアイテムが削除されることはない。むしろ、選択された項目は両方のハッシュで二重に存在するようになります。デスティネーションハッシュにはすでにアイテムが含まれているかもしれないが、選択されたアイテムはそれに追加される。構造体がHASH_SELECTで使用可能であるためには、2つ以上のハッシュハンドルを持つ必要があります。(ここで説明するように、構造体は同時に多くのハッシュテーブルに存在することができますが、それぞれに対して別々のハッシュハンドルを持たなければなりません）。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">users </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   /* hash table of users */</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">admins </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* hash table of admins */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">typedef</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle hh;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* handle for users hash */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    UT_hash_handle ah;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* handle for admins hash */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>ここで、ユーザーを追加し、idが1024未満の管理者ユーザーだけを選択したいとします。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is_admin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">x</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">user_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)x)-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_SELECT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ah, admins, hh, users, is_admin);</span></span></code></pre></div><p>最初の2つのパラメータは宛先ハッシュハンドルとハッシュテーブル、2番目の2つのパラメータは送信元ハッシュハンドルとハッシュテーブル、最後のパラメータは選択条件である。ここではマクロのis_admin(x)を使っていますが、関数を使っても同じように使えます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> is_admin</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">userv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  user_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">user </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> user_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)userv;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user-&gt;id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>選択条件が常に真と評価される場合、この操作は本質的にソースハッシュをデスティネーションハッシュにマージすることになる。</p><p>HASH_SELECTは、ソースから項目を削除することなく、デスティネーションに項目を追加するもので、ソースのハッシュテーブルは変更されません。デスティネーションハッシュテーブルはソースハッシュテーブルと同じであってはならない。</p><p>HASH_SELECTの使用例は、tests/test36.cに含まれています。</p><h3 id="代替キー比較機能を指定する" tabindex="-1">代替キー比較機能を指定する <a class="header-anchor" href="#代替キー比較機能を指定する" aria-label="Permalink to &quot;代替キー比較機能を指定する&quot;">​</a></h3><p>HASH_FIND(hh, head, intfield, sizeof(int), out)を呼び出すと、uthashはまずHASH_FUNCTION(intfield, sizeof(int), hashvalue)を呼び出して検索対象のバケットbを決定し、バケットbの要素eltごとにuthashがelt-&gt;hh.hashv == hashvalue &amp;&amp; elt.hh.keylen == sizeof(int) &amp;&amp; HASH_KEYCMP(intfield, elt-&gt;hh.key, sizeof(int)) == 0. HASH_KEYCMPは、eltが一致したので返すべきことを示す0、一致要素の検索を続けるべきことを示す非ゼロの値を返すべきです。</p><p>デフォルトでは、uthashはmemcmpのエイリアスとしてHASH_KEYCMPを定義しています。memcmpを提供しないプラットフォームでは、独自の実装で代用することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_KEYCMP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_KEYCMP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bcmp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a, b, len)</span></span></code></pre></div><p>Another reason to substitute your own key comparison function is if your &quot;key&quot; is not trivially comparable. In this case you will also need to substitute your own HASH_FUNCTION.</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    short</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* 2 bytes of padding */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* パディングバイトを比較しない; 浮動小数点数でmemcmpを使用しない */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> key_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">unsigned</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)f; }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> key_equal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a.s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b.s </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a.f </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b.f; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_FUNCTION</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">hashv</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (hashv) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> key_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)s)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_KEYCMP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">key_equal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)a, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)b))</span></span></code></pre></div><p>独自の鍵比較関数を代用するもう一つの理由は、正しさと実際の速度をトレードオフすることです。uthashはバケットを線形探索する際、常に32ビットハッシュvを最初に比較し、ハッシュvが等しい場合にのみHASH_KEYCMPを呼び出します。つまり、HASH_KEYCMPは検索に成功するごとに少なくとも1回は呼び出されることになります。優れたハッシュ関数があれば、hashvの比較で「偽陽性」となるのは40億回に1回だけと予想されます。したがって、HASH_KEYCMPはほとんどの場合、0を返すと予想されます。もし、多くの検索が成功することが予想され、アプリケーションが時折起こる誤検出を気にしないのであれば、私たちはノーオペレーションの比較関数を代用するかもしれません：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_KEYCMP</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> HASH_KEYCMP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">b</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  /* occasionally wrong, but very fast */</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>グローバルな等価比較関数HASH_KEYCMPは、HASH_ADD_INORDERのパラメータとして渡されるlessthan-comparison関数と全く関係がありません。</p></div><h3 id="ハッシュ関数内蔵" tabindex="-1">ハッシュ関数内蔵 <a class="header-anchor" href="#ハッシュ関数内蔵" aria-label="Permalink to &quot;ハッシュ関数内蔵&quot;">​</a></h3><p>内部的には、ハッシュ関数はキーをバケツ番号に変換する。現在Jenkinsのデフォルトのハッシュ関数を使うのに、何もする必要はありません。</p><p>プログラムによっては、内蔵のハッシュ関数のうち別のものを使用した方がよい場合があります。uthashには、他のハッシュ関数がより良いパフォーマンスをもたらすかどうかを判断するのに役立つ簡単な分析ユーティリティが付属しています。</p><p>プログラムをコンパイルする際に、-DHASH_FUNCTION=HASH_xyz（xyzは以下のシンボル名のいずれか）を指定すると、別のハッシュ関数を使用することができます。例．</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cc</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -DHASH_FUNCTION=HASH_BER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> program</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> program.c</span></span></code></pre></div><h4 id="表2-組み込みのハッシュ関数" tabindex="-1">表2.組み込みのハッシュ関数 <a class="header-anchor" href="#表2-組み込みのハッシュ関数" aria-label="Permalink to &quot;表2.組み込みのハッシュ関数&quot;">​</a></h4><table tabindex="0"><thead><tr><th>Symbol</th><th>Name</th></tr></thead><tbody><tr><td>JEN</td><td>Jenkins (default)</td></tr><tr><td>BER</td><td>Bernstein</td></tr><tr><td>SAX</td><td>シフトアドエックスオア</td></tr><tr><td>OAT</td><td>One-at-a-time</td></tr><tr><td>FNV</td><td>Fowler/Noll/Vo</td></tr><tr><td>SFH</td><td>Paul Hsieh</td></tr></tbody></table><h4 id="どのハッシュ関数が最適か" tabindex="-1">どのハッシュ関数が最適か？ <a class="header-anchor" href="#どのハッシュ関数が最適か" aria-label="Permalink to &quot;どのハッシュ関数が最適か？&quot;">​</a></h4><p>キードメインに最適なハッシュ関数を簡単に決定することができます。そのためには、データ収集パスでプログラムを一度実行し、収集したデータを付属の解析ユーティリティで実行する必要があります。</p><p>まず、解析ユーティリティを構築する必要があります。トップレベルのディレクトリから</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span></span></code></pre></div><p>ここでは、test14.cを使用して、データ収集と解析の手順を示します（ここでは、ファイルディスクリプタ3をファイルにリダイレクトするsh構文を使っています）：</p><h4 id="キースタットの使用" tabindex="-1">キースタットの使用 <a class="header-anchor" href="#キースタットの使用" aria-label="Permalink to &quot;キースタットの使用&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>% cc -DHASH_EMIT_KEYS=3 -I../src -o test14 test14.c</span></span>
<span class="line"><span>% ./test14 3&gt;test14.keys</span></span>
<span class="line"><span>% ./keystats test14.keys</span></span>
<span class="line"><span>fcn  ideal%     #items   #buckets  dup%  fl   add_usec  find_usec  del-all usec</span></span>
<span class="line"><span>---  ------ ---------- ---------- -----  -- ---------- ----------  ------------</span></span>
<span class="line"><span>SFH   91.6%       1219        256    0%  ok         92        131            25</span></span>
<span class="line"><span>FNV   90.3%       1219        512    0%  ok        107         97            31</span></span>
<span class="line"><span>SAX   88.7%       1219        512    0%  ok        111        109            32</span></span>
<span class="line"><span>OAT   87.2%       1219        256    0%  ok         99        138            26</span></span>
<span class="line"><span>JEN   86.7%       1219        256    0%  ok         87        130            27</span></span>
<span class="line"><span>BER   86.2%       1219        256    0%  ok        121        129            27</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>DHASH_EMIT_KEYS=3の3は、ファイルディスクリプタです。DHASH_EMIT_KEYS=xで有効になるデータ収集モードは、実運用コードでは使用しないでください。</p></div><p>通常、最初に表示されるハッシュ関数を選べばよい。ここでは、SFHです。これは、鍵の分布が最も均等になる関数である。もし複数の関数が同じideal%であれば、find_usecのカラムに従って最も速いものを選択する。</p><h4 id="キースタッツカラムリファレンス" tabindex="-1">キースタッツカラムリファレンス <a class="header-anchor" href="#キースタッツカラムリファレンス" aria-label="Permalink to &quot;キースタッツカラムリファレンス&quot;">​</a></h4><table tabindex="0"><thead><tr><th>name</th><th>description</th></tr></thead><tbody><tr><td>fcn</td><td>ハッシュ関数のシンボル名</td></tr><tr><td>ideal%</td><td>ハッシュテーブルの中で、理想的なステップ数で検索できる項目の割合です。(以下でさらに説明する)。</td></tr><tr><td>#items</td><td>発行された鍵ファイルから読み込まれた鍵の数</td></tr><tr><td>#buckets</td><td>すべてのキーが追加された後のハッシュのバケット数</td></tr><tr><td>dup%</td><td>生成された鍵ファイルに含まれる重複した鍵の割合。キーの一意性を保つために、重複したキーはフィルタリングされます。(重複は正常です。例えば、アプリケーションがハッシュに項目を追加し、それを削除して再度追加した場合、キーは放出されたファイルに2回書き込まれる)。</td></tr><tr><td>flags</td><td>はokか、あるいはExpansion internalsで説明した拡張禁止フラグが設定されている場合はnx（noexpand）です。noexpandフラグが設定されているハッシュ関数を使用することは推奨されません。</td></tr><tr><td>add_usec</td><td>ハッシュのすべてのキーを追加するのに必要なクロックタイム（マイクロ秒）。</td></tr><tr><td>find_usec</td><td>ハッシュのすべてのキーを検索するのに必要なクロックタイム（マイクロ秒）。</td></tr><tr><td>del-all usec</td><td>ハッシュの全項目を削除するのに必要な時計時間（マイクロ秒）。</td></tr></tbody></table><p>ideal%</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>ideal%とは何ですか？</p><p>ハッシュのn個のアイテムはk個のバケットに分配される。理想的には、各バケットはアイテムの等しいシェア（n/k）を含んでいる。言い換えれば、すべてのバケットが等しく使用されている場合、バケットチェーンにおける任意のアイテムの最大線形位置はn/kとなる。あるバケツが使いすぎ、他のバケツが使いにくい場合、使いすぎたバケツには、線形位置がn/kを超えるアイテムが含まれることになります。このようなアイテムは非理想的とみなされる。</p><p>ご想像の通り、ideal%はハッシュ中の理想的なアイテムの割合です。これらの項目は、バケットチェーンにおいて有利な線形位置を持っています。ideal%が100%に近づくと、ハッシュテーブルは定時間ルックアップの性能に近づきます。</p></div><h3 id="hashscan" tabindex="-1">hashscan <a class="header-anchor" href="#hashscan" aria-label="Permalink to &quot;hashscan&quot;">​</a></h3><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>このユーティリティは、Linux、およびFreeBSD（8.1以上）のみで利用可能です。</p></div><p>hashscanというユーティリティがtests/ディレクトリに含まれています。このディレクトリでmakeを実行すると、自動的にビルドされます。このツールは、実行中のプロセスを調査し、そのプログラムのメモリ内で見つけたuthashテーブルについて報告します。また、各テーブルのキーをkeystatsに入力できる形式で保存することもできる。</p><p>以下はhashscanの使用例です。まずビルドされていることを確認します：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span></span></code></pre></div><p>hashscanは検査するために実行中のプログラムが必要なので、ハッシュテーブルを作成し、スリープする簡単なプログラムをテスト対象として起動することにします:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./test_sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> &amp;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pid:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 9711</span></span></code></pre></div><p>テストプログラムができたので、そのプログラムに対してhashscanを実行してみましょう。:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>./hashscan 9711</span></span>
<span class="line"><span>Address            ideal    items  buckets mc fl bloom/sat fcn keys saved to</span></span>
<span class="line"><span>------------------ ----- -------- -------- -- -- --------- --- -------------</span></span>
<span class="line"><span>0x862e038            81%    10000     4096 11 ok 16    14% JEN</span></span></code></pre></div><p>もし、keystatsを使った外部分析のために、すべてのキーをコピーしたい場合は、-kフラグを追加します。:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>./hashscan -k 9711</span></span>
<span class="line"><span>Address            ideal    items  buckets mc fl bloom/sat fcn keys saved to</span></span>
<span class="line"><span>------------------ ----- -------- -------- -- -- --------- --- -------------</span></span>
<span class="line"><span>0x862e038            81%    10000     4096 11 ok 16    14% JEN /tmp/9711-0.key</span></span></code></pre></div><p>ここで、./keystats /tmp/9711-0.keyを実行して、この鍵のセットでどのハッシュ関数が最も良い特性を持つかを分析することができます。</p><h4 id="hashscan-column-reference" tabindex="-1">hashscan column reference <a class="header-anchor" href="#hashscan-column-reference" aria-label="Permalink to &quot;hashscan column reference&quot;">​</a></h4><table tabindex="0"><thead><tr><th>name</th><th>description</th></tr></thead><tbody><tr><td>Address</td><td>ハッシュテーブルの仮想アドレス</td></tr><tr><td>ideal</td><td>理想的なステップ数で調べることができるテーブルの項目の割合です。keystatsのセクションの<code>[ideal]</code>を参照。</td></tr><tr><td>items</td><td>ハッシュテーブルの項目数</td></tr><tr><td>buckets</td><td>ハッシュテーブルのバケット数</td></tr><tr><td>mc</td><td>ハッシュテーブルの最大連鎖長（uthashは通常、各バケツに10個以下のアイテムを保持しようとします。）</td></tr><tr><td>fl</td><td>フラグ（OK、または拡張禁止フラグが設定されている場合はNXのいずれか）</td></tr><tr><td>bloom/sat</td><td>ハッシュテーブルがブルームフィルタを使用している場合、これはフィルタのサイズ（2の累乗）です（例えば、16はフィルタのサイズが2^16ビットであることを意味します）。2つ目の数値は、ビットの「飽和度」をパーセントで表したものです。パーセンテージが低いほど、キャッシュミスを素早く特定するための潜在的なメリットが高くなります。</td></tr><tr><td>fcn</td><td>ハッシュ関数のシンボル名</td></tr><tr><td>keys saved to</td><td>キーが保存されたファイル（もしあれば</td></tr></tbody></table><div class="info custom-block"><p class="custom-block-title">INFO</p><p>ハッシュスキャンの仕組み</p><p>hashscanが実行されると、ターゲットプロセスにアタッチされ、ターゲットプロセスを一時的にサスペンドします。この短いサスペンド中に、ターゲットの仮想メモリをスキャンしてuthashハッシュテーブルのシグネチャを探します。そして、その署名に有効なハッシュテーブル構造が付随しているかどうかをチェックし、見つけたものを報告する。デタッチすると、ターゲットのプロセスは通常通り実行を再開する。hashscanは &quot;read-only &quot;で実行され、ターゲット・プロセスは変更されない。hashscanは実行中のプロセスの瞬間的なスナップショットを解析しているため、実行ごとに異なる結果を返すことがあります。</p></div><h3 id="拡張インターナル" tabindex="-1">拡張インターナル <a class="header-anchor" href="#拡張インターナル" aria-label="Permalink to &quot;拡張インターナル&quot;">​</a></h3><p>内部的には、このハッシュはバケットの数を管理し、十分な数のバケットを持つことで、各バケットには少数のアイテムしか含まれないようにすることを目標としています。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>なぜバケット数が重要なのか？</p><p>キーで項目を検索する場合、このハッシュは該当するバケツ内の項目を直線的にスキャンする。線形スキャンを一定時間で実行するためには、各バケツに含まれるアイテムの数を制限する必要があります。これは、必要に応じてバケットの数を増やすことで達成される。</p></div><h4 id="通常の拡大" tabindex="-1">通常の拡大 <a class="header-anchor" href="#通常の拡大" aria-label="Permalink to &quot;通常の拡大&quot;">​</a></h4><p>このハッシュは、各バケツに10個未満のアイテムを保持することを試みる。バケツがこの数を超えるようなアイテムが追加されると、ハッシュのバケツの数は2倍になり、アイテムは新しいバケツに再分配されます。理想的には、各バケツには以前の半分の数のアイテムが入ることになります。</p><p>バケット拡張は、必要に応じて自動的かつ不可視で行われます。アプリケーション側でそのタイミングを把握する必要はありません。</p><h4 id="バケットごとの拡張閾値" tabindex="-1">バケットごとの拡張閾値 <a class="header-anchor" href="#バケットごとの拡張閾値" aria-label="Permalink to &quot;バケットごとの拡張閾値&quot;">​</a></h4><p>通常、すべてのバケットは同じ閾値（10アイテム）を共有し、その時点でバケット拡張が開始されます。uthashはバケット拡張の過程で、特定のバケットが過剰に使用されていると判断した場合、この拡張トリガー閾値をバケットごとに調整することができます。</p><p>この閾値を調整すると、10から10の倍数になります（そのバケツの場合）。この倍数は、実際の鎖の長さが理想的な長さの何倍であるかに基づいています。これは、ハッシュ関数がいくつかのバケットを過剰に使用しているが、全体の分布は良好である場合に、過剰なバケットの拡張を抑えるための実用的な措置である。しかし、全体的な分布が悪くなりすぎると、uthashは戦術を変更します。</p><h4 id="拡大抑制" tabindex="-1">拡大抑制 <a class="header-anchor" href="#拡大抑制" aria-label="Permalink to &quot;拡大抑制&quot;">​</a></h4><p>特に、開発中にkeystatsユーティリティを使用して、鍵のハッシュを適切に選択した場合は、通常、このことについて知る必要も心配する必要もありません。</p><p>ハッシュ関数によって、バケツ内のアイテムの分布が不均一になることがあります。適度な量であれば問題ありません。鎖の長さが長くなるにつれて、通常のバケツ拡張が行われる。しかし、著しい不均衡が生じた場合（ハッシュ関数がキードメインに適していないため）、バケット拡張は連鎖長を減らすのに効果的でない場合があります。</p><p>バケツの数を何倍にしても、バケツ0の鎖の長さは変わりません。このような状況では、拡張を止め、O(n)のルックアップ性能を受け入れるのが最良の行動です。uthashはこれを実践しています。ハッシュ関数がキーに適していない場合、uthashは優雅に劣化する。</p><p>2回連続してバケット拡張を行った結果、ideal%値が50%を下回った場合、uthashはそのハッシュテーブルの拡張を禁止する。一度設定されたバケット拡張禁止フラグは、ハッシュにアイテムがある限り有効である。拡張が禁止されると、HASH_FINDの性能が一定時間より悪くなることがあります。</p><h4 id="diagnostic-hooks" tabindex="-1">Diagnostic hooks <a class="header-anchor" href="#diagnostic-hooks" aria-label="Permalink to &quot;Diagnostic hooks&quot;">​</a></h4><p>uthashがバケットを拡張したり、バケット拡張禁止フラグを設定した場合に実行される2つの「通知」フックがあります。これらのイベントに対して、アプリケーションがこれらのフックを設定したり、アクションを起こしたりする必要はありません。主に診断のために使用されます。通常、これらのフックは両方とも未定義であるため、コンパイルしても何も起こりません。</p><p>uthash_expand_fyiフックを定義することで、uthashがバケット拡張を行うたびにコードを実行することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_expand_fyi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_expand_fyi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;expanded to </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> buckets</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tbl-&gt;num_buckets)</span></span></code></pre></div><p>uthash_noexpand_fyi フックを定義することで、uthash がバケツ拡張禁止フラグを立てるたびにコードを実行することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_noexpand_fyi</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_noexpand_fyi</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tbl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;warning: bucket expansion inhibited</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><h3 id="フック類" tabindex="-1">フック類 <a class="header-anchor" href="#フック類" aria-label="Permalink to &quot;フック類&quot;">​</a></h3><p>これらのフックは、uthashの動作を変更したい場合にのみ使用することができます。フックは、プラットフォームによっては利用できない標準ライブラリ関数を置き換えたり、uthashのメモリ割り当て方法を変更したり、特定の内部イベントに応答してコードを実行したりするために使用できます。</p><p>uthash.h ヘッダは、これらのフックがすでに定義されていない限り、デフォルトの値で定義します。uthash.hをインクルードした後に#undefして再定義するか、インクルード前に定義するのが安全です。</p><p>メモリ管理機能の代替を指定する</p><p>デフォルトでは、uthashはメモリを管理するためにmallocとfreeを使用します。アプリケーションが独自のアロケータを使用している場合、uthashはそれらも使用することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;uthash.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* undefine the defaults */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_malloc</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_free</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">/* 再定義、代替機能の指定 */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">my_malloc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(sz)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ptr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">my_free</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ptr)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span></code></pre></div><p>uthash_freeは2つのパラメータを受け取ることに注意してください。szパラメータは、独自のメモリを管理する組み込みプラットフォームでの便宜を図るためのものです。</p><h4 id="標準ライブラリ関数の代替を指定する" tabindex="-1">標準ライブラリ関数の代替を指定する <a class="header-anchor" href="#標準ライブラリ関数の代替を指定する" aria-label="Permalink to &quot;標準ライブラリ関数の代替を指定する&quot;">​</a></h4><p>Uthashは、strlen（HASH_FIND_STR便利マクロなどで使用）、memset（メモリゼロにのみ使用）も使用します。これらの関数が提供されていないプラットフォームでは、独自の実装で代用することができます。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_bzero</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_bzero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">a</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">my_bzero</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a, len)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_strlen</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">my_strlen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(s)</span></span></code></pre></div><h4 id="メモリ不足" tabindex="-1">メモリ不足 <a class="header-anchor" href="#メモリ不足" aria-label="Permalink to &quot;メモリ不足&quot;">​</a></h4><p>メモリ確保に失敗した場合 (すなわち uthash_malloc 関数が NULL を返した場合)、 デフォルトの動作は exit(-1) を呼び出してプロセスを終了させることです。これは、uthash_fatalマクロを再定義することで変更可能です。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_fatal</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_fatal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">my_fatal_function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg)</span></span></code></pre></div><p>fatal関数は、プロセスを終了させるか、longjmpで安全な場所に戻る必要があります。割り当てに失敗すると、回復できない割り当てられたメモリが残る可能性があることに注意してください。uthash_fatalの後、ハッシュテーブルオブジェクトは使用不可能とみなされるべきです。この状態にあるとき、ハッシュテーブル上でHASH_CLEARを実行することさえ安全ではないかもしれません。</p><p>メモリが確保できない場合に「失敗を返す」ようにするには、uthash.hヘッダーファイルをインクルードする前にマクロHASH_NONFATAL_OOMを定義してください。この場合、uthash_fatalは使われず、割り当てに失敗するたびにuthash_nonfatal_oom(elt)が1回だけ呼び出されます。uthash_nonfatal_oomのデフォルトの動作は、no-opである。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#undef</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_nonfatal_oom</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#define</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> uthash_nonfatal_oom</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">elt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">perhaps_recover</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">element_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) elt)</span></span></code></pre></div><p>uthash_nonfatal_oom を呼び出す前に、ハッシュテーブルは問題のある挿入が行われる前の状態にロールバックされます。uthash_nonfatal_oomハンドラからthrowまたはlongjmpするのは安全です。</p><p>ただし、HASH_SELECTからuthash_nonfatal_oomが呼び出された場合は、void*型になるので、使用前にキャストする必要があります。いずれの場合も、elt-&gt;hh.tblはNULLになります。</p><p>アロケーションの失敗は、ハッシュテーブルに要素を追加するとき（ADD、REPLACE、SELECT操作を含む）にのみ可能です。uthash_freeは失敗が許されません。</p><h3 id="デバッグモード" tabindex="-1">デバッグモード <a class="header-anchor" href="#デバッグモード" aria-label="Permalink to &quot;デバッグモード&quot;">​</a></h3><p>このハッシュを使用するプログラムが -DHASH_DEBUG=1 でコンパイルされた場合、特別な内部整合性チェックモードが有効になります。このモードでは、ハッシュ全体の整合性が、追加または削除の操作のたびにチェックされます。これはuthashソフトウェアのデバッグ用であり、実運用コードで使用するためのものではありません。</p><p>tests/ディレクトリで、make debugを実行すると、このモードですべてのテストが実行されます。</p><p>このモードでは、ハッシュデータ構造の内部エラーが発生すると、標準エラーにメッセージが出力され、プログラムが終了します。</p><p>UT_hash_handleデータ構造は、next、prev、hh_next、hh_prevフィールドを含む。前者の2つのフィールドは、「アプリケーション」の順序（つまり、挿入順序--アイテムが追加された順序）を決定します。後者の2つのフィールドは、「バケットチェーン」の順序を決定する。これらは、UT_hash_handleを二重にリンクされたリスト、すなわちバケツ・チェーンに結びつけます。</p><p>DHASH_DEBUG=1モードでのチェックです：</p><ul><li>ハッシュは、バケツ順とアプリケーション順の2回、全体を歩くことになります。</li><li>両方のウォークで遭遇したアイテムの合計数を、保存されている数と照合する。</li><li>バケツ順に歩く間に、各アイテムのhh_prevポインタは、最後に訪れたアイテムと等しいかどうか比較されます。</li><li>アプリケーションの順番に歩いている間、各アイテムの prev ポインタは、最後に訪れたアイテムと等しいかどうか比較されます。</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><p>マクロのデバッグ：</p><p>マクロの呼び出しが含まれる行のコンパイラ警告を解釈するのが難しい場合があります。uthashの場合、1つのマクロが数十行に展開されることがあります。この場合、マクロを展開してから再コンパイルするのが効果的です。そうすることで、警告メッセージはマクロ内の正確な行を参照することになります。</p><p>ここでは、マクロを展開してから再コンパイルする例を紹介します。これは、tests/サブディレクトリにあるtest1.cプログラムを使用しています。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>gcc -E -I../src test1.c &gt; /tmp/a.c</span></span>
<span class="line"><span>egrep -v &#39;^#&#39; /tmp/a.c &gt; /tmp/b.c</span></span>
<span class="line"><span>indent /tmp/b.c</span></span>
<span class="line"><span>gcc -o /tmp/b /tmp/b.c</span></span></code></pre></div><p>最後の行は、すべてのマクロを展開した元のプログラム（test1.c）をコンパイルしています。警告があった場合は、参照した行番号を /tmp/b.c で確認することができます。</p></div><h3 id="スレッドの安全性" tabindex="-1">スレッドの安全性 <a class="header-anchor" href="#スレッドの安全性" aria-label="Permalink to &quot;スレッドの安全性&quot;">​</a></h3><p>スレッド化されたプログラムでもuthashを使うことができます。ただし、ロックは自分で行う必要があります。同時書き込みから保護するために、読み書きロックを使用します。読者が同時にいても大丈夫です（uthash 1.5以降）。</p><p>例えばpthreadsを使うと、次のようにrwlockを作成することができます：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">pthread_rwlock_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lock;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_rwlock_init</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NULL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fatal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;can&#39;t create rwlock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>そして、読者はHASH_FINDの呼び出しやハッシュ要素を反復処理する前に、リードロックを取得しなければなりません:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_rwlock_rdlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fatal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;can&#39;t get rdlock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_FIND_INT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(elts, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, e);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_rwlock_unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>ライターは、更新を行う前に排他的書き込みロックを取得する必要があります。追加、削除、ソートはすべてロックされなければならない更新である。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_rwlock_wrlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fatal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;can&#39;t get wrlock&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HASH_DEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(elts, e);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pthread_rwlock_unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>お好みで、読み書きロックの代わりにミューテックスを使用することもできますが、この場合、読者の並行性は一度に1スレッドに低下します。</p><p>uthashを読み書きロックで使用するサンプルプログラムがtests/threads/test1.cに含まれています。</p><h2 id="マクロリファレンス" tabindex="-1">マクロリファレンス <a class="header-anchor" href="#マクロリファレンス" aria-label="Permalink to &quot;マクロリファレンス&quot;">​</a></h2><h3 id="便利なマクロ" tabindex="-1">便利なマクロ <a class="header-anchor" href="#便利なマクロ" aria-label="Permalink to &quot;便利なマクロ&quot;">​</a></h3><p>便利なマクロは、一般化されたマクロと同じことをしますが、必要な引数は少なくなります。</p><p>便利なマクロを利用するために</p><p>構造体の UT_hash_handle フィールドは hh という名前でなければならない。</p><p>addまたはfindの場合、keyフィールドはint型または<code>char[]</code>型またはポインタでなければならない。</p><h4 id="表3-便利なマクロ" tabindex="-1">表3.便利なマクロ <a class="header-anchor" href="#表3-便利なマクロ" aria-label="Permalink to &quot;表3.便利なマクロ&quot;">​</a></h4><table tabindex="0"><thead><tr><th>macro</th><th>arguments</th></tr></thead><tbody><tr><td>HASH_ADD_INT</td><td>(head, keyfield_name, item_ptr)</td></tr><tr><td>HASH_REPLACE_INT</td><td>(head, keyfield_name, item_ptr, replaced_item_ptr)</td></tr><tr><td>HASH_FIND_INT</td><td>(head, key_ptr, item_ptr)</td></tr><tr><td>HASH_ADD_STR</td><td>(head, keyfield_name, item_ptr)</td></tr><tr><td>HASH_REPLACE_STR</td><td>(head, keyfield_name, item_ptr, replaced_item_ptr)</td></tr><tr><td>HASH_FIND_STR</td><td>(head, key_ptr, item_ptr)</td></tr><tr><td>HASH_ADD_PTR</td><td>(head, keyfield_name, item_ptr)</td></tr><tr><td>HASH_REPLACE_PTR</td><td>(head, keyfield_name, item_ptr, replaced_item_ptr)</td></tr><tr><td>HASH_FIND_PTR</td><td>(head, key_ptr, item_ptr)</td></tr><tr><td>HASH_DEL</td><td>(head, item_ptr)</td></tr><tr><td>HASH_SORT</td><td>(head, cmp)</td></tr><tr><td>HASH_COUNT</td><td>(head)</td></tr></tbody></table><h3 id="一般的なマクロ" tabindex="-1">一般的なマクロ <a class="header-anchor" href="#一般的なマクロ" aria-label="Permalink to &quot;一般的なマクロ&quot;">​</a></h3><p>これらのマクロは、ハッシュのアイテムを追加、検索、削除、ソートします。UT_hash_handleの名前がhh以外であったり、キーのデータ型がintや<code>char[]</code>でない場合は、一般的なマクロを使用する必要があります。</p><h4 id="表4-一般的なマクロ" tabindex="-1">表4.一般的なマクロ <a class="header-anchor" href="#表4-一般的なマクロ" aria-label="Permalink to &quot;表4.一般的なマクロ&quot;">​</a></h4><table tabindex="0"><thead><tr><th>macro</th><th>arguments</th></tr></thead><tbody><tr><td>HASH_ADD</td><td>(hh_name, head, keyfield_name, key_len, item_ptr)</td></tr><tr><td>HASH_ADD_BYHASHVALUE</td><td>(hh_name, head, keyfield_name, key_len, hashv, item_ptr)</td></tr><tr><td>HASH_ADD_KEYPTR</td><td>(hh_name, head, key_ptr, key_len, item_ptr)</td></tr><tr><td>HASH_ADD_KEYPTR_BYHASHVALUE</td><td>(hh_name, head, key_ptr, key_len, hashv, item_ptr)</td></tr><tr><td>HASH_ADD_INORDER</td><td>(hh_name, head, keyfield_name, key_len, item_ptr, cmp)</td></tr><tr><td>HASH_ADD_BYHASHVALUE_INORDER</td><td>(hh_name, head, keyfield_name, key_len, hashv, item_ptr, cmp)</td></tr><tr><td>HASH_ADD_KEYPTR_INORDER</td><td>(hh_name, head, key_ptr, key_len, item_ptr, cmp)</td></tr><tr><td>HASH_ADD_KEYPTR_BYHASHVALUE_INORDER</td><td>(hh_name, head, key_ptr, key_len, hashv, item_ptr, cmp)</td></tr><tr><td>HASH_REPLACE</td><td>(hh_name, head, keyfield_name, key_len, item_ptr, replaced_item_ptr)</td></tr><tr><td>HASH_REPLACE_BYHASHVALUE</td><td>(hh_name, head, keyfield_name, key_len, hashv, item_ptr, replaced_item_ptr)</td></tr><tr><td>HASH_REPLACE_INORDER</td><td>(hh_name, head, keyfield_name, key_len, item_ptr, replaced_item_ptr, cmp)</td></tr><tr><td>HASH_REPLACE_BYHASHVALUE_INORDER</td><td>(hh_name, head, keyfield_name, key_len, hashv, item_ptr, replaced_item_ptr, cmp)</td></tr><tr><td>HASH_FIND</td><td>(hh_name, head, key_ptr, key_len, item_ptr)</td></tr><tr><td>HASH_FIND_BYHASHVALUE</td><td>(hh_name, head, key_ptr, key_len, hashv, item_ptr)</td></tr><tr><td>HASH_DELETE</td><td>(hh_name, head, item_ptr)</td></tr><tr><td>HASH_VALUE</td><td>(key_ptr, key_len, hashv)</td></tr><tr><td>HASH_SRT</td><td>(hh_name, head, cmp)</td></tr><tr><td>HASH_CNT</td><td>(hh_name, head)</td></tr><tr><td>HASH_CLEAR</td><td>(hh_name, head)</td></tr><tr><td>HASH_SELECT</td><td>(dst_hh_name, dst_head, src_hh_name, src_head, condition)</td></tr><tr><td>HASH_ITER</td><td>(hh_name, head, item_ptr, tmp_item_ptr)</td></tr><tr><td>HASH_OVERHEAD</td><td>(hh_name, head)</td></tr></tbody></table><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note</p><p>HASH_ADD_KEYPTR は、構造体がキーそのものではなく、キーへのポインタを含む場合に使用します。</p></div><p>HASH_VALUEと..._BYHASHVALUEマクロは、主に、異なるハッシュテーブルの異なる構造体が同一のキーを持つという特殊な場合のためのパフォーマンスメカニズムである。これにより、ハッシュ値を一度取得してから..._BYHASHVALUEマクロに渡すことができ、ハッシュ値の再計算にかかる費用を節約することができます。</p><h4 id="argument-descriptions" tabindex="-1">Argument descriptions <a class="header-anchor" href="#argument-descriptions" aria-label="Permalink to &quot;Argument descriptions&quot;">​</a></h4><table tabindex="0"><thead><tr><th>name</th><th>description</th></tr></thead><tbody><tr><td>hh_name</td><td>構造体の UT_hash_handle フィールドの名前です。従来はhhと呼ばれていた。</td></tr><tr><td>head</td><td>ハッシュの「頭」として機能する構造体ポインタ変数です。ハッシュに追加される最初の項目を最初に指すので、この名前が付けられました。</td></tr><tr><td>keyfield_name</td><td>構造体のキーフィールドの名前です。(複数フィールドのキーの場合、これはキーの最初のフィールドとなります)。マクロを初めて使う人は、フィールドの名前をパラメータとして渡すのが奇妙に思えるかもしれません。注釈を参照してください。</td></tr><tr><td>key_len</td><td>キーフィールドの長さをバイト数で指定します。例えば、整数キーの場合はsizeof(int)となり、文字列キーの場合はstrlen(key)となります。(マルチフィールドのキーについては、このメモを参照してください)。</td></tr><tr><td>key_ptr</td><td>HASH_FINDの場合、ハッシュ内で検索するキーへのポインタです（ポインタなので、ここに直接リテラルの値を渡すことはできません）。HASH_ADD_KEYPTRの場合、これは追加される項目のキーのアドレスです。</td></tr><tr><td>hashv</td><td>指定されたキーのハッシュ値。これは、..._BYHASHVALUEマクロの入力パラメータであり、HASH_VALUEの出力パラメータです。同じキーに対して繰り返し検索を行う場合、キャッシュされたハッシュ値を再利用することで、パフォーマンスを最適化することができます。</td></tr><tr><td>item_ptr</td><td>追加、削除、置換、検索される構造体へのポインタ、または反復中の現在のポインタです。これは、HASH_ADD、HASH_DELETE、HASH_REPLACEマクロの入力パラメータであり、HASH_FINDとHASH_ITERの出力パラメータである。(HASH_ITERを使用して反復処理を行う場合、tmp_item_ptrはitem_ptrと同じ型の別の変数で、内部的に使用されます)。</td></tr><tr><td>replaced_item_ptr</td><td>HASH_REPLACE マクロで使用される。これは、置換された項目を指すように設定される出力パラメータである（置換された項目がない場合、NULLに設定される）。</td></tr><tr><td>cmp</td><td>この関数は、2つの引数（比較する項目へのポインタ）を受け取り、最初の項目が2番目の項目の前、等しい、または後のいずれにソートすべきかを指定するintを返します（strcmpのような）。</td></tr><tr><td>condition</td><td>1つの引数(構造体へのvoidポインタ。適切な構造体タイプにキャストする必要がある)を受け取る関数またはマクロです。この関数またはマクロは、デスティネーションハッシュに追加するために構造体を「選択」する場合、0以外の値で評価される必要があります。</td></tr></tbody></table>`,345)]))}const y=i(t,[["render",l]]);export{g as __pageData,y as default};
